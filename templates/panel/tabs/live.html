{% block content %}

<style>
.watermark.leftwatermark { display:none !important; }
.watermark.rightwatermark, .branding { display:none !important; }
</style>

<div class="mz-card" style="padding:16px;">
  <div style="display:flex; justify-content:flex-end; gap:8px; align-items:center; margin-bottom:10px;">
    <button class="mzc-btn" id="mz-jitsi-fs" type="button">Pantalla completa</button>
  </div>

  <div id="mz-live-wait" style="margin-top:12px; display:none;">
    <div class="mzc-note">La clase aún no ha empezado. Espera a que el profesor inicie la sala.</div>
    <div class="mzc-note" style="margin-top:8px;">Actualizando automáticamente…</div>
  </div>

  <div id="mz-live-jitsi" style="margin-top:12px; display:none;">
    <div id="jitsi-root"
         style="width:100%; height: calc(100vh - 180px); min-height:520px; border-radius:14px; overflow:hidden;">
    </div>
  </div>
</div>

<script src="https://{{ jitsi_domain }}/external_api.js"></script>
<script>
(() => {
  const isTeacher = {{ is_teacher|yesno:"true,false" }};

  const statusUrl = "{% url 'panel:curso_live_status' curso.id %}";
  const pingUrl   = "{% url 'panel:curso_live_ping' curso.id %}";
  const closeUrl  = "{% url 'panel:curso_live_close' curso.id %}";

  const domain      = "{{ jitsi_domain|escapejs }}";
  const roomName    = "{{ jitsi_room|escapejs }}";
  const displayName = "{{ jitsi_display_name|escapejs }}";
  const jwtToken    = "{{ jitsi_jwt|default:''|escapejs }}";

  const waitBox  = document.getElementById('mz-live-wait');
  const jitsiBox = document.getElementById('mz-live-jitsi');
  const root     = document.getElementById('jitsi-root');

  function showWait(){  waitBox.style.display='block'; jitsiBox.style.display='none'; }
  function showJitsi(){ waitBox.style.display='none';  jitsiBox.style.display='block'; }

  function getCookie(name){
    const v = `; ${document.cookie}`;
    const parts = v.split(`; ${name}=`);
    return parts.length === 2 ? parts.pop().split(';').shift() : '';
  }

  async function post(url){
    return fetch(url, {
      method: "POST",
      credentials: "same-origin",
      headers: {
        "X-CSRFToken": getCookie('csrftoken'),
        "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8"
      },
      body: "1=1",
    });
  }

  async function getStatus(){
    const r = await fetch(statusUrl, { cache:"no-store", credentials:"include" });
    if (!r.ok) throw new Error("status " + r.status);
    return r.json();
  }

  // --- Jitsi + state
  let api = null;
  let pingTimer = null;
  let statusTimer = null;

  function stopStatusWatch(){
    if (statusTimer) clearInterval(statusTimer);
    statusTimer = null;
  }

  function startStatusWatch(){
    if (isTeacher) return;  // учителя не трогаем
    if (statusTimer) return;

    statusTimer = setInterval(async () => {
      try {
        const s = await getStatus();
        if (!s.open) {
          try { api?.executeCommand?.('hangup'); } catch(e){}
          try { api?.dispose?.(); } catch(e){}
          api = null;
          showWait();
          stopStatusWatch();
          pollOpen();
        }
      } catch(e) {}
    }, 3000);
  }

  function startHeartbeat(){
    if (!isTeacher || pingTimer) return;
    post(pingUrl).catch(()=>{});
    pingTimer = setInterval(() => post(pingUrl).catch(()=>{}), 15000);
  }

  function stopHeartbeat(forceClose=false){
    if (!isTeacher) return;
    if (pingTimer) clearInterval(pingTimer);
    pingTimer = null;
    if (forceClose) post(closeUrl).catch(()=>{});
  }

  // страховка: если вкладка закрылась/крашнулась
window.addEventListener('beforeunload', () => {});

  // --- Fullscreen button (iframe first)
  const fsBtn = document.getElementById('mz-jitsi-fs');

  function requestFs(el){
    const req = el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen;
    if (req) req.call(el);
  }

  fsBtn?.addEventListener('click', () => {
    const iframe = root?.querySelector('iframe');
    if (iframe) { requestFs(iframe); return; }
    if (root) { requestFs(root); return; }
  });

  function startJitsi(){
    if (api) return;
    showJitsi();

    api = new JitsiMeetExternalAPI(domain, {
      roomName,
      parentNode: root,
      width: '100%',
      height: '100%',
      lang: 'es',
      userInfo: { displayName },
      ...(jwtToken ? { jwt: jwtToken } : {}),
      configOverwrite: { disableDeepLinking:true, prejoinPageEnabled:true },
      interfaceConfigOverwrite: {
        SHOW_POWERED_BY:false,
        SHOW_JITSI_WATERMARK:false,
        SHOW_BRAND_WATERMARK:false
      }
    });

    // делаем iframe fullscreen-friendly
    setTimeout(() => {
      const iframe = root?.querySelector('iframe');
      if (iframe) {
        iframe.setAttribute('allowfullscreen', 'true');
        iframe.setAttribute('allow', 'camera; microphone; fullscreen; display-capture');
      }
    }, 0);

    setTimeout(() => api?.resize?.(), 300);

    // ученику нужен статус вотчер, учителю — нет
    startStatusWatch();

    // эфир "открыт" только когда учитель реально вошёл
    api.addEventListener('videoConferenceJoined', () => {
      if (isTeacher) startHeartbeat();
    });

    // когда учитель реально вышел — закрываем эфир
    api.addEventListener('videoConferenceLeft', () => {
      if (isTeacher) stopHeartbeat(true);
    });

    api.addEventListener('readyToClose', () => {
      stopStatusWatch();
      if (isTeacher) stopHeartbeat(true);

      try { api?.dispose?.(); } catch(e){}
      api = null;

      if (isTeacher) {
        // снова показать prejoin
        startJitsi();
      } else {
        showWait();
        pollOpen();
      }
    });
  }

  async function pollOpen(){
    showWait();
    for(;;){
      try{
        const s = await getStatus();
        if (s.open) { startJitsi(); return; }
      }catch(e){}
      await new Promise(r => setTimeout(r, 2000));
    }
  }

  // --- BOOT
  if (isTeacher){
    startJitsi();   // prejoin
  } else {
    pollOpen();     // ждать учителя
  }
})();
</script>
{% endblock %}