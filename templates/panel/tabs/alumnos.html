{# panel/tabs/alumnos.html #}
<input type="hidden" id="mz-csrf" value="{{ csrf_token }}">
<style>
/* ================================
   MEATZE ¬∑ TAB ALUMNOS (DOCENTES)
================================= */

#mz-alumnos-tab .mz-alu-head{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:10px;
  margin-bottom:10px;
}
#mz-alumnos-tab .mz-alu-title{
  margin:0;
  font-size:1rem;
  font-weight:600;
  letter-spacing:.04em;
  text-transform:uppercase;
}
#mz-alumnos-tab .mz-alu-sub{
  margin:2px 0 0;
  font-size:.82rem;
  opacity:.85;
}
#mz-alumnos-tab .mz-alu-badge{
  font-size:.76rem;
  padding:4px 9px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.7);
  background:rgba(15,23,42,.9);
  white-space:nowrap;
}

#mz-alumnos-tab .mz-alu-tablewrap{
  margin-top:8px;
  border-radius:12px;
  border:1px solid rgba(148,163,184,.45);
  overflow:auto;
  background:rgba(15,23,42,.85);
}

#mz-alumnos-tab .mz-tbl{
  width:100%;
  border-collapse:collapse;
  font-size:.86rem;
}
#mz-alumnos-tab .mz-tbl thead tr{
  background:rgba(15,23,42,.98);
}
#mz-alumnos-tab .mz-tbl th,
#mz-alumnos-tab .mz-tbl td{
  padding:6px 9px;
  text-align:left;
  border-bottom:1px solid rgba(30,64,175,.45);
}
#mz-alumnos-tab .mz-tbl th{
  font-size:.8rem;
  text-transform:uppercase;
  letter-spacing:.08em;
  opacity:.85;
}
#mz-alumnos-tab .mz-tbl tbody tr:nth-child(2n){
  background:rgba(15,23,42,.9);
}

/* ===== Buttons (glass) ===== */
#mz-alumnos-tab .mzc-btn{
  position:relative;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:6px;
  padding:6px 16px;
  font-size:.82rem;
  font-weight:500;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.7);
  cursor:pointer;
  user-select:none;
  text-decoration:none;
  background:radial-gradient(circle at top, rgba(56,189,248,.22), rgba(15,23,42,.96));
  color:#e5e7eb;
  transition:background 140ms ease, border-color 140ms ease, box-shadow 140ms ease, transform 90ms ease;
}
#mz-alumnos-tab .mzc-btn.ghost{
  background:radial-gradient(circle at top, rgba(15,23,42,.9), rgba(30,64,175,.85));
}
#mz-alumnos-tab .mzc-btn:hover{
  transform:translateY(-1px);
  box-shadow:0 8px 20px rgba(15,23,42,.9), 0 0 0 1px rgba(15,23,42,1);
  border-color:rgba(191,219,254,.9);
}
#mz-alumnos-tab .mzc-btn:active{
  transform:translateY(0);
  box-shadow:0 2px 8px rgba(15,23,42,.9);
}

/* ===== Tooltip progreso (fixed) ===== */
.mz-tip{
  position:fixed;
  z-index:99999;
  width:min(360px, 92vw);
  max-height:min(320px, 70vh);
  overflow:auto;
  padding:12px 12px 10px;
  border-radius:14px;
  border:1px solid rgba(191,219,254,.45);
  background:#0b1220;
  color:#e5e7eb;
  box-shadow:0 18px 45px rgba(0,0,0,.55);
}
.mz-tip h5{
  margin:0 0 6px;
  font-size:.78rem;
  letter-spacing:.08em;
  text-transform:uppercase;
  opacity:.92;
}
.mz-tip ul{
  margin:0 0 10px;
  padding-left:16px;
  font-size:.82rem;
  color:#e5e7eb;
}
.mz-tip li{ margin:4px 0; }
.mz-tip .muted{ color:#9ca3af; font-size:.8rem; }

/* ===== Presencia ===== */
#mz-alumnos-tab .mz-prog-row{ display:flex; flex-direction:column; gap:8px; }
#mz-alumnos-tab .mz-prog-chips{ display:flex; gap:6px; align-items:center; flex-wrap:wrap; }

#mz-alumnos-tab .mz-pres-row{
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
}
#mz-alumnos-tab .mz-pres-chip{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:4px 10px;
  border-radius:999px;
  font-size:.78rem;
  font-weight:700;
  letter-spacing:.02em;
  border:1px solid rgba(148,163,184,.55);
  background:#0b1220;
  color:#e5e7eb;
}
#mz-alumnos-tab .mz-pres-none{ opacity:.6; }
#mz-alumnos-tab .mz-pres-confirmed{ border-color:rgba(52,211,153,.55); color:#6ee7b7; }
#mz-alumnos-tab .mz-pres-pending{ border-color:rgba(251,191,36,.55); color:#fde68a; }
#mz-alumnos-tab .mz-pres-offsite{ border-color:rgba(248,113,113,.55); color:#fecaca; }
#mz-alumnos-tab .mz-pres-ended{ border-color:rgba(148,163,184,.4); color:#cbd5e1; opacity:.9; }
#mz-alumnos-tab .mz-pres-actions{ display:inline-flex; gap:6px; align-items:center; }
#mz-alumnos-tab .mz-pres-actions .mzc-btn{ padding:4px 10px; font-size:.78rem; }

/* ===== Compact layout (tabla alumnos) ===== */
#mz-alumnos-tab .mz-alu-tbl{
  table-layout:fixed;
  width:100%;
}
#mz-alumnos-tab .mz-alu-tbl th,
#mz-alumnos-tab .mz-alu-tbl td{
  box-sizing:border-box;
}

/* col widths */
#mz-alumnos-tab .mz-alu-tbl .c-idx{ width:40px; }
#mz-alumnos-tab .mz-alu-tbl .c-student{ width:44%; }
#mz-alumnos-tab .mz-alu-tbl .c-prog{ width:36%; }
#mz-alumnos-tab .mz-alu-tbl .c-act{ width:108px; }

#mz-alumnos-tab .th-idx,
#mz-alumnos-tab .td-idx{ width:40px; text-align:center; opacity:.85; }
#mz-alumnos-tab .th-act{ text-align:center; }
#mz-alumnos-tab .td-student,
#mz-alumnos-tab .td-prog,
#mz-alumnos-tab .td-act{ vertical-align:middle; }

/* headers: no se pisan */
#mz-alumnos-tab .mz-alu-tbl th{
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* alumno: nombre + email */
#mz-alumnos-tab .mz-stu{ display:flex; flex-direction:column; gap:4px; min-width:0; }
#mz-alumnos-tab .mz-stu-name{ font-weight:800; color:#f9fafb; line-height:1.15; }
#mz-alumnos-tab .mz-stu-mail{
  font-size:.78rem;
  color:#9ca3af;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  max-width:100%;
}

/* chips */
#mz-alumnos-tab .mz-chip-mini{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:4px 8px;
  border-radius:999px;
  font-size:.78rem;
  font-weight:800;
  border:1px solid rgba(148,163,184,.45);
  background:#0b1220;
  color:#e5e7eb;
  white-space:nowrap;
}

/* icon buttons (acciones) */
#mz-alumnos-tab .mz-act{
  display:flex;
  gap:8px;
  justify-content:center;
  align-items:center;
}
#mz-alumnos-tab .mz-icbtn{
  width:36px;
  height:36px;
  border-radius:12px;
  border:1px solid rgba(148,163,184,.55);
  background:radial-gradient(circle at top, rgba(56,189,248,.18), rgba(15,23,42,.96));
  color:#e5e7eb;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:0;
  line-height:1;
  font-size:16px;
  transition:transform 120ms ease, box-shadow 140ms ease, border-color 140ms ease;
}
#mz-alumnos-tab .mz-icbtn:hover{
  transform:translateY(-1px);
  border-color:rgba(191,219,254,.9);
  box-shadow:0 10px 24px rgba(15,23,42,.85);
}
#mz-alumnos-tab .mz-icbtn:active{ transform:translateY(0); }
#mz-alumnos-tab .mz-icbtn.danger{ border-color:rgba(248,113,113,.45); }

/* password inline */
#mz-alumnos-tab .mz-stu-pass{
  margin-top:4px;
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 8px;
  border-radius:12px;
  border:1px dashed rgba(148,163,184,.55);
  background:rgba(11,18,32,.55);
  flex-wrap:wrap;
}
#mz-alumnos-tab .mz-stu-pass .lbl{ font-size:.74rem; color:#9ca3af; }
#mz-alumnos-tab .mz-stu-pass code{ font-size:.9rem; }

/* ===== Mobile tweaks: acciones vertical, no horizontal scroll ===== */
@media (max-width: 820px){
  #mz-alumnos-tab .mz-alu-tablewrap{
    overflow-x:hidden;
    overflow-y:auto;
  }

  #mz-alumnos-tab .mz-tbl th,
  #mz-alumnos-tab .mz-tbl td{ padding:8px 6px; }

  #mz-alumnos-tab .mz-alu-tbl th{
    font-size:.72rem;
    letter-spacing:.04em;
    padding:6px 6px;
  }

  /* tighter columns */
  #mz-alumnos-tab .mz-alu-tbl .c-student{ width:52%; }
  #mz-alumnos-tab .mz-alu-tbl .c-prog{ width:34%; }
  #mz-alumnos-tab .mz-alu-tbl .c-act{ width:64px; }

  /* acciones one above another */
  #mz-alumnos-tab .mz-act{
    flex-direction:column;
    gap:6px;
  }
  #mz-alumnos-tab .mz-icbtn{
    width:32px;
    height:32px;
    font-size:15px;
  }
  #mz-alumnos-tab .mz-chip-mini{
    font-size:.74rem;
    padding:4px 7px;
  }
}

/* ================================
   ACCESOS TEMPORALES
================================= */
#mz-alumnos-tab #mz-temp-root{ margin-top:14px; }

#mz-alumnos-tab .mz-temp-bar{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  align-items:center;
  margin:6px 0;
}
#mz-alumnos-tab .mz-temp-bar label,
#mz-alumnos-tab .mz-temp-bar span{
  font-size:.8rem;
  opacity:.9;
}
#mz-alumnos-tab .mz-temp-input{ max-width:120px; }
#mz-alumnos-tab .mz-temp-select{ max-width:200px; }
#mz-alumnos-tab .mz-temp-present-wrap{
  display:flex;
  justify-content:flex-end;
  padding:6px 6px 0;
}

/* temp: table wrapper (only here!) */
#mz-alumnos-tab #mz-temp-table .mz-temp-tablewrap{
  margin-top:10px;
  border-radius:12px;
  border:1px solid rgba(148,163,184,.45);
  overflow:auto;
  background:rgba(15,23,42,.85);
}

/* SMALL: table full width, no forced min-width (prevents ‚Äúphantom‚Äù scroll) */
@media (max-width: 1023px){
  #mz-alumnos-tab #mz-temp-table table.mz-tbl{
    width:100%;
    table-layout:auto;
  }
  /* allow first column to wrap if needed */
  #mz-alumnos-tab #mz-temp-table table.mz-tbl td:first-child,
  #mz-alumnos-tab #mz-temp-table table.mz-tbl th:first-child{
    white-space:normal;
  }
  /* keep key code readable */
  #mz-alumnos-tab #mz-temp-table table.mz-tbl code{
    white-space:nowrap;
  }
}

/* Desktop: cards for temp (–µ—Å–ª–∏ —Ç—ã —Ä–µ–Ω–¥–µ—Ä–∏—à—å .mz-temp-cards) */
#mz-alumnos-tab #mz-temp-table .mz-temp-cards{ display:none; }

@media (min-width: 1024px){
  #mz-alumnos-tab #mz-temp-table .mz-temp-tablewrap{ display:none; }

  #mz-alumnos-tab #mz-temp-table .mz-temp-cards{
    display:grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap:12px;
    padding:10px;
  }
  @media (min-width: 1360px){
    #mz-alumnos-tab #mz-temp-table .mz-temp-cards{
      grid-template-columns: repeat(4, minmax(0, 1fr));
    }
  }
  #mz-alumnos-tab #mz-temp-table .mz-temp-card{
    border-radius:18px;
    border:1px solid rgba(148,163,184,.40);
    background:radial-gradient(circle at top, rgba(15,23,42,.92), rgba(15,23,42,.84));
    box-shadow:0 14px 32px rgba(15,23,42,.75);
    padding:12px;
    display:flex;
    flex-direction:column;
    gap:10px;
    min-width:0;
  }
  #mz-alumnos-tab #mz-temp-table .mz-temp-user{
    font-weight:900;
    font-size:1rem;
    color:#f9fafb;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  #mz-alumnos-tab #mz-temp-table .mz-temp-key{
    font-family:ui-monospace, Menlo, Consolas, monospace;
    font-weight:900;
    font-size:1.6rem;
    letter-spacing:.06em;
    color:#e5e7eb;
  }
  #mz-alumnos-tab #mz-temp-table .mz-temp-actions{
    display:flex;
    justify-content:flex-end;
    gap:8px;
  }
  #mz-alumnos-tab #mz-temp-table .mz-temp-icbtn{
    width:34px;
    height:34px;
    border-radius:12px;
    border:1px solid rgba(148,163,184,.55);
    background:radial-gradient(circle at top, rgba(56,189,248,.18), rgba(15,23,42,.96));
    color:#e5e7eb;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:0;
    line-height:1;
  }
}

/* ===== Head responsive ===== */
@media (max-width: 780px){
  #mz-alumnos-tab .mz-alu-head{
    flex-direction:column;
    align-items:flex-start;
    gap:4px;
  }
}

/* ================================
   ALUMNOS: table (m√≥vil) + cards (desktop)
================================= */

/* cards container */
#mz-alumnos-tab .mz-alu-cards{ display:none; }

@media (min-width: 1024px){
  /* –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ –ø—Ä—è—á–µ–º —Ç–∞–±–ª–∏—Ü—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ */
  #mz-alumnos-tab .mz-alu-tablewrap{ display:none; }
  #mz-alumnos-tab .mz-alu-cards{
    display:flex;
    flex-direction:column;
    gap:12px;
    margin-top:10px;
  }
}

/* single alumno card */
#mz-alumnos-tab .mz-alu-card{
  border-radius:18px;
  border:1px solid rgba(148,163,184,.40);
  background: radial-gradient(circle at top, rgba(15,23,42,.92), rgba(15,23,42,.84));
  box-shadow:0 14px 32px rgba(15,23,42,.65);
  padding:12px 12px 10px;
  position:relative;
  min-width:0;
}

/* top row: name + email */
#mz-alumnos-tab .mz-alu-card-head{
  display:flex;
  flex-direction:column;
  gap:4px;
  min-width:0;
}
#mz-alumnos-tab .mz-alu-card-name{
  font-weight:900;
  font-size:1.02rem;
  color:#f9fafb;
  line-height:1.15;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
#mz-alumnos-tab .mz-alu-card-mail{
  font-size:.82rem;
  color:#9ca3af;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

/* second row: progreso */
#mz-alumnos-tab .mz-alu-card-prog{
  margin-top:10px;
  display:flex;
  flex-direction:column;
  gap:8px;
}

/* bottom-right actions */
#mz-alumnos-tab .mz-alu-card-actions{
  position:absolute;
  right:10px;
  bottom:10px;
  display:flex;
  gap:8px;
  align-items:center;
}

/* make sure chips don't collide with actions */
#mz-alumnos-tab .mz-alu-card{
  padding-bottom:52px; /* –º–µ—Å—Ç–æ –ø–æ–¥ –∫–Ω–æ–ø–∫–∏ –≤–Ω–∏–∑—É —Å–ø—Ä–∞–≤–∞ */
}
/* ===== DESKTOP: cards en grid (3 por fila) ===== */
#mz-alumnos-tab .mz-alu-cards{ display:none; }

@media (min-width: 1024px){
  #mz-alumnos-tab .mz-alu-tablewrap{ display:none; }

  #mz-alumnos-tab .mz-alu-cards{
    display:grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap:12px;
    margin-top:10px;
  }
}

/* –∞–¥–∞–ø—Ç–∏–≤: 2 –≤ —Ä—è–¥ –Ω–∞ —Å—Ä–µ–¥–Ω–∏—Ö */
@media (min-width: 1024px) and (max-width: 1250px){
  #mz-alumnos-tab .mz-alu-cards{
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
}

/* 4 –≤ —Ä—è–¥ –Ω–∞ –æ—á–µ–Ω—å —à–∏—Ä–æ–∫–∏—Ö (–ø–æ –∂–µ–ª–∞–Ω–∏—é) */
@media (min-width: 1500px){
  #mz-alumnos-tab .mz-alu-cards{
    grid-template-columns: repeat(4, minmax(0, 1fr));
  }
}
/* ===== Student modules dropdown ===== */
.mz-mod-dd{
  position:fixed;
  z-index:99998;
  width:min(420px, 92vw);
  border-radius:16px;
  border:1px solid rgba(148,163,184,.45);
  background:#0b1220;
  box-shadow:0 22px 55px rgba(0,0,0,.55);
  color:#e5e7eb;
  padding:12px;
  display:none;
}
.mz-mod-dd .head{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  margin-bottom:10px;
}
.mz-mod-dd .ttl{
  font-weight:900;
  font-size:.92rem;
  line-height:1.2;
}
.mz-mod-dd .sub{
  font-size:.78rem;
  color:#9ca3af;
  margin-top:2px;
}
.mz-mod-dd .close{
  width:34px;height:34px;
  border-radius:12px;
  border:1px solid rgba(148,163,184,.55);
  background:rgba(15,23,42,.9);
  color:#e5e7eb;
  cursor:pointer;
}
.mz-mod-dd .list{
  display:flex;
  flex-direction:column;
  gap:8px;
  max-height:min(340px, 60vh);
  overflow:auto;
  padding:4px;
}
.mz-mod-dd .row{
  display:flex;
  align-items:center;
  gap:10px;
  padding:8px 10px;
  border-radius:12px;
  border:1px solid rgba(148,163,184,.25);
  background:rgba(15,23,42,.75);
}
.mz-mod-dd .row:hover{
  border-color:rgba(191,219,254,.55);
}
.mz-mod-dd input[type="checkbox"]{
  width:18px;height:18px;
}
.mz-mod-dd .lbl{
  min-width:0;
  display:flex;
  flex-direction:column;
  gap:2px;
}
.mz-mod-dd .lbl b{
  font-size:.86rem;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.mz-mod-dd .lbl span{
  font-size:.74rem;
  color:#9ca3af;
}
.mz-mod-dd .foot{
  display:flex;
  gap:8px;
  justify-content:flex-end;
  margin-top:10px;
}
.mz-mod-dd .status{
  margin-right:auto;
  font-size:.78rem;
  color:#9ca3af;
  align-self:center;
}
.mz-mod-dd .btn{
  padding:6px 12px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.55);
  background:rgba(15,23,42,.9);
  color:#e5e7eb;
  cursor:pointer;
}
.mz-mod-dd .btn:hover{
  border-color:rgba(191,219,254,.9);
}
</style>

<div id="mz-alumnos-tab" data-focus="alumnos_tab">

{% if not is_teacher %}
  <div class="mzc-card">
    <h4 class="mzc-h2">Alumnos</h4>
    <div class="mzc-note">Esta secci√≥n solo est√° disponible para el equipo docente.</div>
  </div>
{% else %}

  {# ==== LISTA DE ALUMNOS ==== #}
  <div class="mzc-card">
    <div class="mz-alu-head">
      <div>
        <h4 class="mz-alu-title">Alumnos inscritos</h4>
        <p class="mz-alu-sub">
          Gesti√≥n de acceso al campus para este curso.
        </p>
      </div>
      <div class="mz-alu-badge">
        {% if students %}
          {{ students|length }} alumno{{ students|length|pluralize:"s" }}
        {% else %}
          0 alumnos
        {% endif %}
      </div>
    </div>

    <div class="mz-alu-tablewrap" data-focus="attendance">
        <table class="mz-tbl mz-alu-tbl">
<colgroup>
  <col class="c-idx" />
  <col class="c-student" />
  <col class="c-prog" />
  <col class="c-act" />
</colgroup>

<thead>
  <tr>
    <th class="th-idx">#</th>
    <th>Alumno</th>
    <th>Progreso</th>
    <th class="th-act">Acciones</th>
  </tr>
</thead>
        <tbody>
          {% if students %}
            {% for s in students %}
				<tr>
				  <td class="td-idx">{{ s.idx }}</td>

				  <td class="td-student">
					<div class="mz-stu">
					  <div class="mz-stu-name">{{ s.name }}</div>
					  <div class="mz-stu-mail" title="{{ s.email }}">{{ s.email }}</div>

					  {% if s.last_pass %}
						<div class="mz-stu-pass mz-inline-pass" data-pass="{{ s.last_pass }}">
						  <span class="lbl">Nueva clave:</span>
						  <code>{{ s.last_pass }}</code>

						  <button type="button"
								  class="mz-icbtn mz-pass-copy"
								  title="Copiar clave"
								  aria-label="Copiar clave"
								  data-action="alumno.password.copy"
								  data-alumno-id="{{ s.id }}">
							üìã
						  </button>

						  <button type="button"
								  class="mz-icbtn mz-pass-hide"
								  title="Ocultar"
								  aria-label="Ocultar">
							‚úï
						  </button>
						</div>
					  {% endif %}
					</div>
				  </td>

				  <td class="td-prog" data-role="progress" data-student-id="{{ s.id }}">
					<div class="mz-prog-row">
					  <div class="mz-prog-chips" data-focus="physical">
						<span class="mz-chip-mini" data-p-dl="{{ s.id }}" title="Descargas">üì• {{ s.downloaded_files }}/{{ s.total_files }}</span>
						<span class="mz-chip-mini" data-p-rc="{{ s.id }}" title="Material f√≠sico">üì¶ {{ s.receipts_count }}</span>

						<span class="mz-chip-mini" data-p-grade="{{ s.id }}" title="Calificaciones">
						  üéì
						  {% if s.avg_grade is not None %}
							{{ s.avg_grade }}{% if s.graded_tasks %} ({{ s.graded_tasks }}){% endif %}
						  {% else %}
							‚Äî
						  {% endif %}
						</span>
					  </div>

					  <div class="mz-pres-row" data-pres-row="{{ s.id }}">
						<span class="mz-pres-chip mz-pres-none" data-pres-chip="{{ s.id }}">‚Äî</span>
						<span class="mz-pres-actions" data-pres-actions="{{ s.id }}"></span>
					  </div>
					</div>
				  </td>

				  <td class="td-act">
					<div class="mz-act">
					  <form method="post" style="margin:0">
						{% csrf_token %}
						<input type="hidden" name="reset_id" value="{{ s.id }}">
						<button type="submit"
								class="mz-icbtn"
								title="Reiniciar clave"
								aria-label="Reiniciar clave"
								data-action="alumno.password.reset"
								data-alumno-id="{{ s.id }}">
						  üîë
						</button>
					  </form>
						<button type="button"
								class="mz-icbtn"
								title="M√≥dulos"
								aria-label="M√≥dulos"
								data-action="student.modules.open"
								data-alumno-id="{{ s.id }}"
								data-alumno-name="{{ s.name|escape }}">
						  üß©
						</button>
					  <form method="post" style="margin:0"
							onsubmit="return confirm('¬øEliminar a este alumno del curso?');">
						{% csrf_token %}
						<input type="hidden" name="remove_id" value="{{ s.id }}">
						<button type="submit"
								class="mz-icbtn danger"
								title="Eliminar del curso"
								aria-label="Eliminar del curso"
								data-action="alumno.remove"
								data-alumno-id="{{ s.id }}">
						  üóëÔ∏è
						</button>
					  </form>
					</div>
				  </td>
				</tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="5" class="mzc-note">
                A√∫n no hay alumnos inscritos en este curso.
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
	{# ===== DESKTOP: CARDS ===== #}
<div class="mz-alu-cards" data-view="cards">
  {% for s in students %}
    <div class="mz-alu-card">

      <div class="mz-alu-card-head">
        <div class="mz-alu-card-name" title="{{ s.name }}">{{ s.name }}</div>
        <div class="mz-alu-card-mail" title="{{ s.email }}">{{ s.email }}</div>

        {% if s.last_pass %}
          <div class="mz-stu-pass mz-inline-pass" data-pass="{{ s.last_pass }}">
            <span class="lbl">Nueva clave:</span>
            <code>{{ s.last_pass }}</code>

            <button type="button"
                    class="mz-icbtn mz-pass-copy"
                    title="Copiar clave"
                    aria-label="Copiar clave"
                    data-action="alumno.password.copy"
                    data-alumno-id="{{ s.id }}">üìã</button>

            <button type="button"
                    class="mz-icbtn mz-pass-hide"
                    title="Ocultar"
                    aria-label="Ocultar">‚úï</button>
          </div>
        {% endif %}
      </div>

      <div class="mz-alu-card-prog" data-role="progress" data-student-id="{{ s.id }}">
        <div class="mz-prog-chips" data-focus="physical">
          <span class="mz-chip-mini" data-p-dl="{{ s.id }}" title="Descargas">üì• {{ s.downloaded_files }}/{{ s.total_files }}</span>
          <span class="mz-chip-mini" data-p-rc="{{ s.id }}" title="Material f√≠sico">üì¶ {{ s.receipts_count }}</span>
          <span class="mz-chip-mini" data-p-grade="{{ s.id }}" title="Calificaciones">
            üéì
            {% if s.avg_grade is not None %}
              {{ s.avg_grade }}{% if s.graded_tasks %} ({{ s.graded_tasks }}){% endif %}
            {% else %}
              ‚Äî
            {% endif %}
          </span>
        </div>

        <div class="mz-pres-row" data-pres-row="{{ s.id }}">
          <span class="mz-pres-chip mz-pres-none" data-pres-chip="{{ s.id }}">‚Äî</span>
          <span class="mz-pres-actions" data-pres-actions="{{ s.id }}"></span>
        </div>
      </div>

      <div class="mz-alu-card-actions">
        <form method="post" style="margin:0">
          {% csrf_token %}
          <input type="hidden" name="reset_id" value="{{ s.id }}">
          <button type="submit"
                  class="mz-icbtn"
                  title="Reiniciar clave"
                  aria-label="Reiniciar clave"
                  data-action="alumno.password.reset"
                  data-alumno-id="{{ s.id }}">üîë</button>
        </form>
<button type="button"
        class="mz-icbtn"
        title="M√≥dulos"
        aria-label="M√≥dulos"
        data-action="student.modules.open"
        data-alumno-id="{{ s.id }}"
        data-alumno-name="{{ s.name|escape }}">
  üß©
</button>
        <form method="post" style="margin:0"
              onsubmit="return confirm('¬øEliminar a este alumno del curso?');">
          {% csrf_token %}
          <input type="hidden" name="remove_id" value="{{ s.id }}">
          <button type="submit"
                  class="mz-icbtn danger"
                  title="Eliminar del curso"
                  aria-label="Eliminar del curso"
                  data-action="alumno.remove"
                  data-alumno-id="{{ s.id }}">üóëÔ∏è</button>
        </form>
      </div>

    </div>
  {% endfor %}
</div>
  </div>

  {# ==== ACCESOS TEMPORALES (—á–µ—Ä–µ–∑ V5 API, –∫–∞–∫ —Ä–∞–Ω—å—à–µ) ==== #}
  <div class="mzc-card" id="mz-temp-root"
       data-course-code="{{ curso.codigo }}">

    <div class="mz-alu-head">
      <div>
        <h4 class="mz-alu-title">Accesos temporales</h4>
        <p class="mz-alu-sub">
          C√≥digos para ex√°menes, pruebas o accesos de corta duraci√≥n.
        </p>
      </div>
    </div>

    <div class="mz-temp-bar" data-focus="add_students">
      <label class="mzc-note">Cantidad</label>
      <input id="mz-temp-count"
             class="mzc-inp mz-temp-input"
             type="number" min="1" max="100" step="1"
             value="10">
      <button id="mz-temp-gen" class="mzc-btn" type="button">
        Generar
      </button>
      <button id="mz-temp-dl" class="mzc-btn ghost" type="button">
        Descargar CSV
      </button>
    </div>

    <div class="mz-temp-bar" data-focus="add_students">
      <span class="mzc-note">Rotar clave para:</span>
      <select id="mz-temp-sel"
              class="mzc-inp mz-temp-select"></select>
      <button id="mz-temp-rot" class="mzc-btn ghost" type="button">
        Rotar
      </button>
    </div>

    <div id="mz-temp-msg" class="mzc-note" style="margin-top:4px"></div>
    <div id="mz-temp-table"></div>
  </div>

  {# ==== JS: –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª—è + –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã ==== #}
  <script>
  // –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ "Nueva clave" –≤ –±—É—Ñ–µ—Ä
(function(){
  document.querySelectorAll('.mz-inline-pass').forEach(function(box){
    const btnCopy = box.querySelector('.mz-pass-copy');
    const btnHide = box.querySelector('.mz-pass-hide');
    const pass = box.dataset.pass || box.textContent;

    if (btnCopy && pass){
      btnCopy.addEventListener('click', async function(){
        try{
          await navigator.clipboard.writeText(pass.trim());
          const old = btnCopy.textContent;
          btnCopy.textContent = 'Copiado';
          setTimeout(function(){ btnCopy.textContent = old; }, 1200);
        }catch(e){}
      });
    }

    if (btnHide){
      btnHide.addEventListener('click', function(){
        box.remove(); // —Å–∫—Ä—ã—Ç—å –±–ª–æ–∫ –ø–∞—Ä–æ–ª—è
      });
    }
  });
})();

  // ==== ACCESOS TEMPORALES (V5 API) ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ –ª–æ–≥–∏–∫–µ ====
  (function(){
    const root = document.getElementById('mz-temp-root');
    if (!root) return;

    const courseCode = root.dataset.courseCode;
    const V5_API = '/meatze/v5';

    const $cnt = root.querySelector('#mz-temp-count');
    const $gen = root.querySelector('#mz-temp-gen');
    const $dl  = root.querySelector('#mz-temp-dl');
    const $sel = root.querySelector('#mz-temp-sel');
    const $rot = root.querySelector('#mz-temp-rot');
    const $msg = root.querySelector('#mz-temp-msg');
    const $tbl = root.querySelector('#mz-temp-table');

    async function api(url, opts){
      opts = opts || {};
      const init = {
        method: opts.method || 'GET',
        credentials: 'include',
        headers: opts.headers || {}
      };
      if (opts.body){
        if (opts.body instanceof FormData){
          init.body = opts.body;
        } else {
          init.body = JSON.stringify(opts.body);
          init.headers['Content-Type'] = 'application/json';
        }
      }
      const resp = await fetch(url, init);
      let data = null;
      try { data = await resp.json(); } catch(_){}
      if (!resp.ok){
        const msg = (data && data.message) || ('HTTP ' + resp.status);
        throw new Error(msg);
      }
      return data || {};
    }

    const cntKey = 'mz-temp-count::' + courseCode;
    $cnt.value = (localStorage.getItem(cntKey) || '').trim() || '10';
    $cnt.addEventListener('change', function(){
      localStorage.setItem(cntKey, ($cnt.value || '10').trim());
    });

    async function genTempAccounts(n){
      const fd = new FormData();
      fd.append('course_code', courseCode);
      fd.append('count', String(n));
      fd.append('mode', 'set');
      return await api(V5_API + '/teacher/temp/create', {
        method: 'POST',
        body: fd
      });
    }

    async function loadTempList(limit){
      limit = limit || 300;
      const u = new URL(V5_API + '/teacher/temp/list', window.location.origin);
      u.searchParams.set('course_code', courseCode);
      u.searchParams.set('limit', String(limit));
      const r = await api(u.toString());
      return (r.items || []).map(function(x){
        return { temp_name: x.temp_name, key: x.key };
      });
    }

    async function rotateKey(tempName){
      return await api(V5_API + '/teacher/temp/rotate', {
        method: 'POST',
        body: { course_code: courseCode, temp_name: tempName }
      });
    }

function renderTempTable(list){
  if (!list.length){
    $tbl.innerHTML = '<div class="mzc-note" style="padding:6px 8px">No hay accesos temporales a√∫n.</div>';
    return;
  }

  const cardsHtml = `
    <div class="mz-temp-cards">
      ${list.map(it => `
        <div class="mz-temp-card">
          <div class="mz-temp-user" title="${it.temp_name}">${it.temp_name}</div>
          <div class="mz-temp-key">${it.key}</div>
          <div class="mz-temp-actions">
            <button class="mz-temp-icbtn mz-copy" data-key="${it.key}" type="button" title="Copiar" aria-label="Copiar">üìã</button>
          </div>
        </div>
      `).join('')}
    </div>
  `;

  const tableHtml = `
    <div class="mz-temp-present-wrap">
      <button id="mz-temp-present" class="mzc-btn" type="button">
        Presentar en pantalla
      </button>
    </div>

    <div class="mz-temp-tablewrap">
      <table class="mz-tbl">
        <thead>
          <tr><th>Usuario</th><th>Clave</th><th></th></tr>
        </thead>
        <tbody>
          ${list.map(it => `
            <tr>
              <td>${it.temp_name}</td>
              <td><code>${it.key}</code></td>
              <td>
                <button class="mzc-btn ghost mz-copy" data-key="${it.key}" type="button">
                  Copiar
                </button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;

  // –í–∞–∂–Ω–æ: –∏ table, –∏ cards ‚Äî –≤ DOM –≤—Å–µ–≥–¥–∞; CSS —Ä–µ—à–∞–µ—Ç, —á—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å
  $tbl.innerHTML = tableHtml + cardsHtml;

  // bind copy (—Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫)
  $tbl.querySelectorAll('.mz-copy').forEach(function(b){
    b.addEventListener('click', async function(){
      try{
        await navigator.clipboard.writeText(b.dataset.key || '');
        const old = b.textContent;
        b.textContent = 'Copiado';
        setTimeout(function(){ b.textContent = old; }, 1200);
      }catch(_){}
    });
  });

  // present overlay ‚Äî –∫–∞–∫ —É —Ç–µ–±—è –±—ã–ª–æ
  const presentBtn = $tbl.querySelector('#mz-temp-present');
  if (presentBtn){
    presentBtn.addEventListener('click', function(){
      const html = `
        <div id="mz-temp-present-overlay"
             style="position:fixed;inset:0;background:#0b1220e6;z-index:99999;
                    display:flex;align-items:center;justify-content:center">
          <div style="width:min(1400px,96vw);height:min(90vh,900px);
                      background:#0b1220;border:1px solid #17243a;border-radius:16px;
                      padding:18px;display:flex;flex-direction:column;gap:14px">
            <div style="display:flex;justify-content:space-between;align-items:center;color:#e6f0ff">
              <div style="font-weight:800;font-size:24px">Accesos temporales</div>
              <button class="mzc-btn" id="mz-tp-close">Cerrar</button>
            </div>
            <div style="
                  flex:1;
                  overflow:auto;
                  display:grid;
                  gap:16px;
                  grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));
                ">
              ${list.map(x => `
                <div style="background:#0f1b2d;border:1px solid #1d2c45;border-radius:16px;
                            padding:20px;display:flex;flex-direction:column;gap:12px">
                  <div style="color:#93b7e6;font-size:22px;font-weight:700;
                              white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
                    ${x.temp_name}
                  </div>
                  <div style="color:#fff;font-size:56px;font-weight:900;
                              font-family:ui-monospace,Menlo,Consolas,monospace;
                              letter-spacing:0.08em;text-align:center">
                    ${x.key}
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>`;
      document.body.insertAdjacentHTML('beforeend', html);
      document.getElementById('mz-tp-close')
        ?.addEventListener('click', function(){
          document.getElementById('mz-temp-present-overlay')?.remove();
        });
    });
  }
}

    async function refreshTempList(){
      try{
        const list = await loadTempList(Math.max(100, parseInt($cnt.value || '10', 10)));
        renderTempTable(list);
        $sel.innerHTML = list
          .map(x => `<option value="${x.temp_name}">${x.temp_name}</option>`)
          .join('');
      }catch(e){
        $tbl.innerHTML = '<div class="mzc-note" style="padding:6px 8px">No hay accesos temporales a√∫n.</div>';
      }
    }

    $gen.addEventListener('click', async function(){
      const n = parseInt($cnt.value, 10);
      if (!Number.isFinite(n) || n < 1 || n > 100){
        $msg.textContent = 'Indica cantidad de 1 a 100.';
        return;
      }
      $msg.textContent = 'Generando‚Ä¶';
      try{
        await genTempAccounts(n);
        $msg.textContent = 'Generado correctamente.';
        await refreshTempList();
        setTimeout(function(){ $msg.textContent = ''; }, 1200);
      }catch(e){
        $msg.textContent = e.message || 'Error al generar.';
      }
    });

    $dl.addEventListener('click', async function(){
      try{
        const list = await loadTempList(1000);
        const rows = list.map(function(it){ return it.temp_name + ',' + it.key; }).join('\n');
        const blob = new Blob(['temp_name,key\n' + rows + '\n'], {type:'text/csv;charset=utf-8;'});
        const url  = URL.createObjectURL(blob);
        const a    = document.createElement('a');
        a.href = url;
        a.download = courseCode + '_temp_accounts.csv';
        a.click();
        setTimeout(function(){ URL.revokeObjectURL(url); }, 1000);
      }catch(e){
        $msg.textContent = 'No se pudo descargar CSV.';
      }
    });

    $rot.addEventListener('click', async function(){
      const t = $sel.value || '';
      if (!t){
        $msg.textContent = 'Selecciona un alumno';
        return;
      }
      $msg.textContent = 'Rotando‚Ä¶';
      try{
        const res = await rotateKey(t);
        const key = res && res.key;
        $msg.textContent = t + ': nueva clave ' + (key || '');
        await refreshTempList();
      }catch(e){
        $msg.textContent = e.message || 'Error al rotar.';
      }
    });

    // —Å—Ç–∞—Ä—Ç
    refreshTempList();
  })();
  </script>

{% endif %}
</div><script>
(function(){
  const tab = document.getElementById('mz-alumnos-tab');
  if (!tab) return;

  const courseCode = (document.querySelector('#mz-temp-root')?.dataset.courseCode) || '';
  if (!courseCode) return;

  const V5 = (window.MEATZE && window.MEATZE.V5)
    ? window.MEATZE.V5.replace(/\/$/,'')
    : (location.origin + '/meatze/v5');

  const STATUS_URL = `/alumno/curso/${courseCode}/alumnos/status`;
  const DECIDE_URL = `${V5}/teacher/attendance/decide`;

  // --- tooltip node (lives in body) ---
  const tip = document.createElement('div');
  tip.className = 'mz-tip';
  tip.style.display = 'none';
  document.body.appendChild(tip);

  let lastData = { total_files: 0, total_phys: 0, items: {}, slot: null, presence: {} };

  function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

  function placeTip(x, y){
    const pad = 12;
    const rect = tip.getBoundingClientRect();
    let left = x + pad;
    let top  = y + pad;
    left = clamp(left, 8, window.innerWidth  - rect.width  - 8);
    top  = clamp(top,  8, window.innerHeight - rect.height - 8);
    tip.style.left = left + 'px';
    tip.style.top  = top  + 'px';
  }

  function escapeHtml(s){
    return String(s || '').replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  function renderTip(studentId){
    const it = (lastData.items && lastData.items[studentId]) || null;
    if (!it) { tip.innerHTML = '<div class="muted">Sin datos‚Ä¶</div>'; return; }

    const dl = Array.isArray(it.dl) ? it.dl : [];
    const rc = Array.isArray(it.rc) ? it.rc : [];
    const totalFiles = Number(lastData.total_files || 0);
    const totalPhys  = Number(lastData.total_phys  || 0);

    tip.innerHTML = `
      <h5>Descargados (${Number(it.d||0)}/${totalFiles})</h5>
      ${dl.length ? `<ul>${dl.map(x => `<li>${escapeHtml(x)}</li>`).join('')}</ul>`
                  : `<div class="muted">Nada descargado</div>`}

      <h5>Material f√≠sico (${Number(it.r||0)}/${totalPhys})</h5>
      ${rc.length ? `<ul>${rc.map(x => `<li>${escapeHtml(x)}</li>`).join('')}</ul>`
                  : `<div class="muted">Nada confirmado</div>`}
    `;
  }

  // hover handlers (delegation)
  let hoverId = null;

  tab.addEventListener('mousemove', function(e){
    if (tip.style.display !== 'none') placeTip(e.clientX, e.clientY);
  });

  tab.addEventListener('mouseenter', function(e){
    const td = e.target.closest('[data-role="progress"]');
    if (!td) return;
    hoverId = td.dataset.studentId;
    renderTip(hoverId);
    tip.style.display = 'block';
  }, true);

  tab.addEventListener('mouseleave', function(e){
    const td = e.target.closest('[data-role="progress"]');
    if (!td) return;
    hoverId = null;
    tip.style.display = 'none';
  }, true);

  tab.querySelector('.mz-alu-tablewrap')?.addEventListener('scroll', function(){
    tip.style.display = 'none';
  });

  function fmtMin(sec){
    sec = Number(sec||0);
    const m = Math.floor(sec/60);
    return m + 'm';
  }

  function renderPresenceFor(studentId){
    const p = (lastData.presence || {})[studentId] || null;

    const chips = tab.querySelectorAll(`[data-pres-chip="${studentId}"]`);
    const acts  = tab.querySelectorAll(`[data-pres-actions="${studentId}"]`);
    if (!chips.length || !acts.length) return;

    function setAllChip(className, text){
      chips.forEach(ch => { ch.className = className; ch.textContent = text; });
    }
    function setAllAct(html){
      acts.forEach(a => { a.innerHTML = html; });
    }
    function drawActions(aid){
      if (!aid) return '';
      return `
        <button class="mzc-btn sm ghost" type="button" data-decide="confirm" data-aid="${aid}">‚úÖ</button>
        <button class="mzc-btn sm ghost" type="button" data-decide="reject"  data-aid="${aid}">‚ùå</button>
      `;
    }

    // clear actions first
    setAllAct('');

    if (!p){
      setAllChip('mz-pres-chip mz-pres-none', '‚Äî');
      return;
    }

    const status = String(p.status || '');
    const mins = fmtMin(p.active_sec || 0);
    const aid = p.id;

    if (status === 'CONFIRMED'){
      setAllChip('mz-pres-chip mz-pres-confirmed', `üü¢ En clase ¬∑ ${mins}`);
      setAllAct('');
      return;
    }

    if (status === 'PENDING'){
      setAllChip('mz-pres-chip mz-pres-pending', `üü° Esperando ¬∑ ${mins}`);
      setAllAct(drawActions(aid));
      return;
    }

    if (status === 'REJECTED'){
      setAllChip('mz-pres-chip mz-pres-offsite', `üî¥ Rechazado ¬∑ ${mins}`);
      setAllAct(drawActions(aid));
      return;
    }

    if (status === 'OFFSITE'){
      setAllChip('mz-pres-chip mz-pres-offsite', `üî¥ Fuera ¬∑ ${mins}`);
      setAllAct('');
      return;
    }

    if (status === 'ENDED'){
      setAllChip('mz-pres-chip mz-pres-ended', `‚ö™ Terminado ¬∑ ${mins}`);
      setAllAct('');
      return;
    }

    setAllChip('mz-pres-chip mz-pres-none', status || '‚Äî');
    setAllAct('');
  }

  // decide click (delegation)
  tab.addEventListener('click', async function(e){
    const b = e.target.closest('[data-decide]');
    if (!b) return;

    const decision = b.dataset.decide;
    const aid = b.dataset.aid;

    try{
      b.disabled = true;
      await fetch(DECIDE_URL, {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          curso_codigo: courseCode,
          attendance_id: aid,
          decision: decision
        })
      });
    }catch(_){
    }finally{
      b.disabled = false;
      refreshProgress(); // –æ–±–Ω–æ–≤–∏–º —Å—Ä–∞–∑—É
    }
  });

  // --- publish pending count for global checklist ---
  function publishAttendance(){
    try{
      const pres = lastData.presence || {};
      let pending = 0;
      for (const sid in pres){
        if (String(pres[sid]?.status || '') === 'PENDING') pending++;
      }
      window.MEATZE = window.MEATZE || {};
      window.MEATZE.ATTENDANCE = {
        pending_count: pending,
        presence: pres,
        courseCode: courseCode
      };
      window.dispatchEvent(new CustomEvent('meatze:attendance', { detail: window.MEATZE.ATTENDANCE }));
    }catch(e){}
  }

  async function refreshProgress(){
    try{
      const resp = await fetch(STATUS_URL, {credentials:'include'});
      if (!resp.ok) return;
      const data = await resp.json();

      lastData = {
        total_files: data.total_files ?? 0,
        total_phys:  data.total_phys ?? 0,
        items: data.items || {},
        slot: data.slot || null,
        presence: data.presence || {}
      };

      publishAttendance();

      const total = Number(lastData.total_files || 0);
      const totalPhys = Number(lastData.total_phys || 0);

      // –í–ê–ñ–ù–û: [data-role="progress"] –µ—Å—Ç—å –∏ –≤ —Ç–∞–±–ª–∏—Ü–µ, –∏ –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö
      tab.querySelectorAll('[data-role="progress"]').forEach(node => {
        const id = node.dataset.studentId;
        const it = lastData.items?.[id] || { d: 0, r: 0 };

        const d = Number(it.d || 0);
        const r = Number(it.r || 0);

        // –æ–±–Ω–æ–≤–ª—è–µ–º –í–°–ï —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è (—Ç–∞–±–ª–∏—Ü–∞ + –∫–∞—Ä—Ç–æ—á–∫–∏)
        tab.querySelectorAll(`[data-p-dl="${id}"]`).forEach(el => {
          el.textContent = `üì• ${d}/${total}`;
        });

        tab.querySelectorAll(`[data-p-rc="${id}"]`).forEach(el => {
          el.textContent = `üì¶ ${r}/${totalPhys}${(totalPhys && r >= totalPhys) ? " ‚úî" : ""}`;
        });

        renderPresenceFor(id);
      });

      if (hoverId && tip.style.display !== 'none') renderTip(hoverId);

    }catch(e){}
  }

  refreshProgress();
  setInterval(refreshProgress, 8000);
})();
</script>

<script>
(function(){
  const tab = document.getElementById('mz-alumnos-tab');
  if (!tab) return;

  const courseCode = (document.querySelector('#mz-temp-root')?.dataset.courseCode) || '';
  if (!courseCode) return;

  // endpoints (–ø—Ä–æ–≤–µ—Ä—å –ø—É—Ç—å –∫–∞–∫ —Ç—ã –¥–æ–±–∞–≤–∏–ª –≤ urls.py)
  const GET_URL = '/alumno/meatze/v5/teacher/student-modules/get';
  const SET_URL = '/alumno/meatze/v5/teacher/student-modules/set';

  // dropdown node
  const dd = document.createElement('div');
  dd.className = 'mz-mod-dd';
	dd.innerHTML = `
	  <div class="head">
		<div>
		  <div class="ttl">M√≥dulos</div>
		  <div class="sub" data-sub></div>
		</div>
		<button class="close" type="button" aria-label="Cerrar">‚úï</button>
	  </div>

	  <div class="list" data-list></div>

	  <div class="status" data-status style="margin-top:10px">‚Äî</div>
	`;
  document.body.appendChild(dd);

  const $sub = dd.querySelector('[data-sub]');
  const $list = dd.querySelector('[data-list]');
  const $status = dd.querySelector('[data-status]');

  let openFor = { alumnoId: null, alumnoName: '', items: [] };
  let saveTimer = null;

  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  function placeNear(btn){
    const r = btn.getBoundingClientRect();
    const rect = dd.getBoundingClientRect();
    let left = r.left;
    let top = r.bottom + 8;
    // show first to measure, then clamp
    left = clamp(left, 8, window.innerWidth - rect.width - 8);
    top  = clamp(top,  8, window.innerHeight - rect.height - 8);
    dd.style.left = left + 'px';
    dd.style.top  = top  + 'px';
  }

function getCookie(name){
  const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return m ? decodeURIComponent(m.pop()) : '';
}

async function api(url, opts){
  opts = opts || {};
  const init = {
    method: opts.method || 'GET',
    credentials: 'include',
    headers: opts.headers || {}
  };

  // ‚úÖ CSRF –¥–ª—è unsafe –º–µ—Ç–æ–¥–æ–≤
  const method = (init.method || 'GET').toUpperCase();
  if (!['GET','HEAD','OPTIONS','TRACE'].includes(method)){
    init.headers['X-CSRFToken'] = getCookie('csrftoken');
  }

  if (opts.body){
    init.body = JSON.stringify(opts.body);
    init.headers['Content-Type'] = 'application/json';
  }

  const resp = await fetch(url, init);
  let data = null;
  try { data = await resp.json(); } catch(_){}
  if (!resp.ok){
    throw new Error((data && (data.error || data.message)) || ('HTTP ' + resp.status));
  }
  return data || {};
}

  function close(){
    dd.style.display = 'none';
    openFor = { alumnoId: null, alumnoName: '', items: [] };
  }

  dd.querySelector('.close').addEventListener('click', close);

  document.addEventListener('click', function(e){
    if (dd.style.display === 'none') return;
    const inside = e.target.closest('.mz-mod-dd');
    const opener = e.target.closest('[data-action="student.modules.open"]');
    if (!inside && !opener) close();
  });

  async function loadAndOpen(btn, alumnoId, alumnoName){
    $status.textContent = 'Cargando‚Ä¶';
    dd.style.display = 'block';
    // temporary show to compute size
    dd.style.left = '8px';
    dd.style.top = '8px';

    placeNear(btn);

    $sub.textContent = `${alumnoName} ¬∑ ${courseCode}`;
    $list.innerHTML = '';

    const u = new URL(GET_URL, window.location.origin);
    u.searchParams.set('codigo', courseCode);
    u.searchParams.set('alumno_id', alumnoId);

    const res = await api(u.toString());
    const items = Array.isArray(res.items) ? res.items : [];
    openFor = { alumnoId, alumnoName, items };

    if (!items.length){
      $list.innerHTML = `<div style="padding:6px 8px;color:#9ca3af;font-size:.82rem">
        No hay m√≥dulos (carpetas bloqueadas) en este curso.
      </div>`;
      $status.textContent = '‚Äî';
      return;
    }
	

    $list.innerHTML = items.map(it => `
      <label class="row">
        <input type="checkbox" data-key="${String(it.key)}" ${it.enabled ? 'checked' : ''}>
        <div class="lbl">
          <b title="${String(it.label)}">${String(it.label)}</b>
          <span>${String(it.key)}</span>
        </div>
      </label>
    `).join('');
	updateStatus('');
  }

	function updateStatus(prefix){
	  const total = $list.querySelectorAll('input[type="checkbox"]').length;
	  const on = $list.querySelectorAll('input[type="checkbox"]:checked').length;
	  const base = `Activos: ${on}/${total}`;
	  $status.textContent = prefix ? `${prefix} ¬∑ ${base}` : base;
	}

	function scheduleSave(){
	  if (saveTimer) clearTimeout(saveTimer);
	  updateStatus('Guardando');
	  saveTimer = setTimeout(saveNow, 350);
	}

	async function saveNow(){
	  if (!openFor.alumnoId) return;

	  const inputs = Array.from($list.querySelectorAll('input[type="checkbox"][data-key]'));
	  const payload = {
		codigo: courseCode,
		alumno_id: openFor.alumnoId,
		items: inputs.map(i => ({ key: i.dataset.key, enabled: !!i.checked }))
	  };

	  try{
		await api(SET_URL, { method:'POST', body: payload });
		updateStatus('Guardado');
		// –º–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–æ —É–±—Ä–∞—Ç—å ‚ÄúGuardado‚Äù —á–µ—Ä–µ–∑ 800–º—Å:
		setTimeout(() => {
		  // –µ—Å–ª–∏ dropdown –µ—â–µ –æ—Ç–∫—Ä—ã—Ç –∏ —Ç–æ—Ç –∂–µ alumno
		  if (dd.style.display !== 'none' && openFor.alumnoId) updateStatus('');
		}, 900);
	  }catch(e){
		console.warn(e);
		updateStatus('Error');
	  }
	}

$list.addEventListener('change', function(e){
  if (e.target && e.target.matches('input[type="checkbox"][data-key]')){
    scheduleSave();
  }
});


  // open handler (delegation)
  tab.addEventListener('click', function(e){
    const b = e.target.closest('[data-action="student.modules.open"]');
    if (!b) return;
    const alumnoId = b.dataset.alumnoId;
    const alumnoName = b.dataset.alumnoName || 'Alumno';
    loadAndOpen(b, alumnoId, alumnoName).catch(err => {
      $status.textContent = err.message || 'Error';
    });
  });

  window.addEventListener('resize', function(){
    if (dd.style.display === 'none') return;
    // no anchor after resize; keep clamped
    const rect = dd.getBoundingClientRect();
    dd.style.left = clamp(rect.left, 8, window.innerWidth - rect.width - 8) + 'px';
    dd.style.top  = clamp(rect.top,  8, window.innerHeight - rect.height - 8) + 'px';
  });
})();
</script>