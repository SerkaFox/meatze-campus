{# panel/tabs/alumnos.html #}

<style>
  /* ================================
     MEATZE ¬∑ TAB ALUMNOS (DOCENTES)
  ================================= */
  #mz-alumnos-tab .mz-alu-head {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 10px;
    margin-bottom: 10px;
  }
  #mz-alumnos-tab .mz-alu-title {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    letter-spacing: 0.04em;
    text-transform: uppercase;
  }
  #mz-alumnos-tab .mz-alu-sub {
    margin: 2px 0 0;
    font-size: 0.82rem;
    opacity: 0.85;
  }
  #mz-alumnos-tab .mz-alu-badge {
    font-size: 0.76rem;
    padding: 4px 9px;
    border-radius: 999px;
    border: 1px solid rgba(148,163,184,0.7);
    background: rgba(15,23,42,0.9);
    white-space: nowrap;
  }

  #mz-alumnos-tab .mz-alu-tablewrap {
    margin-top: 8px;
    border-radius: 12px;
    border: 1px solid rgba(148,163,184,0.45);
    overflow: auto;
    background: rgba(15,23,42,0.85);
  }

  #mz-alumnos-tab .mz-tbl {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.86rem;
  }
  #mz-alumnos-tab .mz-tbl thead tr {
    background: rgba(15,23,42,0.98);
  }
  #mz-alumnos-tab .mz-tbl th,
  #mz-alumnos-tab .mz-tbl td {
    padding: 6px 9px;
    text-align: left;
    border-bottom: 1px solid rgba(30,64,175,0.45);
  }
  #mz-alumnos-tab .mz-tbl th {
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    opacity: 0.85;
  }
  #mz-alumnos-tab .mz-tbl tbody tr:nth-child(2n) {
    background: rgba(15,23,42,0.9);
  }

  #mz-alumnos-tab .mz-alu-actions {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  #mz-alumnos-tab .mz-alu-inline-pass {
    margin-top: 4px;
    padding: 4px 6px;
    border-radius: 10px;
    border: 1px dashed rgba(148,163,184,0.65);
    font-size: 0.78rem;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  #mz-alumnos-tab .mz-alu-inline-pass code {
    font-size: 0.9rem;
  }

  /* ================================
     ACCESOS TEMPORALES
  ================================= */
  #mz-alumnos-tab #mz-temp-root {
    margin-top: 14px;
  }
  #mz-alumnos-tab .mz-temp-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    margin: 6px 0;
  }
  #mz-alumnos-tab .mz-temp-bar label,
  #mz-alumnos-tab .mz-temp-bar span {
    font-size: 0.8rem;
    opacity: 0.9;
  }
  #mz-alumnos-tab .mz-temp-input {
    max-width: 120px;
  }
  #mz-alumnos-tab .mz-temp-select {
    max-width: 200px;
  }

  #mz-alumnos-tab #mz-temp-table {
    margin-top: 10px;
    border-radius: 12px;
    border: 1px solid rgba(148,163,184,0.45);
    overflow: auto;
  }

  #mz-alumnos-tab #mz-temp-table table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.86rem;
  }
  #mz-alumnos-tab #mz-temp-table th,
  #mz-alumnos-tab #mz-temp-table td {
    padding: 6px 9px;
    border-bottom: 1px solid rgba(30,64,175,0.45);
  }
  #mz-alumnos-tab #mz-temp-table thead tr {
    background: rgba(15,23,42,0.98);
  }
  #mz-alumnos-tab #mz-temp-table tbody tr:nth-child(2n) {
    background: rgba(15,23,42,0.9);
  }

  #mz-alumnos-tab .mz-temp-present-wrap {
    display: flex;
    justify-content: flex-end;
    padding: 6px 6px 0;
  }

  @media (max-width: 780px) {
    #mz-alumnos-tab .mz-alu-head {
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
    }
    #mz-alumnos-tab .mz-alu-actions {
      flex-direction: row;
      flex-wrap: wrap;
    }
  }
    /* –ö–ù–û–ü–ö–ò –í –ê–õ–£–ú–ù–û–° ‚Äî –°–¢–ï–ö–õ–û, –ß–¢–û–ë–´ –ù–ï –ü–†–û–ü–ê–î–ê–õ–ò */
  #mz-alumnos-tab .mzc-btn {
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 6px 16px;
    font-size: 0.82rem;
    font-weight: 500;
    border-radius: 999px;
    border: 1px solid rgba(148,163,184,0.7);
    cursor: pointer;
    user-select: none;
    text-decoration: none;
    background: radial-gradient(circle at top, rgba(56,189,248,0.22), rgba(15,23,42,0.96));
    color: #e5e7eb;
    transition:
      background 140ms ease,
      border-color 140ms ease,
      box-shadow 140ms ease,
      transform 90ms ease;
  }

  #mz-alumnos-tab .mzc-btn.ghost {
    background: radial-gradient(circle at top, rgba(15,23,42,0.9), rgba(30,64,175,0.85));
  }

  #mz-alumnos-tab .mzc-btn:hover {
    transform: translateY(-1px);
    box-shadow:
      0 8px 20px rgba(15,23,42,0.9),
      0 0 0 1px rgba(15,23,42,1);
    border-color: rgba(191,219,254,0.9);
  }

  #mz-alumnos-tab .mzc-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 8px rgba(15,23,42,0.9);
  }
/* ===== FIX: —Ä–æ–≤–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ Alumnos ===== */
#mz-alumnos-tab .mz-alu-tbl{
  table-layout: fixed;      /* –∫–ª—é—á–µ–≤–æ–µ */
  width: 100%;
}

#mz-alumnos-tab .mz-alu-tbl .c-idx  { width: 44px; }
#mz-alumnos-tab .mz-alu-tbl .c-name { width: 22%; }
#mz-alumnos-tab .mz-alu-tbl .c-email{ width: 34%; }
#mz-alumnos-tab .mz-alu-tbl .c-prog { width: 18%; }
#mz-alumnos-tab .mz-alu-tbl .c-act  { width: 220px; } /* –ø–æ–¥ 2-3 –∫–Ω–æ–ø–∫–∏ */

#mz-alumnos-tab .mz-alu-tbl td,
#mz-alumnos-tab .mz-alu-tbl th{
  vertical-align: middle;
}

/* email –Ω–µ —Ä–∞–∑–¥–≤–∏–≥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É */
#mz-alumnos-tab .mz-alu-tbl td:nth-child(3){
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* –ø—Ä–æ–≥—Ä–µ—Å—Å –º–æ–∂–Ω–æ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å */
#mz-alumnos-tab .mz-alu-tbl td:nth-child(4){
  white-space: normal;
}

/* acciones ‚Äî –≤—Å–µ–≥–¥–∞ ‚Äú–∫–æ–ª–æ–Ω–∫–æ–π‚Äù, –±–µ–∑ —Ä–∞—Å–ø–æ–ª–∑–∞–Ω–∏—è */
#mz-alumnos-tab .mz-alu-actions{
  align-items: flex-start;
  min-width: 0;
}
#mz-alumnos-tab .mz-alu-tbl td:nth-child(4) * { min-width: 0; }
#mz-alumnos-tab .mz-alu-tbl td:nth-child(5) { white-space: nowrap; }
#mz-alumnos-tab table.mz-alu-tbl col.c-idx  { width: 44px; }
#mz-alumnos-tab table.mz-alu-tbl col.c-name { width: 22%; }
#mz-alumnos-tab table.mz-alu-tbl col.c-email{ width: 34%; }
#mz-alumnos-tab table.mz-alu-tbl col.c-prog { width: 18%; }
#mz-alumnos-tab table.mz-alu-tbl col.c-act  { width: 220px; }
/* === Tooltip –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ === */
.mz-prog-wrap { position: relative; display: inline-flex; align-items: center; gap: 8px; flex-wrap: wrap; }

.mz-prog-tip {
  position: absolute;
  top: calc(100% + 8px);
  left: 0;
  z-index: 9999;
  width: min(520px, 70vw);
  padding: 10px 12px;
  border-radius: 14px;
  border: 1px solid rgba(148,163,184,0.55);
  background: radial-gradient(circle at top left, rgba(30,64,175,0.22), rgba(15,23,42,0.96));
  box-shadow: 0 12px 30px rgba(0,0,0,0.35);
  display: none;
}

.mz-prog-tip.is-open { display: block; }

.mz-prog-tip h5{
  margin: 0 0 6px;
  font-size: .78rem;
  letter-spacing: .06em;
  text-transform: uppercase;
  opacity: .9;
}

.mz-prog-tip ul{
  margin: 0;
  padding-left: 18px;
  color: #e5e7eb;
  font-size: .82rem;
}

.mz-prog-tip li{ margin: 2px 0; }

.mz-prog-tip .muted{ color:#9ca3af; font-size:.8rem; }
/* ===== Tooltip progreso (fixed, opaque, no layout impact) ===== */
.mz-tip {
  position: fixed;
  z-index: 99999;
  width: min(360px, 92vw);
  max-height: min(320px, 70vh);
  overflow: auto;

  padding: 12px 12px 10px;
  border-radius: 14px;
  border: 1px solid rgba(191,219,254,0.45);

  /* –ù–ï –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π */
  background: #0b1220;
  color: #e5e7eb;

  box-shadow: 0 18px 45px rgba(0,0,0,0.55);
}

.mz-tip h5 {
  margin: 0 0 6px;
  font-size: .78rem;
  letter-spacing: .08em;
  text-transform: uppercase;
  opacity: .92;
}

.mz-tip ul {
  margin: 0 0 10px;
  padding-left: 16px;
  font-size: .82rem;
  color: #e5e7eb;
}

.mz-tip li { margin: 4px 0; }

.mz-tip .muted {
  color: #9ca3af;
  font-size: .8rem;
}
/* ===== Presencia (inline in Progreso) ===== */
#mz-alumnos-tab .mz-prog-row{ display:flex; flex-direction:column; gap:8px; }
#mz-alumnos-tab .mz-prog-chips{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

#mz-alumnos-tab .mz-pres-row{
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
}

#mz-alumnos-tab .mz-pres-chip{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:4px 10px;
  border-radius:999px;
  font-size:.78rem;
  font-weight:700;
  letter-spacing:.02em;
  border:1px solid rgba(148,163,184,0.55);
  background:#0b1220;
  color:#e5e7eb;
}

#mz-alumnos-tab .mz-pres-none{ opacity:.6; }
#mz-alumnos-tab .mz-pres-confirmed{ border-color: rgba(52,211,153,.55); color:#6ee7b7; }
#mz-alumnos-tab .mz-pres-pending{ border-color: rgba(251,191,36,.55); color:#fde68a; }
#mz-alumnos-tab .mz-pres-offsite{ border-color: rgba(248,113,113,.55); color:#fecaca; }
#mz-alumnos-tab .mz-pres-ended{ border-color: rgba(148,163,184,.4); color:#cbd5e1; opacity:.9; }

#mz-alumnos-tab .mz-pres-actions{ display:inline-flex; gap:6px; align-items:center; }
#mz-alumnos-tab .mz-pres-actions .mzc-btn{ padding:4px 10px; font-size:.78rem; }

</style>

<div id="mz-alumnos-tab" data-focus="alumnos_tab">

{% if not is_teacher %}
  <div class="mzc-card">
    <h4 class="mzc-h2">Alumnos</h4>
    <div class="mzc-note">Esta secci√≥n solo est√° disponible para el equipo docente.</div>
  </div>
{% else %}

  {# ==== LISTA DE ALUMNOS ==== #}
  <div class="mzc-card">
    <div class="mz-alu-head">
      <div>
        <h4 class="mz-alu-title">Alumnos inscritos</h4>
        <p class="mz-alu-sub">
          Gesti√≥n de acceso al campus para este curso.
        </p>
      </div>
      <div class="mz-alu-badge">
        {% if students %}
          {{ students|length }} alumno{{ students|length|pluralize:"s" }}
        {% else %}
          0 alumnos
        {% endif %}
      </div>
    </div>

    <div class="mz-alu-tablewrap" data-focus="attendance">
        <table class="mz-tbl mz-alu-tbl">
<colgroup>
  <col class="c-idx" />
  <col class="c-name" />
  <col class="c-email" />
  <col class="c-prog" />
  <col class="c-act" />
</colgroup>

        <thead>
          <tr>
            <th>#</th>
            <th>Nombre</th>
            <th>Email</th>
            <th>Progreso</th>
            <th>Acci√≥n</th>
          </tr>
        </thead>
        <tbody>
          {% if students %}
            {% for s in students %}
			<tr>
			  <td>{{ s.idx }}</td>
			  <td><b>{{ s.name }}</b></td>
			  <td>{{ s.email }}</td>

				<td data-role="progress" data-student-id="{{ s.id }}">
				  <div class="mz-prog-row">
					<div class="mz-prog-chips" data-focus="physical">
					  <span class="mz-chip-mini">üì• {{ s.downloaded_files }}/{{ s.total_files }}</span>
					  <span class="mz-chip-mini">üì¶ {{ s.receipts_count }}</span>
					</div>

					<!-- NEW: presencia chip + actions -->
					<div class="mz-pres-row" data-pres-row="{{ s.id }}">
					  <span class="mz-pres-chip mz-pres-none" data-pres-chip="{{ s.id }}">‚Äî</span>
					  <span class="mz-pres-actions" data-pres-actions="{{ s.id }}"></span>
					</div>
				  </div>
				</td>

                <td>
                  <div class="mz-alu-actions">

                    {# —Å–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è #}
                    <form method="post" style="margin:0">
                      {% csrf_token %}
                      <input type="hidden" name="reset_id" value="{{ s.id }}">
						<button type="submit"
								class="mzc-btn sm ghost"
								title="Reiniciar clave"
								data-action="alumno.password.reset"
								data-alumno-id="{{ s.id }}">
						  üîë Reiniciar clave
						</button>

                    </form>

                    {# —É–¥–∞–ª–∏—Ç—å —É—á–µ–Ω–∏–∫–∞ #}
                    <form method="post" style="margin:0"
                          onsubmit="return confirm('¬øEliminar a este alumno del curso?');">
                      {% csrf_token %}
                      <input type="hidden" name="remove_id" value="{{ s.id }}">
						<button type="submit"
								class="mzc-btn sm ghost"
								title="Eliminar del curso"
								data-action="alumno.remove"
								data-alumno-id="{{ s.id }}">
						  ‚úï Eliminar
						</button>
                    </form>

                    {# –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤—ã–¥–∞–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å (–µ—Å–ª–∏ –µ—Å—Ç—å) #}
			{% if s.last_pass %}
			  <div class="mzc-note mz-alu-inline-pass mz-inline-pass" data-pass="{{ s.last_pass }}">
				Nueva clave:
				<code>{{ s.last_pass }}</code>

				<button type="button"
						class="mzc-btn sm ghost mz-pass-copy"
						data-action="alumno.password.copy"
						data-alumno-id="{{ s.id }}">
				  Copiar
				</button>

				<button type="button"
						class="mzc-btn sm ghost mz-pass-hide"
						title="Ocultar">
				  ‚úï
				</button>
			  </div>
			{% endif %}

                  </div>
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="5" class="mzc-note">
                A√∫n no hay alumnos inscritos en este curso.
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  {# ==== ACCESOS TEMPORALES (—á–µ—Ä–µ–∑ V5 API, –∫–∞–∫ —Ä–∞–Ω—å—à–µ) ==== #}
  <div class="mzc-card" id="mz-temp-root"
       data-course-code="{{ curso.codigo }}">

    <div class="mz-alu-head">
      <div>
        <h4 class="mz-alu-title">Accesos temporales</h4>
        <p class="mz-alu-sub">
          C√≥digos para ex√°menes, pruebas o accesos de corta duraci√≥n.
        </p>
      </div>
    </div>

    <div class="mz-temp-bar" data-focus="add_students">
      <label class="mzc-note">Cantidad</label>
      <input id="mz-temp-count"
             class="mzc-inp mz-temp-input"
             type="number" min="1" max="100" step="1"
             value="10">
      <button id="mz-temp-gen" class="mzc-btn" type="button">
        Generar
      </button>
      <button id="mz-temp-dl" class="mzc-btn ghost" type="button">
        Descargar CSV
      </button>
    </div>

    <div class="mz-temp-bar" data-focus="add_students">
      <span class="mzc-note">Rotar clave para:</span>
      <select id="mz-temp-sel"
              class="mzc-inp mz-temp-select"></select>
      <button id="mz-temp-rot" class="mzc-btn ghost" type="button">
        Rotar
      </button>
    </div>

    <div id="mz-temp-msg" class="mzc-note" style="margin-top:4px"></div>
    <div id="mz-temp-table"></div>
  </div>

  {# ==== JS: –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª—è + –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã ==== #}
  <script>
  // –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ "Nueva clave" –≤ –±—É—Ñ–µ—Ä
(function(){
  document.querySelectorAll('.mz-inline-pass').forEach(function(box){
    const btnCopy = box.querySelector('.mz-pass-copy');
    const btnHide = box.querySelector('.mz-pass-hide');
    const pass = box.dataset.pass || box.textContent;

    if (btnCopy && pass){
      btnCopy.addEventListener('click', async function(){
        try{
          await navigator.clipboard.writeText(pass.trim());
          const old = btnCopy.textContent;
          btnCopy.textContent = 'Copiado';
          setTimeout(function(){ btnCopy.textContent = old; }, 1200);
        }catch(e){}
      });
    }

    if (btnHide){
      btnHide.addEventListener('click', function(){
        box.remove(); // —Å–∫—Ä—ã—Ç—å –±–ª–æ–∫ –ø–∞—Ä–æ–ª—è
      });
    }
  });
})();

  // ==== ACCESOS TEMPORALES (V5 API) ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ –ª–æ–≥–∏–∫–µ ====
  (function(){
    const root = document.getElementById('mz-temp-root');
    if (!root) return;

    const courseCode = root.dataset.courseCode;
    const V5_API = '/meatze/v5';

    const $cnt = root.querySelector('#mz-temp-count');
    const $gen = root.querySelector('#mz-temp-gen');
    const $dl  = root.querySelector('#mz-temp-dl');
    const $sel = root.querySelector('#mz-temp-sel');
    const $rot = root.querySelector('#mz-temp-rot');
    const $msg = root.querySelector('#mz-temp-msg');
    const $tbl = root.querySelector('#mz-temp-table');

    async function api(url, opts){
      opts = opts || {};
      const init = {
        method: opts.method || 'GET',
        credentials: 'include',
        headers: opts.headers || {}
      };
      if (opts.body){
        if (opts.body instanceof FormData){
          init.body = opts.body;
        } else {
          init.body = JSON.stringify(opts.body);
          init.headers['Content-Type'] = 'application/json';
        }
      }
      const resp = await fetch(url, init);
      let data = null;
      try { data = await resp.json(); } catch(_){}
      if (!resp.ok){
        const msg = (data && data.message) || ('HTTP ' + resp.status);
        throw new Error(msg);
      }
      return data || {};
    }

    const cntKey = 'mz-temp-count::' + courseCode;
    $cnt.value = (localStorage.getItem(cntKey) || '').trim() || '10';
    $cnt.addEventListener('change', function(){
      localStorage.setItem(cntKey, ($cnt.value || '10').trim());
    });

    async function genTempAccounts(n){
      const fd = new FormData();
      fd.append('course_code', courseCode);
      fd.append('count', String(n));
      fd.append('mode', 'set');
      return await api(V5_API + '/teacher/temp/create', {
        method: 'POST',
        body: fd
      });
    }

    async function loadTempList(limit){
      limit = limit || 300;
      const u = new URL(V5_API + '/teacher/temp/list', window.location.origin);
      u.searchParams.set('course_code', courseCode);
      u.searchParams.set('limit', String(limit));
      const r = await api(u.toString());
      return (r.items || []).map(function(x){
        return { temp_name: x.temp_name, key: x.key };
      });
    }

    async function rotateKey(tempName){
      return await api(V5_API + '/teacher/temp/rotate', {
        method: 'POST',
        body: { course_code: courseCode, temp_name: tempName }
      });
    }

    function renderTempTable(list){
      if (!list.length){
        $tbl.innerHTML = '<div class="mzc-note" style="padding:6px 8px">No hay accesos temporales a√∫n.</div>';
        return;
      }
      $tbl.innerHTML = `
        <div class="mz-temp-present-wrap">
          <button id="mz-temp-present" class="mzc-btn" type="button">
            Presentar en pantalla
          </button>
        </div>
        <table class="mz-tbl">
          <thead>
            <tr><th>Usuario</th><th>Clave</th></tr>
          </thead>
          <tbody>
            ${list.map(it => `
              <tr>
                <td>${it.temp_name}</td>
                <td>
                  <code>${it.key}</code>
                  <button class="mzc-btn ghost mz-copy" data-key="${it.key}" type="button">
                    Copiar
                  </button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;

      $tbl.querySelectorAll('.mz-copy').forEach(function(b){
        b.addEventListener('click', async function(){
          try{
            await navigator.clipboard.writeText(b.dataset.key || '');
            const old = b.textContent;
            b.textContent = 'Copiado';
            setTimeout(function(){ b.textContent = old; }, 1200);
          }catch(_){}
        });
      });

      const presentBtn = $tbl.querySelector('#mz-temp-present');
      if (presentBtn){
        presentBtn.addEventListener('click', function(){
		const html = `
		  <div id="mz-temp-present-overlay"
			   style="position:fixed;inset:0;background:#0b1220e6;z-index:99999;
					  display:flex;align-items:center;justify-content:center">
			<div style="width:min(1400px,96vw);height:min(90vh,900px);
						background:#0b1220;border:1px solid #17243a;border-radius:16px;
						padding:18px;display:flex;flex-direction:column;gap:14px">
			  <div style="display:flex;justify-content:space-between;align-items:center;color:#e6f0ff">
				<div style="font-weight:800;font-size:24px">Accesos temporales</div>
				<button class="mzc-btn" id="mz-tp-close">Cerrar</button>
			  </div>
			  <div style="
					flex:1;
					overflow:auto;
					display:grid;
					gap:16px;
					grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));
				  ">
				${list.map(x => `
				  <div style="background:#0f1b2d;border:1px solid #1d2c45;border-radius:16px;
							  padding:20px;display:flex;flex-direction:column;gap:12px">
					<div style="color:#93b7e6;font-size:22px;font-weight:700;
								white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
					  ${x.temp_name}
					</div>
					<div style="color:#fff;font-size:56px;font-weight:900;
								font-family:ui-monospace,Menlo,Consolas,monospace;
								letter-spacing:0.08em;text-align:center">
					  ${x.key}
					</div>
				  </div>
				`).join('')}
			  </div>
			</div>
		  </div>`;

          document.body.insertAdjacentHTML('beforeend', html);
          document.getElementById('mz-tp-close')
            ?.addEventListener('click', function(){
              document.getElementById('mz-temp-present-overlay')?.remove();
            });
        });
      }
    }

    async function refreshTempList(){
      try{
        const list = await loadTempList(Math.max(100, parseInt($cnt.value || '10', 10)));
        renderTempTable(list);
        $sel.innerHTML = list
          .map(x => `<option value="${x.temp_name}">${x.temp_name}</option>`)
          .join('');
      }catch(e){
        $tbl.innerHTML = '<div class="mzc-note" style="padding:6px 8px">No hay accesos temporales a√∫n.</div>';
      }
    }

    $gen.addEventListener('click', async function(){
      const n = parseInt($cnt.value, 10);
      if (!Number.isFinite(n) || n < 1 || n > 100){
        $msg.textContent = 'Indica cantidad de 1 a 100.';
        return;
      }
      $msg.textContent = 'Generando‚Ä¶';
      try{
        await genTempAccounts(n);
        $msg.textContent = 'Generado correctamente.';
        await refreshTempList();
        setTimeout(function(){ $msg.textContent = ''; }, 1200);
      }catch(e){
        $msg.textContent = e.message || 'Error al generar.';
      }
    });

    $dl.addEventListener('click', async function(){
      try{
        const list = await loadTempList(1000);
        const rows = list.map(function(it){ return it.temp_name + ',' + it.key; }).join('\n');
        const blob = new Blob(['temp_name,key\n' + rows + '\n'], {type:'text/csv;charset=utf-8;'});
        const url  = URL.createObjectURL(blob);
        const a    = document.createElement('a');
        a.href = url;
        a.download = courseCode + '_temp_accounts.csv';
        a.click();
        setTimeout(function(){ URL.revokeObjectURL(url); }, 1000);
      }catch(e){
        $msg.textContent = 'No se pudo descargar CSV.';
      }
    });

    $rot.addEventListener('click', async function(){
      const t = $sel.value || '';
      if (!t){
        $msg.textContent = 'Selecciona un alumno';
        return;
      }
      $msg.textContent = 'Rotando‚Ä¶';
      try{
        const res = await rotateKey(t);
        const key = res && res.key;
        $msg.textContent = t + ': nueva clave ' + (key || '');
        await refreshTempList();
      }catch(e){
        $msg.textContent = e.message || 'Error al rotar.';
      }
    });

    // —Å—Ç–∞—Ä—Ç
    refreshTempList();
  })();
  </script>

{% endif %}
</div>
<script>
(function(){
  const tab = document.getElementById('mz-alumnos-tab');
  if (!tab) return;

  const courseCode = (document.querySelector('#mz-temp-root')?.dataset.courseCode) || '';
  if (!courseCode) return;

  // ‚úÖ –í–ê–ñ–ù–û: –ø—É—Ç—å –Ω–∞ decide ‚Äî –ø–æ–¥—Å—Ç–∞–≤—å —Å–≤–æ–π —Ä–µ–∞–ª—å–Ω—ã–π URL –µ—Å–ª–∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è
const V5 = (window.MEATZE && window.MEATZE.V5) ? window.MEATZE.V5.replace(/\/$/,'') : (location.origin + '/meatze/v5');
const STATUS_URL = `/alumno/curso/${courseCode}/alumnos/status`; // —ç—Ç–æ –æ–∫, —ç—Ç–æ panel
const DECIDE_URL = `${V5}/teacher/attendance/decide`;



  // --- tooltip node (lives in body) ---
  const tip = document.createElement('div');
  tip.className = 'mz-tip';
  tip.style.display = 'none';
  document.body.appendChild(tip);

  let lastData = { total_files: 0, total_phys: 0, items: {}, slot: null, presence: {} };
// --- publish pending count for global checklist ---
(function publishAttendance(){
  try{
    const pres = lastData.presence || {};
    let pending = 0;
    for (const sid in pres){
      if (String(pres[sid]?.status || '') === 'PENDING') pending++;
    }
    window.MEATZE = window.MEATZE || {};
    window.MEATZE.ATTENDANCE = {
      pending_count: pending,
      presence: pres,
      courseCode: courseCode
    };
    window.dispatchEvent(new CustomEvent('meatze:attendance', { detail: window.MEATZE.ATTENDANCE }));
  }catch(e){}
})();

  function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

  function placeTip(x, y){
    const pad = 12;
    const rect = tip.getBoundingClientRect();
    let left = x + pad;
    let top  = y + pad;
    left = clamp(left, 8, window.innerWidth  - rect.width  - 8);
    top  = clamp(top,  8, window.innerHeight - rect.height - 8);
    tip.style.left = left + 'px';
    tip.style.top  = top  + 'px';
  }

  function escapeHtml(s){
    return s.replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  function renderTip(studentId){
    const it = (lastData.items && lastData.items[studentId]) || null;
    if (!it) { tip.innerHTML = '<div class="muted">Sin datos‚Ä¶</div>'; return; }

    const dl = Array.isArray(it.dl) ? it.dl : [];
    const rc = Array.isArray(it.rc) ? it.rc : [];
    const totalFiles = Number(lastData.total_files || 0);
    const totalPhys  = Number(lastData.total_phys  || 0);

    tip.innerHTML = `
      <h5>Descargados (${Number(it.d||0)}/${totalFiles})</h5>
      ${dl.length ? `<ul>${dl.map(x => `<li>${escapeHtml(String(x))}</li>`).join('')}</ul>`
                  : `<div class="muted">Nada descargado</div>`}

      <h5>Material f√≠sico (${Number(it.r||0)}/${totalPhys})</h5>
      ${rc.length ? `<ul>${rc.map(x => `<li>${escapeHtml(String(x))}</li>`).join('')}</ul>`
                  : `<div class="muted">Nada confirmado</div>`}
    `;
  }

  // hover handlers (delegation)
  let hoverId = null;

  tab.addEventListener('mousemove', function(e){
    if (tip.style.display !== 'none') placeTip(e.clientX, e.clientY);
  });

  tab.addEventListener('mouseenter', function(e){
    const td = e.target.closest('[data-role="progress"]');
    if (!td) return;
    hoverId = td.dataset.studentId;
    renderTip(hoverId);
    tip.style.display = 'block';
  }, true);

  tab.addEventListener('mouseleave', function(e){
    const td = e.target.closest('[data-role="progress"]');
    if (!td) return;
    hoverId = null;
    tip.style.display = 'none';
  }, true);

  tab.querySelector('.mz-alu-tablewrap')?.addEventListener('scroll', function(){
    tip.style.display = 'none';
  });

  function fmtMin(sec){
    sec = Number(sec||0);
    const m = Math.floor(sec/60);
    return m + 'm';
  }

function renderPresenceFor(studentId){
  const p = (lastData.presence || {})[studentId] || null;

  const chip = tab.querySelector(`[data-pres-chip="${studentId}"]`);
  const act  = tab.querySelector(`[data-pres-actions="${studentId}"]`);
  if (!chip || !act) return;

  act.innerHTML = '';

  if (!p){
    chip.className = 'mz-pres-chip mz-pres-none';
    chip.textContent = '‚Äî';
    return;
  }

  const status = String(p.status || '');
  const mins = fmtMin(p.active_sec || 0);
  const aid = p.id;

  // helper: —Ä–∏—Å—É–µ–º –∫–Ω–æ–ø–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å attendance id
  function drawActions(){
    if (!aid) return;
    act.innerHTML = `
      <button class="mzc-btn sm ghost" type="button" data-decide="confirm" data-aid="${aid}">‚úÖ</button>
      <button class="mzc-btn sm ghost" type="button" data-decide="reject"  data-aid="${aid}">‚ùå</button>
    `;
  }

  if (status === 'CONFIRMED'){
    chip.className = 'mz-pres-chip mz-pres-confirmed';
    chip.textContent = `üü¢ En clase ¬∑ ${mins}`;

    // ‚úÖ –µ—Å–ª–∏ —Ö–æ—á–µ—à—å —Ä–∞–∑—Ä–µ—à–∏—Ç—å ‚Äú–ø–µ—Ä–µ-—Ä–µ—à–∏—Ç—å‚Äù –¥–∞–∂–µ –∏–∑ CONFIRMED ‚Äî –≤–∫–ª—é—á–∏:
    // drawActions();
    return;
  }

  if (status === 'PENDING'){
    chip.className = 'mz-pres-chip mz-pres-pending';
    chip.textContent = `üü° Esperando ¬∑ ${mins}`;
    drawActions();         // ‚úÖ –±—ã–ª–æ –∏ –æ—Å—Ç–∞—ë—Ç—Å—è
    return;
  }

  if (status === 'REJECTED'){
    chip.className = 'mz-pres-chip mz-pres-offsite';
    chip.textContent = `üî¥ Rechazado ¬∑ ${mins}`;
    drawActions();         // ‚úÖ –í–û–¢ –≠–¢–û–ì–û –ù–ï –•–í–ê–¢–ê–õ–û
    return;
  }

  if (status === 'OFFSITE'){
    chip.className = 'mz-pres-chip mz-pres-offsite';
    chip.textContent = `üî¥ Fuera ¬∑ ${mins}`;
    // –ø–æ –∂–µ–ª–∞–Ω–∏—é –º–æ–∂–Ω–æ —Ç–æ–∂–µ –¥–∞—Ç—å –∫–Ω–æ–ø–∫–∏:
    // drawActions();
    return;
  }

  if (status === 'ENDED'){
    chip.className = 'mz-pres-chip mz-pres-ended';
    chip.textContent = `‚ö™ Terminado ¬∑ ${mins}`;
    return;
  }

  chip.className = 'mz-pres-chip mz-pres-none';
  chip.textContent = status || '‚Äî';
}



  // decide click (delegation)
  tab.addEventListener('click', async function(e){
    const b = e.target.closest('[data-decide]');
    if (!b) return;

    const decision = b.dataset.decide;
    const aid = b.dataset.aid;

    try{
      b.disabled = true;
      await fetch(DECIDE_URL, {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          curso_codigo: courseCode,
          attendance_id: aid,
          decision: decision
        })
      });
    }catch(_){
    }finally{
      b.disabled = false;
      // –æ–±–Ω–æ–≤–∏–º —Å—Ä–∞–∑—É, –Ω–µ –∂–¥—ë–º –∏–Ω—Ç–µ—Ä–≤–∞–ª
      refreshProgress();
    }
  });

  async function refreshProgress(){
    try{
      const resp = await fetch(STATUS_URL, {credentials:'include'});
      if (!resp.ok) return;
      const data = await resp.json();

      lastData = {
        total_files: data.total_files ?? 0,
        total_phys:  data.total_phys ?? 0,
        items: data.items || {},
        slot: data.slot || null,
        presence: data.presence || {}
      };

      const total = Number(lastData.total_files || 0);
      const totalPhys = Number(lastData.total_phys || 0);

      tab.querySelectorAll('[data-role="progress"]').forEach(td => {
        const id = td.dataset.studentId;
        const it = lastData.items[id] || {d: 0, r: 0};

        const d = Number(it.d || 0);
        const r = Number(it.r || 0);

        td.innerHTML = `
          <div class="mz-prog-row">
            <div class="mz-prog-chips">
              <span class="mz-chip-mini">üì• ${d}/${total}</span>
              <span class="mz-chip-mini">üì¶ ${r}/${totalPhys} ${totalPhys && r >= totalPhys ? '‚úî' : ''}</span>
            </div>

            <div class="mz-pres-row" data-pres-row="${id}">
              <span class="mz-pres-chip mz-pres-none" data-pres-chip="${id}">‚Äî</span>
              <span class="mz-pres-actions" data-pres-actions="${id}"></span>
            </div>
          </div>
        `;

        renderPresenceFor(id);
      });

      if (hoverId && tip.style.display !== 'none') renderTip(hoverId);

    }catch(e){}
  }

  refreshProgress();
  setInterval(refreshProgress, 8000);
})();
</script>
