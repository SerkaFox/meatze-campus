{# panel/tabs/materiales.html #}

<style>
#mz-preview.is-hidden{ display:none; }
#mz-preview{ position:fixed; inset:0; z-index:9999; }
#mz-preview .mz-prev-backdrop{ position:absolute; inset:0; background:rgba(2,6,23,.75); }
#mz-preview .mz-prev-card{
  position:relative;
  width:min(1100px, 92vw);
  height:min(86vh, 900px);
  margin:6vh auto;
  border-radius:18px;
  border:1px solid rgba(148,163,184,.35);
  background:rgba(15,23,42,.96);
  box-shadow:0 24px 80px rgba(0,0,0,.55);
  display:flex; flex-direction:column;
}
#mz-preview .mz-prev-head{
  display:flex; justify-content:space-between; align-items:center; gap:10px;
  padding:10px 12px; border-bottom:1px solid rgba(148,163,184,.25);
}
#mz-preview .mz-prev-title{ font-weight:750; color:#e5e7eb; font-size:.95rem; }
#mz-preview .mz-prev-body{ flex:1; overflow:hidden; background:rgba(2,6,23,.35); }
#mz-preview iframe{ width:100%; height:100%; border:0; }
#mz-preview img{ max-width:100%; max-height:100%; display:block; margin:auto; }

  /* === MATERIALS TAB === */
  .mz-mat-card {
    padding: 16px 18px 18px;
    border-radius: 18px;
  }

  .mz-mat-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 10px;
  }

  .mz-mat-title {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    color: #e5e7eb;
  }

  .mz-mat-sub {
    margin: 2px 0 0;
    font-size: 0.8rem;
    color: #9ca3af;
  }

  .mz-mat-count {
    font-size: 0.76rem;
    padding: 4px 9px;
    border-radius: 999px;
    border: 1px solid rgba(148,163,184,0.5);
    background: radial-gradient(circle at top, rgba(15,23,42,0.9), rgba(15,23,42,0.85));
    color: #e5e7eb;
    white-space: nowrap;
  }

  .mz-mat-audience {
    margin: 8px 0 4px;
  }

  .mz-mat-modfilters {
    margin-top: 6px;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .mz-pill {
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 0.78rem;
    border: 1px solid rgba(148,163,184,0.5);
    background: rgba(15,23,42,0.8);
    color: #cbd5f5;
    text-decoration: none;
    cursor: pointer;
    transition: background 140ms ease, color 140ms ease, border-color 140ms ease,
                box-shadow 140ms ease, transform 100ms ease;
    white-space: nowrap;
  }

  .mz-pill:hover {
    background: rgba(30,64,175,0.9);
    border-color: rgba(191,219,254,0.7);
    color: #f9fafb;
    box-shadow: 0 0 0 1px rgba(15,23,42,0.9);
    transform: translateY(-1px);
  }

  .mz-pill.is-act {
    background: radial-gradient(circle at top, #22d3ee, #3b82f6);
    border-color: rgba(248,250,252,0.9);
    color: #0b1120;
    box-shadow:
      0 0 0 1px rgba(15,23,42,0.95),
      0 8px 18px rgba(37,99,235,0.7);
  }

  /* upload form */
  .mz-upl-wrap {
    margin-top: 10px;
    padding: 10px 11px;
    border-radius: 14px;
    border: 1px dashed rgba(148,163,184,0.6);
    background: radial-gradient(circle at top left, rgba(30,64,175,0.35), rgba(15,23,42,0.9));
  }

  .mz-upl-row {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
  }

  .mz-upl-label.pick {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid rgba(148,163,184,0.7);
    cursor: pointer;
    font-size: 0.82rem;
    background: rgba(15,23,42,0.9);
    color: #e5e7eb;
  }

  .mz-upl-label.pick:hover {
    background: rgba(30,64,175,0.9);
    border-color: rgba(191,219,254,0.8);
  }

  .mz-upl-input,
  .mz-upl-select {
    min-width: 180px;
    padding: 7px 9px;
    border-radius: 10px;
    border: 1px solid rgba(148,163,184,0.6);
    background: rgba(15,23,42,0.95);
    color: #e5e7eb;
    font-size: 0.82rem;
  }

  .mz-upl-input::placeholder {
    color: #6b7280;
  }

  /* files list */
  .mz-mat-list {
    list-style: none;
    padding: 0;
    margin: 12px 0 0;
    display: grid;
    gap: 8px;
  }

  .mz-mat-item {
    display: flex;
    justify-content: space-between;
    gap: 12px;
    align-items: flex-start;
    padding: 8px 10px;
    border-radius: 12px;
    border: 1px solid rgba(30,64,175,0.7);
    background: radial-gradient(circle at top left, rgba(15,23,42,0.96), rgba(15,23,42,0.9));
  }

  .mz-mat-main {
    min-width: 0;
  }

  .mz-mat-title-file {
    margin: 0 0 2px;
    font-size: 0.88rem;
  }

  .mz-mat-title-file a {
    color: #f9fafb;
    text-decoration: none;
  }

  .mz-mat-title-file a:hover {
    text-decoration: underline;
  }

  .mz-mat-meta {
    font-size: 0.78rem;
    color: #9ca3af;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    align-items: center;
  }

  .mz-mat-dot {
    width: 3px;
    height: 3px;
    border-radius: 999px;
    background: rgba(148,163,184,0.7);
  }

  .mz-mat-tag {
    font-size: 0.72rem;
    padding: 2px 7px;
    border-radius: 999px;
    border: 1px solid rgba(148,163,184,0.7);
    background: radial-gradient(circle at top, rgba(15,23,42,0.9), rgba(15,23,42,0.85));
    color: #e5e7eb;
  }

  .mz-mat-tag.muted {
    border-style: dashed;
    color: #9ca3af;
  }

  .mz-chip-mini {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 0.7rem;
    padding: 2px 6px;
    border-radius: 999px;
    border: 1px solid rgba(45,212,191,0.8);
    background: rgba(6,95,70,0.35);
    color: #a7f3d0;
    margin-top: 3px;
  }

  .mz-mat-actions {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    justify-content: flex-end;
  }

  @media (max-width: 720px) {
    .mz-mat-head {
      flex-direction: column;
      align-items: flex-start;
    }
    .mz-mat-actions {
      justify-content: flex-start;
    }
  }
    .mz-file-clear {
    margin-left: 6px;
    width: 18px;
    height: 18px;
    border-radius: 999px;
    border: 1px solid rgba(148,163,184,0.8);
    background: rgba(15,23,42,0.95);
    color: #e5e7eb;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    line-height: 1;
    cursor: pointer;
    padding: 0;
  }

  .mz-file-clear:hover {
    background: rgba(185,28,28,0.9);
    border-color: rgba(254,202,202,0.9);
    color: #fef2f2;
  }
/* === Physical receipt block === */
.mz-rec-card{
  margin-top: 14px;
  padding: 14px 14px 12px;
  border-radius: 14px;
  border: 1px solid rgba(148,163,184,0.55);
  background: radial-gradient(circle at top left, rgba(16,185,129,0.14), rgba(15,23,42,0.92));
}

.mz-rec-title{
  margin: 0 0 4px;
  font-size: .9rem;
  font-weight: 700;
  letter-spacing: .04em;
  text-transform: uppercase;
  color:#e5e7eb;
}

.mz-rec-sub{
  margin: 0 0 10px;
  font-size: .78rem;
  color:#9ca3af;
}

.mz-rec-grid{
  display:grid;
  gap:10px;
}

.mz-rec-row{
  display:flex;
  align-items:center;
  gap:10px;
  padding: 8px 10px;
  border-radius: 12px;
  border: 1px solid rgba(30,64,175,0.55);
  background: rgba(15,23,42,0.55);
}

.mz-rec-row input[type="checkbox"]{
  width: 16px;
  height: 16px;
}

.mz-rec-row.is-locked{
  opacity:.82;
  border-style:dashed;
}

.mz-rec-row.is-locked .mz-rec-hint{
  color:#a7f3d0;
}

.mz-rec-hint{
  font-size:.75rem;
  color:#9ca3af;
  margin-left:auto;
  white-space:nowrap;
}
/* === Modules dropdown (MF ‚Üí UF) === */
.mz-mod-dd {
  position: relative;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.mz-mod-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  border-radius: 999px;
  border: 1px solid rgba(148,163,184,0.55);
  background: rgba(15,23,42,0.85);
  color: #e5e7eb;
  cursor: pointer;
  font-size: .82rem;
  transition: transform 100ms ease, background 140ms ease, border-color 140ms ease;
  user-select: none;
}

.mz-mod-btn:hover {
  background: rgba(30,64,175,0.9);
  border-color: rgba(191,219,254,0.8);
  transform: translateY(-1px);
}

.mz-mod-menu {
  position: absolute;
  top: calc(100% + 8px);
  left: 0;
  z-index: 50;

  /* —à–∏—Ä–∏–Ω–∞ –±—É–¥–µ—Ç –∑–∞–¥–∞–≤–∞—Ç—å—Å—è JS –ø–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É */
  min-width: 260px;
  max-width: none;

  max-height: 320px;
  overflow: auto;
  padding: 8px;
  border-radius: 14px;
  border: 1px solid rgba(148,163,184,0.75);

  /* ‚úÖ –±–µ–∑ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã—Ö –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–≤ */
  background: #0b1220;

  box-shadow: 0 14px 38px rgba(0,0,0,0.55);
  display: none;
}

.mz-mod-menu.is-open { display: block; }

/* ‚úÖ –±–æ–ª–µ–µ ‚Äú—á–∏—Å—Ç—ã–π‚Äù —Å–∫—Ä–æ–ª–ª */
.mz-mod-menu::-webkit-scrollbar { width: 10px; }
.mz-mod-menu::-webkit-scrollbar-thumb {
  background: rgba(148,163,184,0.35);
  border-radius: 999px;
  border: 2px solid #0b1220;
}
.mz-mod-menu::-webkit-scrollbar-track { background: transparent; }


.mz-mod-group {
  padding: 6px;
  border-radius: 12px;
  border: 1px solid rgba(30,64,175,0.35);
  background: rgba(15,23,42,0.55);
  margin-bottom: 8px;
}

.mz-mod-group:last-child { margin-bottom: 0; }

.mz-mod-mf {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  padding: 6px 8px;
  border-radius: 10px;
  color: #e5e7eb;
  font-weight: 700;
  font-size: .82rem;
}

.mz-mod-uf {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  padding: 6px 8px 8px;
}

.mz-mod-link {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  border-radius: 999px;
  border: 1px solid rgba(148,163,184,0.45);
  background: rgba(15,23,42,0.75);
  color: #cbd5f5;
  text-decoration: none;
  font-size: .78rem;
  white-space: nowrap;
}

.mz-mod-link:hover {
  background: rgba(30,64,175,0.9);
  border-color: rgba(191,219,254,0.7);
  color: #f9fafb;
}

.mz-mod-link.is-act {
  background: radial-gradient(circle at top, #22d3ee, #3b82f6);
  border-color: rgba(248,250,252,0.9);
  color: #0b1120;
  box-shadow: 0 0 0 1px rgba(15,23,42,0.95), 0 8px 18px rgba(37,99,235,0.55);
}

@media (max-width: 720px) {
  .mz-mod-menu { min-width: 260px; max-width: 92vw; }
}
/* hide module select when auto-module is active */
.mz-upl-row .mz-upl-select.is-hidden { display:none; }
/* === Drag & Drop upload zone === */
.mz-drop {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px dashed rgba(148,163,184,0.65);
  background: rgba(15,23,42,0.55);
  cursor: pointer;
  user-select: none;
  transition: transform 120ms ease, background 140ms ease, border-color 140ms ease, box-shadow 140ms ease;
  min-width: 260px;
}

.mz-drop:hover{
  background: rgba(30,64,175,0.22);
  border-color: rgba(191,219,254,0.75);
  transform: translateY(-1px);
}

.mz-drop.is-over{
  background: rgba(34,211,238,0.18);
  border-color: rgba(34,211,238,0.85);
  box-shadow: 0 0 0 2px rgba(34,211,238,0.15);
}

.mz-drop-ico{
  width: 32px;
  height: 32px;
  border-radius: 10px;
  display:flex;
  align-items:center;
  justify-content:center;
  border: 1px solid rgba(148,163,184,0.45);
  background: rgba(15,23,42,0.75);
  color: #e5e7eb;
  flex: 0 0 auto;
}

.mz-drop-txt{
  min-width: 0;
  line-height: 1.15;
}

.mz-drop-title{
  color:#e5e7eb;
  font-size: .84rem;
  font-weight: 700;
}

.mz-drop-sub{
  color:#9ca3af;
  font-size: .74rem;
  margin-top: 2px;
}

.mz-drop-count{
  margin-left:auto;
  font-size: .72rem;
  padding: 2px 8px;
  border-radius: 999px;
  border: 1px solid rgba(148,163,184,0.45);
  background: rgba(15,23,42,0.75);
  color:#e5e7eb;
  white-space: nowrap;
}
/* === file download button look === */
.mz-file-link{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding: 6px 10px;
  border-radius: 12px;
  border: 1px solid rgba(148,163,184,0.55);
  background: rgba(15,23,42,0.75);
  color:#f9fafb;
  text-decoration:none;
  max-width: 100%;
  box-shadow: 0 0 0 1px rgba(15,23,42,0.6);
  transition: transform 120ms ease, background 140ms ease, border-color 140ms ease, box-shadow 140ms ease;
}

.mz-file-link:hover{
  background: rgba(30,64,175,0.28);
  border-color: rgba(191,219,254,0.75);
  box-shadow: 0 10px 22px rgba(0,0,0,0.35);
  transform: translateY(-1px);
}

.mz-file-ico{
  width: 28px;
  height: 28px;
  border-radius: 10px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  border: 1px solid rgba(148,163,184,0.45);
  background: rgba(15,23,42,0.85);
  font-size: 14px;
  flex: 0 0 auto;
}

.mz-file-name{
  min-width:0;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

.mz-file-dl{
  margin-left: 6px;
  font-size: .72rem;
  padding: 2px 8px;
  border-radius: 999px;
  border: 1px solid rgba(34,211,238,0.55);
  background: rgba(8,145,178,0.18);
  color: #a5f3fc;
  white-space: nowrap;
}

/* make title line allow button-like link + copy button */
.mz-mat-title-file{
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
}
/* chip –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É —Ñ–∞–π–ª–∞ */
.mz-mat-item{ position: relative; }

.mz-mat-item.has-file-chip .mz-mat-main{
  padding-right: 110px; /* —Ä–µ–∑–µ—Ä–≤ –ø–æ–¥ —á–∏–ø, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª –∑–∞–≥–æ–ª–æ–≤–∫—É/–∫–Ω–æ–ø–∫–∞–º */
}

.mz-file-chip{
  position:absolute;
  top:10px;
  right:10px;
  margin:0;            /* –≤–∞–∂–Ω–æ: —É —Ç–µ–±—è —Å–µ–π—á–∞—Å margin-top:3px */
  z-index:2;
  pointer-events:none; /* —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª –∫–ª–∏–∫–∞–º –ø–æ —Å—Å—ã–ª–∫–∞–º/–∫–Ω–æ–ø–∫–∞–º */
}

/* –≤–∞—Ä–∏–∞–Ω—Ç "–Ω–µ —Å–∫–∞—á–∞–Ω–æ" */
.mz-file-chip.is-undl{
  border-color: rgba(148,163,184,0.6);
  background: rgba(15,23,42,0.5);
  color: #e5e7eb;
}

.mz-mat-title-file .mz-file-name{
  font-weight: 700;
  color: #f9fafb;
  max-width: 100%;
}
/* ===== Action buttons (Descargar / Ver / Copiar) ===== */

.mzc-btn.ghost{
  background: radial-gradient(circle at top, rgba(30,41,59,.95), rgba(15,23,42,.98));
  border: 1px solid rgba(148,163,184,.55);
  color:#e5e7eb;

  box-shadow:
    0 2px 0 rgba(255,255,255,.05) inset,
    0 8px 18px rgba(0,0,0,.45);

  font-weight: 600;
}

/* hover ‚Äî —á—É—Ç—å ‚Äú–ø–æ–¥–Ω—è–ª–∞—Å—å‚Äù */
.mzc-btn.ghost:hover{
  transform: translateY(-2px);
  box-shadow:
    0 2px 0 rgba(255,255,255,.06) inset,
    0 14px 28px rgba(0,0,0,.55);

  border-color: rgba(191,219,254,.75);
  background: rgba(30,64,175,.85);
}

/* active ‚Äî –Ω–∞–∂–∞–ª–∏ */
.mzc-btn.ghost:active{
  transform: translateY(0);
  box-shadow:
    0 1px 0 rgba(0,0,0,.6) inset,
    0 3px 8px rgba(0,0,0,.6);
}
/* ===== Segmented buttons: keep active state visible ===== */

/* –æ–±—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π —Å—Ç–∏–ª—å (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –¥–ª—è –ª—é–±—ã—Ö ghost-–∫–Ω–æ–ø–æ–∫) */
.mzc-btn.ghost.is-act{
  background: radial-gradient(circle at top, #22d3ee, #3b82f6) !important;
  border-color: rgba(248,250,252,0.95) !important;
  color: #0b1120 !important;

  box-shadow:
    0 2px 0 rgba(255,255,255,.22) inset,
    0 10px 24px rgba(37,99,235,.55) !important;

  transform: none !important;
}

/* –µ—Å–ª–∏ —Å–µ–≥–º–µ–Ω—Ç —É —Ç–µ–±—è –≤–Ω—É—Ç—Ä–∏ .mz-seg ‚Äî –¥–µ–ª–∞–µ–º –µ—â—ë ‚Äú—Å–∏–ª—å–Ω–µ–µ‚Äù */
.mz-seg .mzc-btn.ghost.is-act{
  background: radial-gradient(circle at top, #22d3ee, #3b82f6) !important;
  border-color: rgba(248,250,252,0.95) !important;
  color: #0b1120 !important;
}

/* —á—Ç–æ–±—ã –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –∞–∫—Ç–∏–≤–Ω—É—é –Ω–µ —Å—Ç–∞–Ω–æ–≤–∏–ª–∞—Å—å "–æ–±—ã—á–Ω–æ–π" */
.mzc-btn.ghost.is-act:hover{
  background: radial-gradient(circle at top, #22d3ee, #3b82f6) !important;
  border-color: rgba(248,250,252,0.95) !important;
  color: #0b1120 !important;
  box-shadow:
    0 2px 0 rgba(255,255,255,.25) inset,
    0 16px 32px rgba(37,99,235,.7) !important;
  transform: translateY(-1px) !important;
}
/* ===== Upload CTA (–ø—Ä–∞–≤—ã–π –Ω–∏–∂–Ω–∏–π —É–≥–æ–ª –∫–∞—Ä—Ç–æ—á–∫–∏) ===== */
.mz-mat-card{
  position: relative;
  padding-bottom: 74px; /* –º–µ—Å—Ç–æ –ø–æ–¥ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª–∞ –∫–æ–Ω—Ç–µ–Ω—Ç */
}

.mz-upload-cta{
  position: sticky;
  top: 10px;          /* –¥–µ—Ä–∂–∏—Ç—Å—è –≤–≤–µ—Ä—Ö—É –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ –∫–∞—Ä—Ç–æ—á–∫–∏ */
  margin-left: auto;  /* —É–µ–¥–µ—Ç –≤–ø—Ä–∞–≤–æ */
  z-index: 5;

  display: inline-flex;

  padding: 12px 18px;
  border-radius: 14px;

  font-size: .92rem;
  font-weight: 800;
  letter-spacing: .02em;

  border: 1px solid rgba(34,211,238,.75);
  background: linear-gradient(180deg,#22d3ee,#3b82f6);
  color: #0b1120;

  box-shadow:
    0 2px 0 rgba(255,255,255,.25) inset,
    0 12px 26px rgba(37,99,235,.55);

  cursor: pointer;
  transition: transform .12s ease, box-shadow .15s ease, filter .15s ease;
}

.mz-upload-cta:hover{
  transform: translateY(-2px);
  box-shadow:
    0 2px 0 rgba(255,255,255,.28) inset,
    0 18px 36px rgba(37,99,235,.75);
  filter: saturate(1.05);
}

.mz-upload-cta:active{
  transform: translateY(0);
  box-shadow:
    0 1px 0 rgba(0,0,0,.35) inset,
    0 6px 14px rgba(0,0,0,.45);
}

/* –º–æ–±–∏–ª–∫–∞ ‚Äî –∫–Ω–æ–ø–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π */
@media (max-width:720px){
  .mz-mat-card{ padding-bottom: 14px; }
  .mz-upload-cta{
    position: static;
    width: 100%;
    margin-top: 10px;
  }
}
.mz-fold-bc{ margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
.mz-bc{ color:#e5e7eb; text-decoration:none; font-size:.82rem; padding:4px 10px; border-radius:999px;
  border:1px solid rgba(148,163,184,.45); background:rgba(15,23,42,.75); }
.mz-bc:hover{ background:rgba(30,64,175,.35); border-color:rgba(191,219,254,.65); }
.mz-bc-sep{ opacity:.5; color:#9ca3af; }
.mz-mat-item[draggable="true"]{ cursor: grab; }
.mz-mat-item.is-dragging{ opacity:.55; transform: scale(.995); }

.mz-fold-item.is-drop-ok{
  outline: 2px solid rgba(34,211,238,.65);
  box-shadow: 0 0 0 3px rgba(34,211,238,.12);
}
.mz-fold-item.is-drop-bad{
  outline: 2px solid rgba(248,113,113,.65);
  box-shadow: 0 0 0 3px rgba(248,113,113,.12);
}
.mz-fold-item.is-locked{ opacity:.75; }

</style>

<div class="mzc-card mz-mat-card">
  <div class="mz-mat-head">
    <div>
      <h4 class="mz-mat-title">Materiales</h4>
      <p class="mz-mat-sub">Archivos y recursos asociados al curso.</p>
    </div>
    {% if files %}
      <div class="mz-mat-count">
        {{ files|length }} archivo{{ files|length|pluralize:"s" }}
      </div>
    {% endif %}


  </div>

  {# ---- –≤–µ—Ä—Ö–Ω–∏–π –±–∞—Ä: alumnos / docentes / mis ---- #}
  {% if is_teacher %}
    <div class="mz-mat-audience">
      <div class="mz-seg">
        {% for key,label in audience_options %}
			<a href="?tab=materiales
				&aud={{ key }}
				&p={{ current_path|urlencode }}
				&mod={{ selected_mod|default:''|urlencode }}
			&sort={{ sort|default:'new'|urlencode }}"
			   class="mzc-btn ghost{% if audience == key %} is-act{% endif %}"
			   data-action="materials.audience"
			   data-aud="{{ key }}">
			  {{ label }}
			</a>

        {% endfor %}
      </div>
    </div>
  {% endif %}

{# ---- —Ñ–∏–ª—å—Ç—Ä –ø–æ –º–æ–¥—É–ª—é (–∫–æ–º–ø–∞–∫—Ç–Ω–æ) ---- #}
<div class="mz-mat-modfilters" data-selected-mod="{{ selected_mod|default:'' }}">
  <a href="?tab=materiales&aud={{ audience }}&p={{ current_path|urlencode }}&sort={{ sort }}"
     class="mz-pill{% if not selected_mod %} is-act{% endif %}"
     data-action="materials.filter"
     data-mod="">
    Todos{% if total_files %} ¬∑ {{ total_files }}{% endif %}
  </a>

<a href="?tab=materiales&aud={{ audience }}&p={{ current_path|urlencode }}&mod=none&sort={{ sort }}"
     class="mz-pill{% if selected_mod == 'none' %} is-act{% endif %}"
     data-action="materials.filter"
     data-mod="none">
    Sin m√≥dulo{% if none_count %} ¬∑ {{ none_count }}{% endif %}
  </a>

  {# dropdown MF ‚Üí UF #}
  <div class="mz-mod-dd" id="mz-mod-dd">
    <div class="mz-mod-btn" id="mz-mod-btn" role="button" tabindex="0">
      <span>Modulos</span>
      <span style="opacity:.75;font-size:.75rem">
        {% if selected_mod and selected_mod != 'none' %}¬∑ {{ selected_mod }}{% else %}¬∑ todos{% endif %}
      </span>
      <span style="opacity:.8">‚ñæ</span>
    </div>

    <div class="mz-mod-menu" id="mz-mod-menu">
      {# fallback: –µ—Å–ª–∏ –Ω–µ—Ç –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏, –ø–æ–∫–∞–∂–µ–º –ø–ª–æ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫ #}
      {% if mod_groups %}
        {# mod_groups: [{mf:'MF1', items:[{name:'UF1',count:3}, ...]}, ...] #}
        {% for g in mod_groups %}
          <div class="mz-mod-group">
            <div class="mz-mod-mf">
              <span>{{ g.mf }}</span>
              <span style="font-size:.74rem;opacity:.75">{{ g.total|default:'' }}</span>
            </div>
            <div class="mz-mod-uf">
              {% for it in g.items %}
                <a class="mz-mod-link{% if selected_mod == it.name %} is-act{% endif %}"
                   href="?tab=materiales&aud={{ audience }}&p={{ current_path|urlencode }}&mod={{ it.name|urlencode }}&sort={{ sort }}"
                   data-action="materials.filter"
                   data-mod="{{ it.name }}">
                  {{ it.name }}{% if it.count %} ¬∑ {{ it.count }}{% endif %}
                </a>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="mz-mod-group">
          <div class="mz-mod-mf"><span>Listado</span></div>
          <div class="mz-mod-uf">
            {% for m in mods_with_counts %}
              <a class="mz-mod-link{% if selected_mod == m.name %} is-act{% endif %}"
                 href="?tab=materiales&aud={{ audience }}&mod={{ m.name|urlencode }}"
                 data-action="materials.filter"
                 data-mod="{{ m.name }}">
                {{ m.name }}{% if m.count %} ¬∑ {{ m.count }}{% endif %}
              </a>
            {% endfor %}
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>





  {# ---- —Ñ–æ—Ä–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (—Ç–æ–ª—å–∫–æ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å) ---- #}
  {% if is_teacher %}

    <div class="mz-upl-wrap"  data-focus="upload">
<form id="mz-upload-form" method="post" enctype="multipart/form-data" class="mz-upl">
  {% csrf_token %}
  <input type="hidden" name="upload" value="1">
  <input type="hidden" name="folder_path" value="{{ current_path }}">
  <input type="hidden" name="tipo"
         value="{% if audience == 'docentes' %}docentes{% elif audience == 'mis' %}privado{% else %}alumnos{% endif %}">

  <!-- ===== –°–ï–ö–¶–ò–Ø 1: –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã ===== -->
  <div class="mz-upl-section" data-upl="files">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
      <div style="font-weight:800;color:#e5e7eb">üìé Subir archivos</div>
      <div style="font-size:.78rem;color:#9ca3af">Arrastra/suelta o selecciona varios</div>
    </div>

    <div id="mz-upl-rows" class="mz-upl-rows">
      <div class="mz-upl-row" data-row-idx="1">

        <div class="mz-drop" data-role="dropzone" title="Arrastra archivos aqu√≠ o haz clic">
          <div class="mz-drop-ico">‚¨Ü</div>
          <div class="mz-drop-txt">
            <div class="mz-drop-title" data-role="droplabel">Arrastra y suelta archivos</div>
            <div class="mz-drop-sub" data-role="dropsub">o haz clic para seleccionarlos (multi)</div>
          </div>
          <div class="mz-drop-count" data-role="dropcount">0</div>

          <button type="button"
                  class="mz-file-clear"
                  data-role="dropclear"
                  title="Quitar selecci√≥n"
                  style="margin-left:0">√ó</button>
        </div>

        <input type="file"
               name="file_1"
               data-role="file"
               class="mz-upl-input"
               style="display:none"
               multiple>

        <input type="text"
               name="title_1"
               data-role="title"
               class="mz-upl-input"
               placeholder="T√≠tulo (opcional)">

        <input type="hidden" name="module_key_1" data-role="module_key" value="">

        <button type="button"
                class="mz-file-clear mz-upl-remove-row"
                title="Quitar fila"
                data-action="materials.upload.row.remove">√ó</button>
      </div>
    </div>
  </div>

  <!-- ===== –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å ===== -->
  <div style="margin:12px 0;display:flex;align-items:center;gap:10px">
    <div style="height:1px;flex:1;background:rgba(148,163,184,.25)"></div>
    <div style="font-size:.78rem;color:#9ca3af;white-space:nowrap">o</div>
    <div style="height:1px;flex:1;background:rgba(148,163,184,.25)"></div>
  </div>

  <!-- ===== –°–ï–ö–¶–ò–Ø 2: –ü–æ —Å—Å—ã–ª–∫–µ ===== -->
  <div class="mz-upl-section" data-upl="url">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
      <div style="font-weight:800;color:#e5e7eb">üîó Subir por URL</div>
      <div style="font-size:.78rem;color:#9ca3af">Enlace directo a un archivo</div>
    </div>

    <div class="mz-upl-row" style="width:100%">
      <input type="url"
             name="url_1"
             data-role="url"
             class="mz-upl-input"
             placeholder="https://..."
             style="flex:1;min-width:320px">

      <input type="text"
             name="url_title_1"
             data-role="url_title"
             class="mz-upl-input"
             placeholder="T√≠tulo (opcional)"
             style="min-width:220px">

      <input type="hidden" name="url_module_key_1" data-role="url_module_key" value="">
    </div>
  </div>
</form>

<!-- –ö–Ω–æ–ø–∫–∞ —Å–∞–±–º–∏—Ç–∞ –ª—É—á—à–µ –¥–µ—Ä–∂–∞—Ç—å —Å—Ä–∞–∑—É –ø–æ–¥ —Å–µ–∫—Ü–∏—è–º–∏ (–Ω–µ –≤–Ω–∏–∑—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã) -->
<button type="submit"
        form="mz-upload-form"
        id="mzf-send"
        class="mz-upload-cta">
  ‚¨Ü Subir
</button>

    </div>
  {% endif %}

<div class="mz-mat-sort" style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center">
  <span style="font-size:.78rem; color:#9ca3af; margin-right:6px;">Orden:</span>

  <a href="?tab=materiales&aud={{ audience }}&p={{ current_path|urlencode }}&mod={{ selected_mod|default:''|urlencode }}&sort=new"
     class="mz-pill{% if sort == 'new' %} is-act{% endif %}">Nuevos</a>

  <a href="?tab=materiales&aud={{ audience }}&p={{ current_path|urlencode }}&mod={{ selected_mod|default:''|urlencode }}&sort=old"
     class="mz-pill{% if sort == 'old' %} is-act{% endif %}">Antiguos</a>

  <a href="?tab=materiales&aud={{ audience }}&p={{ current_path|urlencode }}&mod={{ selected_mod|default:''|urlencode }}&sort=az"
     class="mz-pill{% if sort == 'az' %} is-act{% endif %}">A‚ÄìZ</a>

  <a href="?tab=materiales&aud={{ audience }}&p={{ current_path|urlencode }}&mod={{ selected_mod|default:''|urlencode }}&sort=za"
     class="mz-pill{% if sort == 'za' %} is-act{% endif %}">Z‚ÄìA</a>
</div>
{% if current_path %}
  <div class="mz-fold-bc" id="mz-fold-bc"
       data-path="{{ current_path|escape }}"
       data-aud="{{ audience }}"
       data-mod="{{ selected_mod|default:''|escape }}"
       data-sort="{{ sort|default:'new'|escape }}">
    <a class="mz-bc" href="?tab=materiales&aud={{ audience }}&p=&mod={{ selected_mod|default:''|urlencode }}&sort={{ sort }}">üè† Inicio</a>
  </div>
{% endif %}

{% if folders %}
  <div class="mz-fold-grid">
  {% if is_teacher %}
  <div class="mz-fold-item" data-drop-folder="">
    <a class="mz-fold-link"
       href="?tab=materiales&aud={{ audience }}&p=&mod={{ selected_mod|default:''|urlencode }}&sort={{ sort }}">
      üè† Ra√≠z (sin carpeta)
    </a>
  </div>
{% endif %}
    {% for fld in folders %}
      <div class="mz-fold-item{% if fld.is_locked %} is-locked{% endif %}"
     {% if is_teacher %}
       data-drop-folder="{{ fld.path }}"
     {% endif %}
>

        <a class="mz-fold-link"
           href="?tab=materiales&aud={{ audience }}&p={{ fld.path|urlencode }}&mod={{ selected_mod|default:''|urlencode }}&sort={{ sort }}">
          üìÅ {{ fld.name }}
          {% if fld.is_locked %}<span class="mz-chip-mini">M√≥dulo</span>{% endif %}
        </a>

        {% if is_teacher and not fld.is_locked %}
          <form method="post" style="margin:0" onsubmit="return confirm('¬øEliminar carpeta?');">
            {% csrf_token %}
            <input type="hidden" name="action" value="folder_delete">
            <input type="hidden" name="path" value="{{ fld.path }}">
            <button class="mzc-btn ghost" type="submit">Eliminar</button>
          </form>
        {% endif %}
      </div>
    {% endfor %}
  </div>
{% else %}
  <div class="mzc-note">No hay carpetas aqu√≠.</div>
{% endif %}
{% if is_teacher %}
  <form method="post" class="mz-fold-create" style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
    {% csrf_token %}
    <input type="hidden" name="action" value="folder_create">
    <input class="mz-upl-input" name="folder_name" placeholder="Nueva carpeta" style="min-width:220px">
    <button class="mzc-btn" type="submit">Crear</button>
  </form>
{% endif %}

  {# ---- —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ ---- #}
  <ul class="mz-mat-list">
    {% if files %}
      {% for f in files %}
        <li class="mz-mat-item{% if not is_teacher %} has-file-chip{% endif %}"
    {% if is_teacher %}
      draggable="true"
      data-drag-file="{{ f.id }}"
    {% endif %}
>
  {% if not is_teacher %}
    {% if f.is_downloaded %}
      <div class="mz-chip-mini mz-file-chip">Descargado</div>
    {% else %}
      <div class="mz-chip-mini mz-file-chip is-undl">No descargado</div>
    {% endif %}
  {% endif %}
          <div class="mz-mat-main">
<p class="mz-mat-title-file">
  <span class="mz-file-name">{{ f.title|default:f.filename }}</span>

  <a class="mzc-btn ghost"
     href="{% url 'panel:material_download' f.id %}"
     target="_blank" rel="noopener"
     title="Descargar archivo">
    Descargar
  </a>

  <a class="mzc-btn ghost"
     data-preview
     data-ext="{{ f.ext|lower }}"
     data-name="{{ f.title|default:f.filename|escape }}"
     href="{% url 'panel:material_download' f.id %}?inline=1">
    Ver
  </a>

  {% if is_teacher %}
    <button class="mzc-btn ghost" type="button"
            data-action="materials.copy_public_link"
            data-share-url="{% url 'panel:material_share_link_create' f.id %}">
      Copiar enlace
    </button>
  {% endif %}
</p>



            <div class="mz-mat-meta">
              <span>{{ f.ext|upper }}</span>
              <span class="mz-mat-dot"></span>
              <span>{{ f.fmt_size }}</span>
              <span class="mz-mat-dot"></span>
              <span>{{ f.uploaded_by.get_full_name|default:f.uploaded_by.email }}</span>
              {% if f.module_key %}
                <span class="mz-mat-dot"></span>
                <span class="mz-mat-tag">{{ f.module_key }}</span>
              {% else %}
                <span class="mz-mat-dot"></span>
                <span class="mz-mat-tag muted">Sin m√≥dulo</span>
              {% endif %}
            </div>

            {% if is_teacher and f.share_alumnos %}
              <div class="mz-chip-mini">
                Visible para alumnos
              </div>
            {% endif %}
          </div>

          {% if is_teacher %}
            <div class="mz-mat-actions">
{% if audience != 'alumnos' %}
  <form method="post" style="margin:0">
    {% csrf_token %}
    <input type="hidden" name="share_id" value="{{ f.id }}">
    <button class="mzc-btn ghost" type="submit"
            data-action="materials.share.toggle"
            data-file-id="{{ f.id }}">
      {% if f.share_alumnos %}Ocultar de alumnos{% else %}Mostrar a alumnos{% endif %}
    </button>
  </form>
{% endif %}
              {% if f.tipo == "docentes" %}
                <form method="post" style="margin:0">
                  {% csrf_token %}
                  <input type="hidden" name="copy_id" value="{{ f.id }}">
 <button class="mzc-btn ghost" type="submit"
        data-action="materials.copy.to_private"
        data-file-id="{{ f.id }}">
  Copiar a privados
</button>

                </form>
              {% endif %}

              <form method="post" style="margin:0"
                    onsubmit="return confirm('¬øEliminar este archivo?');">
                {% csrf_token %}
                <input type="hidden" name="delete_id" value="{{ f.id }}">
                <button class="mzc-btn ghost" type="submit">
                  Eliminar
                </button>
				
              </form>
            </div>
          {% endif %}
        </li>
      {% endfor %}
    {% else %}
      <li class="mzc-note">No hay materiales a√∫n.</li>
    {% endif %}
  </ul>
  
  {% if is_teacher %}
  <div class="mz-rec-card" style="border-color:rgba(191,219,254,0.35);background:radial-gradient(circle at top left, rgba(59,130,246,0.18), rgba(15,23,42,0.92));">
    <h4 class="mz-rec-title">As√≠ lo ven los alumnos</h4>
    <p class="mz-rec-sub">Lista r√°pida de materiales visibles para alumnos (sin cambiar de pesta√±as).</p>

</div>

    {% if student_visible_files %}
      <ul class="mz-mat-list" style="margin-top:10px">
        {% for f in student_visible_files %}
          <li class="mz-mat-item" style="border-color:rgba(34,211,238,0.35)">
            <div class="mz-mat-main">
              <p class="mz-mat-title-file" style="margin-bottom:4px">
                <a href="{% url 'panel:material_download' f.id %}" target="_blank" rel="noopener">
                  {{ f.title|default:f.filename }}
                </a>
              </p>
              <div class="mz-mat-meta">
                <span>{{ f.ext|upper }}</span>
                <span class="mz-mat-dot"></span>
                <span>{{ f.fmt_size }}</span>
                <span class="mz-mat-dot"></span>
                {% if f.module_key %}
                  <span class="mz-mat-tag">{{ f.module_key }}</span>
                {% else %}
                  <span class="mz-mat-tag muted">Sin m√≥dulo</span>
                {% endif %}
              </div>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="mzc-note">Ahora mismo no hay archivos visibles para alumnos.</div>
    {% endif %}
  </div>
{% endif %}

	{% if is_teacher %}
	  <div class="mz-rec-card" data-focus="receipts">
		<h4 class="mz-rec-title">Material f√≠sico del curso</h4>
		<p class="mz-rec-sub">Crea y gestiona la lista por curso. Los alumnos solo ver√°n los elementos ‚Äúactivos‚Äù.</p>

		{# --- ADD NEW ITEM --- #}
		<form method="post" style="margin:0 0 10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center">
		  {% csrf_token %}
		  <input type="hidden" name="action" value="physical_item_add">
			<input class="mz-upl-input" name="label" placeholder="Nombre (ej: Cuaderno)" style="min-width:220px">
		  <button class="mzc-btn" type="submit">A√±adir</button>

		  <div class="mz-rec-hint" style="margin-left:auto; white-space:nowrap">
			Activos: {{ physical_items_enabled|length }} / {{ physical_items_all|length }}
		  </div>
		</form>

{# --- LIST + EDIT --- #}
{% if physical_items_all %}
  <div class="mz-rec-grid">
    {% for it in physical_items_all %}
      <div class="mz-rec-row" style="align-items:flex-start">

        {# update form #}
        <form method="post"
              style="margin:0; display:flex; gap:10px; flex-wrap:wrap; align-items:center; width:100%">
          {% csrf_token %}
          <input type="hidden" name="action" value="physical_item_update">
          <input type="hidden" name="item_id" value="{{ it.id }}">

          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; width:100%">
            <label style="display:flex; align-items:center; gap:8px">
              <input type="checkbox" name="is_enabled" {% if it.is_enabled %}checked{% endif %}>
              <span style="color:#e5e7eb;font-size:.86rem;font-weight:700">Activo</span>
            </label>

            <input class="mz-upl-input"
                   name="label"
                   value="{{ it.label }}"
                   style="min-width:240px; flex:1"
                   placeholder="Nombre visible">

            <button class="mzc-btn ghost" type="submit">Guardar</button>

            {# ‚úÖ download docx —Ä—è–¥–æ–º —Å Guardar #}
            <button type="button"
                    class="mzc-btn ghost"
                    data-action="mz.download.acta"
                    data-codigo="{{ curso.codigo }}"
                    data-item-key="{{ it.key }}"
                    {% if not it.is_enabled %}title="Desactivado (aun as√≠ puedes descargar)"{% endif %}>
              Descargar DOCX
            </button>
          </div>
        </form>

        {# delete form #}
        <form method="post" style="margin:0"
              onsubmit="return confirm('¬øEliminar este material f√≠sico del curso?');">
          {% csrf_token %}
          <input type="hidden" name="action" value="physical_item_delete">
          <input type="hidden" name="item_id" value="{{ it.id }}">
          <button class="mzc-btn ghost" type="submit">Eliminar</button>
        </form>

      </div>
    {% endfor %}
  </div>
{% else %}
  <div class="mzc-note">A√∫n no hay materiales f√≠sicos para este curso.</div>
{% endif %}

  {% endif %}

  
{% if not is_teacher and physical_items_enabled and not receipt_all_done %}
  <div class="mz-rec-card">
    <h4 class="mz-rec-title">Material f√≠sico recibido</h4>
    <p class="mz-rec-sub">Confirma solo una vez. Despu√©s queda bloqueado para la trazabilidad (Lanbide).</p>

    <form method="post" style="margin:0">
      {% csrf_token %}
      <input type="hidden" name="action" value="receipt_save">

      <div class="mz-rec-grid">
  {% for item in physical_items_enabled %}
          <label class="mz-rec-row{% if item.key in receipt_locked_keys %} is-locked{% endif %}">
            <input type="checkbox"
                   name="receipt_{{ item.key }}"
                   {% if item.key in receipt_keys %}checked{% endif %}
                   {% if item.key in receipt_locked_keys %}disabled{% endif %}>

            <div style="min-width:0">
              <div style="color:#e5e7eb;font-size:.86rem">{{ item.label }}</div>

              {% if item.key in receipt_locked_keys %}
                <div class="mz-rec-hint">Confirmado ¬∑ bloqueado</div>
              {% else %}
                <div class="mz-rec-hint">Pendiente</div>
              {% endif %}
            </div>

            {% if item.key in receipt_keys %}
              <span class="mz-chip-mini">Confirmado</span>
            {% endif %}
          </label>
        {% endfor %}
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <button class="mzc-btn" type="submit">Confirmar</button>
      </div>
    </form>
  </div>
{% endif %}

</div>

<div id="mz-preview" class="mz-prev is-hidden" aria-hidden="true">
  <div class="mz-prev-backdrop" data-close></div>
  <div class="mz-prev-card" role="dialog" aria-modal="true">
    <div class="mz-prev-head">
      <div class="mz-prev-title" id="mz-prev-title">Vista previa</div>
      <div class="mz-prev-actions">
        <a class="mzc-btn ghost" id="mz-prev-open" target="_blank" rel="noopener">Abrir</a>
        <button class="mzc-btn ghost" type="button" data-close>Cerrar</button>
      </div>
    </div>

    <div class="mz-prev-body" id="mz-prev-body">
      <!-- —Å—é–¥–∞ –ø–æ–¥—Å—Ç–∞–≤–∏–º iframe –∏–ª–∏ img -->
    </div>
  </div>
</div>

<script>
(function(){
  const dd = document.getElementById('mz-mod-dd');
  const btn = document.getElementById('mz-mod-btn');
  const menu = document.getElementById('mz-mod-menu');
  if (!dd || !btn || !menu) return;

function calcMenuWidth(){
  // –≤—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –∏–∑–º–µ—Ä–∏—Ç—å
  const wasOpen = menu.classList.contains('is-open');
  if (!wasOpen) {
    menu.style.visibility = 'hidden';
    menu.classList.add('is-open');
  }

  // –∏–∑–º–µ—Ä—è–µ–º —Å–∞–º—É—é —à–∏—Ä–æ–∫—É—é —Å—Å—ã–ª–∫—É
  let maxW = 0;
  menu.querySelectorAll('a').forEach(a => {
    maxW = Math.max(maxW, a.scrollWidth);
  });

  // + –ø–∞–¥–¥–∏–Ω–≥–∏ + –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–ø–∞—Å
  const padding = 32; // –∑–∞–ø–∞—Å –ø–æ–¥ padding/–≥—Ä–∞–Ω–∏—Ü—ã
  const target = Math.ceil(maxW + padding);

  // –Ω–µ —É–∂–µ –∫–Ω–æ–ø–∫–∏
  const btnW = btn.getBoundingClientRect().width;
  const finalW = Math.max(target, Math.ceil(btnW), 260);

  menu.style.width = finalW + 'px';

  if (!wasOpen) {
    menu.classList.remove('is-open');
    menu.style.visibility = '';
  }
}

function open(){
  calcMenuWidth();
  menu.classList.add('is-open');
}
function close(){ menu.classList.remove('is-open'); }
function toggle(){
  if (menu.classList.contains('is-open')) close();
  else open();
}


  btn.addEventListener('click', function(e){ e.preventDefault(); toggle(); });
  btn.addEventListener('keydown', function(e){
    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggle(); }
    if (e.key === 'Escape') close();
  });

  document.addEventListener('click', function(e){
    if (!dd.contains(e.target)) close();
  });

  // close after selecting a module
  menu.addEventListener('click', function(e){
    const a = e.target.closest('a[data-mod]');
    if (a) close();
  });
})();
</script>

<script>
(function(){
  const filters = document.querySelector('.mz-mat-modfilters[data-selected-mod]');
  if (!filters) return;

  const selected = (filters.getAttribute('data-selected-mod') || '').trim();

  // –µ—Å–ª–∏ –º–æ–¥—É–ª—å –Ω–µ –≤—ã–±—Ä–∞–Ω –∏–ª–∏ –≤—ã–±—Ä–∞–Ω–æ "none" ‚Üí –æ—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ (= "Sin m√≥dulo")
  if (!selected || selected === 'none') return;

  const rowsContainer = document.getElementById('mz-upl-rows');
  if (!rowsContainer) return;

  function applyToRow(row){
    const mk = row.querySelector('[data-role="module_key"]');
    if (!mk) return;
    mk.value = selected; // hidden input
  }

  function applyAll(){
    rowsContainer.querySelectorAll('.mz-upl-row').forEach(applyToRow);
  }

  applyAll();

  const mo = new MutationObserver(function(muts){
    for (const m of muts) {
      if (m.type === 'childList' && m.addedNodes && m.addedNodes.length) {
        applyAll();
        break;
      }
    }
  });
  mo.observe(rowsContainer, { childList:true });
})();
</script>
<script>
(function() {
  const rowsContainer = document.getElementById('mz-upl-rows');
  if (!rowsContainer) return;

  function setSingleFile(input, file){
    const dt = new DataTransfer();
    dt.items.add(file);
    input.files = dt.files;
  }

  function clearFileInput(input){
    try { input.value = ''; } catch(e) {}
    // –Ω–∞ –≤—Å—è–∫–∏–π ‚Äî —Å–±—Ä–æ—Å–∏–º —á–µ—Ä–µ–∑ DataTransfer
    const dt = new DataTransfer();
    input.files = dt.files;
  }

  function addRowFromTemplate(){
    const template = rowsContainer.children[0];
    if (!template) return null;

    const idx = rowsContainer.children.length + 1;
    const clone = template.cloneNode(true);

    // —É–±—Ä–∞—Ç—å dropzone –∏–∑ –∫–ª–æ–Ω–æ–≤
    const dz = clone.querySelector('[data-role="dropzone"]');
    if (dz) dz.remove();

    // –ø–æ–∫–∞–∑–∞—Ç—å file input (–≤ —à–∞–±–ª–æ–Ω–µ –æ–Ω hidden)
    const fileInput = clone.querySelector('[data-role="file"]');
    if (fileInput) fileInput.style.display = '';

    clone.setAttribute('data-row-idx', String(idx));

    clone.querySelectorAll('[data-role]').forEach(function(el) {
      const role = el.getAttribute('data-role');
      if (!role) return;
      el.name = role + '_' + idx;

      if (role === 'file') {
        el.value = '';
        el.removeAttribute('multiple');
      }
      if (role === 'title') el.value = '';
      if (role === 'module_key') el.value = '';
    });

    rowsContainer.appendChild(clone);

    // –∫–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
    const removeBtn = clone.querySelector('.mz-upl-remove-row');
    if (removeBtn) {
      removeBtn.addEventListener('click', function(e) {
        e.preventDefault();
        clone.remove();
      });
    }

    return clone;
  }

  const firstRow = rowsContainer.querySelector('.mz-upl-row');
  if (!firstRow) return;

  const firstFileInput = firstRow.querySelector('[data-role="file"]');
  if (!firstFileInput) return;

  const dropLabel = firstRow.querySelector('[data-role="droplabel"]');
  const dropSub   = firstRow.querySelector('[data-role="dropsub"]');
  const countEl   = firstRow.querySelector('[data-role="dropcount"]');
  const clearBtn  = firstRow.querySelector('[data-role="dropclear"]');

  function resetDropUI(){
    if (dropLabel) dropLabel.textContent = 'Arrastra y suelta archivos';
    if (dropSub) dropSub.textContent = 'o haz clic para seleccionarlos (multi)';
    if (countEl) countEl.textContent = '0';
  }

  // ‚ùóÔ∏è–ü–ï–†–ï–ù–û–°–ò–ú –í–°–ï —Ñ–∞–π–ª—ã –∏–∑ drop input –≤ —Å—Ç—Ä–æ–∫–∏ (–≤–∫–ª—é—á–∞—è –ø–µ—Ä–≤—ã–π)
  function moveFilesToRows(files){
    if (!files || !files.length) return;

    // —Å–æ–∑–¥–∞—ë–º —Å—Ç—Ä–æ–∫–∏ –ø–æ–¥ –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª
    for (let i = 0; i < files.length; i++) {
      const row = addRowFromTemplate();
      if (!row) break;
      const inp = row.querySelector('[data-role="file"]');
      if (inp) setSingleFile(inp, files[i]);
    }

    // –æ—á–∏—â–∞–µ–º drop input, —á—Ç–æ–±—ã –æ–Ω –Ω–µ "–¥–µ—Ä–∂–∞–ª" –ø–µ—Ä–≤—ã–π —Ñ–∞–π–ª
    clearFileInput(firstFileInput);
    resetDropUI();
  }

  firstFileInput.addEventListener('change', function(){
    const files = Array.from(firstFileInput.files || []);
    if (!files.length) { resetDropUI(); return; }

    // –æ–±–Ω–æ–≤–∏–º UI –Ω–∞ —Å–µ–∫—É–Ω–¥—É (–µ—Å–ª–∏ —Ö–æ—á–µ—à—å –≤–∏–¥–µ—Ç—å –∏–º—è –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–Ω–æ—Å–æ–º)
    if (countEl) countEl.textContent = String(files.length);
    if (dropLabel) dropLabel.textContent = files.length === 1 ? files[0].name : `${files.length} archivos`;
    if (dropSub) dropSub.textContent = files.length > 1 ? 'Se repartir√°n en filas abajo' : 'Se a√±adir√° una fila abajo';

    // –ø–µ—Ä–µ–Ω–æ—Å–∏–º –í–°–ï —Ñ–∞–π–ª—ã –≤ –æ–±—ã—á–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
    moveFilesToRows(files);
  });

  // –∫–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å)
  if (clearBtn){
    clearBtn.addEventListener('click', function(e){
      e.preventDefault();
      e.stopPropagation();
      clearFileInput(firstFileInput);
      resetDropUI();
    });
  }

  // —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –≤–∏–¥
  resetDropUI();
})();
</script>

<script>
(function(){
  const rowsContainer = document.getElementById('mz-upl-rows');
  if (!rowsContainer) return;

  const firstRow = rowsContainer.querySelector('.mz-upl-row');
  if (!firstRow) return;

  const drop = firstRow.querySelector('[data-role="dropzone"]');
  const countEl = firstRow.querySelector('[data-role="dropcount"]');
  const input = firstRow.querySelector('[data-role="file"]');

  if (!drop || !input) return;

  // –∫–ª–∏–∫ –ø–æ –∑–æ–Ω–µ -> –æ—Ç–∫—Ä—ã—Ç—å –¥–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞
  drop.addEventListener('click', function(){
    input.click();
  });

  function setCount(n){
    if (countEl) countEl.textContent = String(n || 0);
  }

  // –µ—Å–ª–∏ –≤—ã–±—Ä–∞–ª–∏ —á–µ—Ä–µ–∑ –¥–∏–∞–ª–æ–≥ ‚Äî –æ–±–Ω–æ–≤–∏–º –±–µ–π–¥–∂
  input.addEventListener('change', function(){
    setCount((input.files && input.files.length) || 0);
  });

  // drag events
  const stop = (e) => { e.preventDefault(); e.stopPropagation(); };

  ['dragenter','dragover'].forEach(evt=>{
    drop.addEventListener(evt, function(e){
      stop(e);
      drop.classList.add('is-over');
    });
  });

  ['dragleave','dragend','drop'].forEach(evt=>{
    drop.addEventListener(evt, function(e){
      stop(e);
      drop.classList.remove('is-over');
    });
  });

  drop.addEventListener('drop', function(e){
    stop(e);
    const files = e.dataTransfer && e.dataTransfer.files ? e.dataTransfer.files : null;
    if (!files || !files.length) return;

    // –∫–ª–∞–¥—ë–º FileList –≤ input —á–µ—Ä–µ–∑ DataTransfer
    const dt = new DataTransfer();
    for (const f of files) dt.items.add(f);
    input.files = dt.files;

    setCount(dt.files.length);

    // –≤–∞–∂–Ω–æ: —Ç—Ä–∏–≥–≥–µ—Ä–∏–º change -> —Ç–≤–æ–π —Å–∫—Ä–∏–ø—Ç —Ä–∞–∑–ª–æ–∂–∏—Ç –ø–æ —Å—Ç—Ä–æ–∫–∞–º
    input.dispatchEvent(new Event('change', { bubbles: true }));
  });
})();
</script>
<script>
(function(){
  const form = document.getElementById('mz-upload-form');
  if (!form) return;

  const rows = document.getElementById('mz-upl-rows');
  const urlInp = form.querySelector('input[data-role="url"]');

  const firstRow = rows ? rows.querySelector('.mz-upl-row') : null;
  const drop = firstRow ? firstRow.querySelector('[data-role="dropzone"]') : null;

  function anyFileSelected(){
    const inputs = form.querySelectorAll('input[type="file"][data-role="file"]');
    for (const inp of inputs){
      if (inp.files && inp.files.length) return true;
    }
    return false;
  }

  function hasUrl(){
    return !!(urlInp && urlInp.value && urlInp.value.trim().length);
  }

  form.addEventListener('submit', function(e){
    if (anyFileSelected() || hasUrl()) return;

    e.preventDefault();
    if (drop){
      drop.classList.add('is-over');
      setTimeout(()=>drop.classList.remove('is-over'), 350);
    }
    alert('Sube un archivo o pega una URL.');
  });
})();
</script>

<script>
(function(){
  async function copyToClipboard(text){
    try{
      await navigator.clipboard.writeText(text);
      return true;
    }catch(e){
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'fixed';
      ta.style.left = '-9999px';
      document.body.appendChild(ta);
      ta.select();
      try { document.execCommand('copy'); } catch(_){}
      document.body.removeChild(ta);
      return true;
    }
  }

  async function postJSON(url){
    if (url && !url.endsWith('/')) url += '/'; // ‚úÖ APPEND_SLASH safe
    const r = await fetch(url, {
      method: 'POST',
      credentials: 'include',
      headers: { 'X-Requested-With':'XMLHttpRequest' }
    });
    const txt = await r.text();
    let j = {};
    try { j = txt ? JSON.parse(txt) : {}; } catch(_){}
    if (!r.ok) throw new Error(j.error || j.message || ('HTTP ' + r.status));
    return j;
  }

  document.addEventListener('click', async (e)=>{
    const btn = e.target.closest('[data-action="materials.copy_public_link"]');
    if (!btn) return;

    const shareUrl = btn.getAttribute('data-share-url'); // ‚úÖ –±–µ—Ä—ë–º URL –∏–∑ –∫–Ω–æ–ø–∫–∏
    if (!shareUrl) {
      alert('Falta data-share-url en el bot√≥n');
      return;
    }

    btn.disabled = true;
    const old = btn.textContent;
    btn.textContent = 'Generando...';

    try{
      const j = await postJSON(shareUrl);
      const publicUrl = j.url;
      if (!publicUrl) throw new Error('Respuesta sin url');

      await copyToClipboard(publicUrl);

      btn.textContent = 'Copiado ‚úì';
      setTimeout(()=>{ btn.textContent = old; btn.disabled = false; }, 900);
    }catch(err){
      btn.textContent = 'Error';
      console.error(err);
      setTimeout(()=>{ btn.textContent = old; btn.disabled = false; }, 1200);
      alert('No se pudo generar el enlace: ' + (err.message || err));
    }
  });
})();
</script>

<script>
(function(){
  const modal = document.getElementById('mz-preview');
  const body  = document.getElementById('mz-prev-body');
  const title = document.getElementById('mz-prev-title');
  const openA = document.getElementById('mz-prev-open');
  const closeBtn = modal ? modal.querySelector('button[data-close]') : null;
  if(!modal || !body || !title || !openA) return;

  let lastFocus = null;

  function openPreview(url, name){
    lastFocus = document.activeElement; // ‚úÖ –∑–∞–ø–æ–º–Ω–∏–ª–∏
    title.textContent = name || 'Vista previa';
    openA.href = url;

    body.innerHTML = '';
    const u = (url || '').toLowerCase();

    // ‚úÖ —É —Ç–µ–±—è —Ç–µ–ø–µ—Ä—å inline=1 ‚Äî —Å—á–∏—Ç–∞–µ–º —ç—Ç–æ pdf (–∏–ª–∏ –¥–æ–±–∞–≤—å data-ext –∫–∞–∫ –º—ã –æ–±—Å—É–∂–¥–∞–ª–∏)
    const isPdf = u.includes('.pdf') || u.includes('inline=1');
    const isImg = u.match(/\.(png|jpg|jpeg|webp|gif)(\?|$)/);

    if(isPdf){
      const ifr = document.createElement('iframe');
      ifr.src = url;
      body.appendChild(ifr);
    } else if(isImg){
      const img = document.createElement('img');
      img.src = url;
      img.alt = title.textContent;
      body.appendChild(img);
    } else {
      body.innerHTML = '<div style="padding:14px;color:#cbd5e1">No hay vista previa para este tipo. Usa ‚ÄúAbrir/Descargar‚Äù.</div>';
    }

    modal.classList.remove('is-hidden');
    modal.setAttribute('aria-hidden','false');
    document.body.style.overflow = 'hidden';

    // ‚úÖ –ø–µ—Ä–µ–≤–æ–¥–∏–º —Ñ–æ–∫—É—Å –≤–Ω—É—Ç—Ä—å –º–æ–¥–∞–ª–∫–∏
    (closeBtn || openA).focus();
  }

  function closePreview(){
    // ‚úÖ —Å–Ω–∞—á–∞–ª–∞ –≤–µ—Ä–Ω–∏ —Ñ–æ–∫—É—Å –Ω–∞–∑–∞–¥, –ø–æ—Ç–æ–º –ø—Ä—è—á—å
    if(lastFocus && typeof lastFocus.focus === 'function') lastFocus.focus();
    lastFocus = null;

    modal.classList.add('is-hidden');
    modal.setAttribute('aria-hidden','true');
    body.innerHTML = '';
    document.body.style.overflow = '';
  }

  modal.addEventListener('click', (e)=>{
    if(e.target.matches('[data-close]') || e.target.closest('[data-close]')) closePreview();
  });
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape' && !modal.classList.contains('is-hidden')) closePreview();
  });

  document.addEventListener('click', (e)=>{
    const a = e.target.closest('a[data-preview]');
    if(!a) return;
    e.preventDefault();
    openPreview(a.getAttribute('href'), a.getAttribute('data-name') || a.textContent.trim());
  });
})();
</script>
<script>
/**
 * –°–∫–∞—á–∏–≤–∞–µ—Ç –∞–∫—Ç (DOCX) –ø–æ –º–∞—Ç–µ—Ä–∏–∞–ª—É —Ñ–∏–∑. –¥–ª—è –∫—É—Ä—Å–∞.
 * –†–µ–∞–ª—å–Ω—ã–π endpoint (–ø–æ get_resolver):
 *   /alumno/curso/<codigo>/physical_report_doc  (–∏ –≤–∞—Ä–∏–∞–Ω—Ç —Å–æ —Å–ª—ç—à–µ–º)
 *
 * –¢—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é (cookie), —Ç.–∫. —ç—Ç–æ teacher-only view.
 */

function mzDownloadPhysicalActa(codigo, itemKey){
  const inp = document.querySelector(`.mz-phys-date[data-item-key="${CSS.escape(itemKey)}"]`);
  const fecha = inp && inp.value ? inp.value : "";

  const qs = new URLSearchParams();
  qs.set("item_key", itemKey);
  if (fecha) qs.set("fecha", fecha);

  // ‚úÖ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π endpoint (teacher session)
  const url = `/alumno/curso/${encodeURIComponent(codigo)}/physical_report_doc/?` + qs.toString();

  window.location.href = url; // —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
}


/**
 * –ë—ã—Å—Ç—Ä—ã–π –±–∏–Ω–¥–∏–Ω–≥ –Ω–∞ –∫–Ω–æ–ø–∫–∏:
 * <button data-action="mz.download.acta"
 *         data-codigo="{{ curso.codigo }}"
 *         data-item-key="{{ it.key }}">
 *   Descargar acta
 * </button>
 */
document.addEventListener('click', (e) => {
  const btn = e.target.closest('[data-action="mz.download.acta"]');
  if (!btn) return;
  e.preventDefault();

  const codigo = btn.getAttribute('data-codigo') || '';
  const itemKey = btn.getAttribute('data-item-key') || '';
  if (!codigo || !itemKey) {
    alert('Falta codigo o item_key');
    return;
  }

  mzDownloadPhysicalActa(codigo, itemKey);
});
</script>
<script>
(function(){
  const form = document.getElementById('mz-upload-form');
  if(!form) return;

  const urlInp = form.querySelector('input[data-role="url"]');
  const dropRow = form.querySelector('.mz-upl-row[data-row-idx="1"]');
  const drop = dropRow ? dropRow.querySelector('[data-role="dropzone"]') : null;

  function anyFileSelected(){
    const inputs = form.querySelectorAll('input[type="file"][data-role="file"]');
    for (const inp of inputs){
      if (inp.files && inp.files.length) return true;
    }
    return false;
  }
  function hasUrl(){
    return !!(urlInp && urlInp.value && urlInp.value.trim().length);
  }

  form.addEventListener('submit', function(e){
    if (anyFileSelected() || hasUrl()) return;

    e.preventDefault();
    if (drop){
      drop.classList.add('is-over');
      setTimeout(()=>drop.classList.remove('is-over'), 350);
    }
    alert('Sube un archivo o pega una URL.');
  });
})();
</script>
<script>
(function(){
  const filters = document.querySelector('.mz-mat-modfilters[data-selected-mod]');
  if (!filters) return;

  const selected = (filters.getAttribute('data-selected-mod') || '').trim();
  if (!selected || selected === 'none') return;

  // 1) —Ñ–∞–π–ª–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ –∫–∞–∫ –±—ã–ª–æ
  const rowsContainer = document.getElementById('mz-upl-rows');
  if (rowsContainer) {
    rowsContainer.querySelectorAll('.mz-upl-row').forEach(row=>{
      const mk = row.querySelector('[data-role="module_key"]');
      if (mk) mk.value = selected;
    });
  }

  // 2) URL —Å–µ–∫—Ü–∏—è
  const urlMk = document.querySelector('#mz-upload-form [data-role="url_module_key"]');
  if (urlMk) urlMk.value = selected;
})();
</script>
<script>
(function(){
  const bc = document.getElementById('mz-fold-bc');
  if(!bc) return;

  const path = (bc.getAttribute('data-path') || '').trim();
  if(!path) return;

  const aud  = encodeURIComponent(bc.getAttribute('data-aud') || 'alumnos');
  const mod  = encodeURIComponent(bc.getAttribute('data-mod') || '');
  const sort = encodeURIComponent(bc.getAttribute('data-sort') || 'new');

  const parts = path.split('/').filter(Boolean);
  let acc = '';

  parts.forEach((p, idx)=>{
    acc = acc ? (acc + '/' + p) : p;

    const sep = document.createElement('span');
    sep.className = 'mz-bc-sep';
    sep.textContent = '‚Ä∫';
    bc.appendChild(sep);

    const a = document.createElement('a');
    a.className = 'mz-bc';
    a.textContent = p;
    a.href = `?tab=materiales&aud=${aud}&p=${encodeURIComponent(acc)}&mod=${mod}&sort=${sort}`;
    bc.appendChild(a);
  });
})();
</script>
<script>
(function(){
  const isTeacher = !!document.querySelector('[data-drop-folder]');
  if(!isTeacher) return;

  // CSRF –∏–∑ cookie (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ)
  function getCookie(name){
    const v = document.cookie.split(';').map(s=>s.trim()).find(s=>s.startsWith(name+'='));
    return v ? decodeURIComponent(v.split('=')[1]) : '';
  }
  const csrftoken = getCookie('csrftoken');

  let dragFileId = null;
  let dragEl = null;

  // --- DRAG START/END on files ---
  document.addEventListener('dragstart', (e)=>{
    const it = e.target.closest('[data-drag-file]');
    if(!it) return;
    dragEl = it;
    dragFileId = it.getAttribute('data-drag-file');
    it.classList.add('is-dragging');

    // dataTransfer –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è Firefox
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', dragFileId);
  });

  document.addEventListener('dragend', ()=>{
    if(dragEl) dragEl.classList.remove('is-dragging');
    dragEl = null;
    dragFileId = null;
    document.querySelectorAll('.mz-fold-item.is-drop-ok,.mz-fold-item.is-drop-bad')
      .forEach(x=>x.classList.remove('is-drop-ok','is-drop-bad'));
  });

function canDrop(folderEl){
  // –∑–∞–ø—Ä–µ—â–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç—ã —Ä–µ–∞–ª—å–Ω–æ —Ö–æ—á–µ—à—å –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ–Ω–æ—Å
  // –∞ "is-locked" –ø—É—Å—Ç—å –æ–∑–Ω–∞—á–∞–µ—Ç "–Ω–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å/–ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å", –Ω–æ –ø–µ—Ä–µ–Ω–æ—Å –º–æ–∂–Ω–æ
  return true;
}


  // --- DROP on folders ---
  document.querySelectorAll('[data-drop-folder]').forEach(folderEl=>{
    folderEl.addEventListener('dragenter', (e)=>{
      e.preventDefault();
      if(!dragFileId) return;
      folderEl.classList.add('is-drop-ok'); 
    });
    folderEl.addEventListener('dragover', (e)=>{
      e.preventDefault();
      if(!dragFileId) return;
      e.dataTransfer.dropEffect = canDrop(folderEl) ? 'move' : 'none';
    });
    folderEl.addEventListener('dragleave', ()=>{
      folderEl.classList.remove('is-drop-ok','is-drop-bad');
    });

    folderEl.addEventListener('drop', async (e)=>{
      e.preventDefault();
      folderEl.classList.remove('is-drop-ok','is-drop-bad');

      const fileId = dragFileId || e.dataTransfer.getData('text/plain');
      if(!fileId) return;

      if(!canDrop(folderEl)){
        alert('Esta carpeta est√° bloqueada.');
        return;
      }

      const targetPath = folderEl.getAttribute('data-drop-folder') || '';

      // POST –Ω–∞ —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É (—Ç–æ—Ç –∂–µ URL –≤–∫–ª–∞–¥–∫–∏)
      const form = new FormData();
      form.append('action', 'file_move');
      form.append('file_id', fileId);
      form.append('target_path', targetPath);

try{
  const r = await fetch(window.location.pathname + window.location.search, {
    method: 'POST',
    credentials: 'include',
    headers: {
      'X-CSRFToken': csrftoken,
      'X-Requested-With': 'XMLHttpRequest',
    },
    body: form
  });

  const ct = (r.headers.get('content-type') || '');
  const raw = await r.text();
  console.log('MOVE resp status=', r.status, 'ct=', ct, 'raw head=', raw.slice(0, 200));

  let j = {};
  try { j = raw ? JSON.parse(raw) : {}; } catch(_) {}

  if(!r.ok || !j.ok) throw new Error(j.error || ('HTTP ' + r.status));

  // UX: —É–±—Ä–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç
  const fileEl = document.querySelector(`[data-drag-file="${CSS.escape(String(fileId))}"]`);
  if(fileEl) fileEl.remove();

}catch(err){
  console.error(err);
  alert('No se pudo mover el archivo: ' + (err.message || err));
}

    });
  });
})();
</script>
