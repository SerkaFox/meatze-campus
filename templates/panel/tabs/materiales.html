{# panel/tabs/materiales.html #}
{% load static %}

<link rel="stylesheet" href="{% static 'panel/css/materiales.base.css' %}?v={% now 'U' %}">
<link rel="stylesheet" href="{% static 'panel/css/materiales.tree.css' %}?v={% now 'U' %}">
<link rel="stylesheet" href="{% static 'panel/css/materiales.preview.css' %}?v={% now 'U' %}">
<link rel="stylesheet" href="{% static 'panel/css/materiales.modal.css' %}?v={% now 'U' %}">
<link rel="stylesheet" href="{% static 'panel/css/materiales.drop.css' %}?v={% now 'U' %}">
<div class="mzc-card mz-mat-card">
<div class="mz-mat-head">
  <div>
    <h4 class="mz-mat-title">Materiales</h4>
    <p class="mz-mat-sub">Archivos y recursos asociados al curso.</p>
  </div>

  <div class="mz-mat-head-right">
    <div class="mz-mat-count" id="mz-files-count">
      0 archivos
    </div>

    <button type="button" class="mzc-btn ghost mz-mat-zipall"
            data-action="materials.zip.all"
            data-codigo="{{ curso.codigo }}"
            data-aud="{{ audience }}">
      ‚¨áÔ∏è Descargar TODO (ZIP)
    </button>
  </div>
</div>

  {# ---- –≤–µ—Ä—Ö–Ω–∏–π –±–∞—Ä: alumnos / docentes / mis ---- #}
  {% if is_teacher %}
    <div class="mz-mat-audience">
      <div class="mz-seg">
        {% for key,label in audience_options %}
          <a
            href="?tab=materiales&aud={{ key|urlencode }}&p={{ current_path|default:''|urlencode }}&mod={{ selected_mod|default:''|urlencode }}&sort={{ sort|default:'new'|urlencode }}"
            class="mzc-btn ghost{% if audience == key %} is-act{% endif %}"
            data-action="materials.audience"
            data-aud="{{ key }}"
          >
            {{ label }}
          </a>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  {# ---- —Ñ–æ—Ä–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (—Ç–æ–ª—å–∫–æ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å) ---- #}
  {% if is_teacher %}
    <div class="mz-upl-wrap" data-focus="upload">
      <form id="mz-upload-form" method="post" enctype="multipart/form-data" class="mz-upl">
        {% csrf_token %}
        <input type="hidden" name="upload" value="1">
        <input type="hidden" name="folder_path" value="{{ current_path }}">
        <input type="hidden" name="tipo"
               value="{% if audience == 'docentes' %}docentes{% elif audience == 'mis' %}privado{% else %}alumnos{% endif %}">

        <div class="mzc-note" style="margin-bottom:10px">
          <b>C√≥mo subir materiales:</b>
          <ul style="margin:8px 0 0 18px; line-height:1.35">
            <li><b>Arrastra</b> archivos desde tu ordenador y <b>su√©ltalos</b> encima de una carpeta en el √°rbol.</li>
            <li>O pulsa <b>‚ÄúSubir aqu√≠‚Äù</b> en una carpeta (si lo tienes) para seleccionar archivos.</li>
            <li>Si necesitas subir un archivo que est√° online, usa <b>Subir por URL</b> abajo.</li>
          </ul>
        </div>

        <!-- ===== –ü–æ —Å—Å—ã–ª–∫–µ ===== -->
        <div class="mz-upl-section" data-upl="url">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
            <div style="font-weight:800;color:#e5e7eb">üîó Subir por URL</div>
            <div style="font-size:.78rem;color:#9ca3af">Enlace directo a un archivo</div>
          </div>

          <div class="mz-upl-row" style="width:100%">
            <input type="url"
                   name="url_1"
                   data-role="url"
                   class="mz-upl-input"
                   placeholder="https://..."
                   style="flex:1;min-width:320px">

            <input type="text"
                   name="url_title_1"
                   data-role="url_title"
                   class="mz-upl-input"
                   placeholder="T√≠tulo (opcional)"
                   style="min-width:220px">

            <input type="hidden" name="url_module_key_1" data-role="url_module_key" value="">
          </div>
        </div>
      </form>

      <form id="mz-folder-create-form" method="post" style="display:none">
        {% csrf_token %}
        <input type="hidden" name="action" value="folder_create">
        <input type="hidden" name="folder_name" value="">
        <input type="hidden" name="folder_parent" value="{{ current_path|default:'' }}">
        <input type="hidden" name="aud" value="{{ audience }}">
      </form>

      <button type="submit"
              form="mz-upload-form"
              id="mzf-send"
              class="mz-upload-cta">
        ‚¨Ü Subir
      </button>
    </div>
  {% endif %}

  <div class="mz-mat-sort" style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center">
    <span style="font-size:.78rem; color:#9ca3af; margin-right:6px;">Orden:</span>

    <a href="?tab=materiales&aud={{ audience }}&p={{ current_path|urlencode }}&mod={{ selected_mod|default:''|urlencode }}&sort=new"
       class="mz-pill{% if sort == 'new' %} is-act{% endif %}">Nuevos</a>

    <a href="?tab=materiales&aud={{ audience }}&p={{ current_path|urlencode }}&mod={{ selected_mod|default:''|urlencode }}&sort=old"
       class="mz-pill{% if sort == 'old' %} is-act{% endif %}">Antiguos</a>

    <a href="?tab=materiales&aud={{ audience }}&p={{ current_path|urlencode }}&mod={{ selected_mod|default:''|urlencode }}&sort=az"
       class="mz-pill{% if sort == 'az' %} is-act{% endif %}">A‚ÄìZ</a>

    <a href="?tab=materiales&aud={{ audience }}&p={{ current_path|urlencode }}&mod={{ selected_mod|default:''|urlencode }}&sort=za"
       class="mz-pill{% if sort == 'za' %} is-act{% endif %}">Z‚ÄìA</a>
  </div>

  {% if current_path %}
    <div class="mz-fold-bc" id="mz-fold-bc"
         data-path="{{ current_path|escape }}"
         data-aud="{{ audience }}"
         data-mod="{{ selected_mod|default:''|escape }}"
         data-sort="{{ sort|default:'new'|escape }}">
      <a class="mz-bc" href="?tab=materiales&aud={{ audience }}&p=&mod={{ selected_mod|default:''|urlencode }}&sort={{ sort }}">üè† Inicio</a>
    </div>
  {% endif %}

  {# ===== Layout switch ===== #}
  <div class="mz-mat-layout" style="margin-top:10px; display:flex; justify-content:flex-end">
    <div class="mz-seg">
      <button type="button" class="mzc-btn ghost is-act" data-layout="tree">üå≤ √Årbol</button>
      <button type="button" class="mzc-btn ghost" data-layout="cards">üóÇÔ∏è Tarjetas</button>
    </div>
  </div>

  <div id="mz-tree-wrap">
    {% if is_teacher %}
      <div class="mz-tree-node" data-drop-folder="">
        <div class="mz-tree-row" style="gap:10px">
          <span style="opacity:.9">üè† Ra√≠z</span>

          <button class="mz-new-folder" type="button"
                  data-action="folder.create.big"
                  data-parent=""
                  title="Crear carpeta en Ra√≠z"
                  style="margin-left:6px">
            <span class="mz-new-folder-ico">üìÅ</span>
            <span class="mz-new-folder-plus">Ôºã</span>
          </button>

          <span style="margin-left:auto;opacity:.6;font-size:.78rem">soltar aqu√≠ = mover al root</span>
        </div>
      </div>
    {% endif %}

    <div class="mz-tree">
      {% if tree_root_files %}
        <div class="mz-tree-rootfiles">
          {% for f in tree_root_files %}
            {% include "panel/partials/materiales_tree_file.html" with f=f %}
          {% endfor %}
        </div>
      {% endif %}

      {% for node in tree_nodes %}
        {% include "panel/partials/materiales_tree_node.html" with node=node %}
      {% empty %}
        <div class="mzc-note">No hay carpetas.</div>
      {% endfor %}
    </div>
  </div>

  <div id="mz-cards-wrap" hidden>
	<div class="mz-fold-grid" id="mz-fold-grid">
		{% for fld in folders %}
<button type="button"
        class="mz-fold-card{% if fld.is_locked %} is-locked{% endif %}"
        data-open-path="{{ fld.path|escape }}"
        data-path="{{ fld.path|escape }}"
        data-drop-folder="{{ fld.path|escape }}"
        title="Abrir">

  <a href="#"
     class="mz-fold-zip"
     title="Descargar ZIP de esta carpeta"
     data-action="materials.zip.folder"
     data-codigo="{{ curso.codigo }}"
     data-aud="{{ audience }}"
     data-path="{{ fld.path|escape }}">‚¨áÔ∏è</a>

  <div class="mz-fold-ico">üìÅ</div>
  <div class="mz-fold-name">{{ fld.name }}</div>

  <div class="mz-fold-meta">
    <span class="mz-fold-count" data-count>{{ fld.files_count|default:"0" }}</span>
    {% if fld.is_locked %}
      <span class="mz-fold-badge">M√≥dulo</span>
    {% endif %}
  </div>
</button>
		{% empty %}
		  <div class="mz-fold-empty">‚Äî No hay carpetas ‚Äî</div>
		{% endfor %}
	</div>

    <div class="mz-cards-panel" id="mz-cards-panel" hidden>
      <div class="mz-cards-head">
        <div class="mz-cards-title" id="mz-cards-title">Archivos</div>

		<div class="mz-cards-actions">


		  {% if is_teacher %}
			<button type="button" class="mzc-btn ghost"
					data-action="folder.upload.here"
					data-parent="">
			  Subir aqu√≠
			</button>

			<button type="button" class="mzc-btn ghost"
					data-action="folder.create.here"
					data-parent="">
			  Nueva carpeta
			</button>
		  {% endif %}
		</div>
      </div>

      <div class="mz-cards-body" id="mz-cards-body">
        {# JS will move the folder's .mz-tree-children (or rootfiles) here #}
      </div>
    </div>
  </div>

  {# ---- as√≠ lo ven los alumnos ---- #}
  {% if is_teacher %}
    <div class="mz-rec-card" style="border-color:rgba(191,219,254,0.35);background:radial-gradient(circle at top left, rgba(59,130,246,0.18), rgba(15,23,42,0.92));">
      <h4 class="mz-rec-title">As√≠ lo ven los alumnos</h4>
      <p class="mz-rec-sub">Lista r√°pida de materiales visibles para alumnos (sin cambiar de pesta√±as).</p>
    </div>

    {% if student_visible_files %}
      <ul class="mz-mat-list" style="margin-top:10px">
        {% for f in student_visible_files %}
          <li class="mz-mat-item" style="border-color:rgba(34,211,238,0.35)">
            <div class="mz-mat-main">
              <p class="mz-mat-title-file" style="margin-bottom:4px">
                <a href="{% url 'panel:material_download' f.id %}"
											   data-action="materials.download"
											   target="_blank" rel="noopener">
                  {{ f.display_name }}
                </a>
              </p>
              <div class="mz-mat-meta">
                <span>{{ f.ext|upper }}</span>
                <span class="mz-mat-dot"></span>
                <span>{{ f.fmt_size }}</span>
                <span class="mz-mat-dot"></span>
                {% if f.module_key %}
                  <span class="mz-mat-tag">{{ f.module_key }}</span>
                {% else %}
                  <span class="mz-mat-tag muted">Sin m√≥dulo</span>
                {% endif %}
              </div>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="mzc-note">Ahora mismo no hay archivos visibles para alumnos.</div>
    {% endif %}
  {% endif %}

  {# ---- —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –º–∞—Ç–µ—Ä–∏–∞–ª (–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å) ---- #}
  {% if is_teacher %}
    <div class="mz-rec-card" data-focus="receipts">
      <h4 class="mz-rec-title">Material f√≠sico del curso</h4>
      <p class="mz-rec-sub">Crea y gestiona la lista por curso. Los alumnos solo ver√°n los elementos ‚Äúactivos‚Äù.</p>

      <form method="post" style="margin:0 0 10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center">
        {% csrf_token %}
        <input type="hidden" name="action" value="physical_item_add">
        <input class="mz-upl-input" name="label" placeholder="Nombre (ej: Cuaderno)" style="min-width:220px">
        <button class="mzc-btn" type="submit">A√±adir</button>

        <div class="mz-rec-hint" style="margin-left:auto; white-space:nowrap">
          Activos: {{ physical_items_enabled|length }} / {{ physical_items_all|length }}
        </div>
      </form>

      {% if physical_items_all %}
        <div class="mz-rec-grid">
          {% for it in physical_items_all %}
            <div class="mz-rec-row" style="align-items:flex-start">

              <form method="post" style="margin:0; display:flex; gap:10px; flex-wrap:wrap; align-items:center; width:100%">
                {% csrf_token %}
                <input type="hidden" name="action" value="physical_item_update">
                <input type="hidden" name="item_id" value="{{ it.id }}">

                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; width:100%">
                  <label style="display:flex; align-items:center; gap:8px">
                    <input type="checkbox" name="is_enabled" {% if it.is_enabled %}checked{% endif %}>
                    <span style="color:#e5e7eb;font-size:.86rem;font-weight:700">Activo</span>
                  </label>

                  <input class="mz-upl-input"
                         name="label"
                         value="{{ it.label }}"
                         style="min-width:240px; flex:1"
                         placeholder="Nombre visible">

                  <button class="mzc-btn ghost" type="submit">Guardar</button>

                  <button type="button"
                          class="mzc-btn ghost"
                          data-action="mz.download.acta"
                          data-codigo="{{ curso.codigo }}"
                          data-item-key="{{ it.key }}"
                          {% if not it.is_enabled %}title="Desactivado (aun as√≠ puedes descargar)"{% endif %}>
                    Descargar DOCX
                  </button>
                </div>
              </form>

              <form method="post" style="margin:0" onsubmit="return confirm('¬øEliminar este material f√≠sico del curso?');">
                {% csrf_token %}
                <input type="hidden" name="action" value="physical_item_delete">
                <input type="hidden" name="item_id" value="{{ it.id }}">
                <button class="mzc-btn ghost" type="submit">Eliminar</button>
              </form>

            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="mzc-note">A√∫n no hay materiales f√≠sicos para este curso.</div>
      {% endif %}
    </div>
  {% endif %}

  {% if not is_teacher and physical_items_enabled and not receipt_all_done %}
    <div class="mz-rec-card">
      <h4 class="mz-rec-title">Material f√≠sico recibido</h4>
      <p class="mz-rec-sub">Confirma solo una vez. Despu√©s queda bloqueado para la trazabilidad (Lanbide).</p>

      <form method="post" style="margin:0">
        {% csrf_token %}
        <input type="hidden" name="action" value="receipt_save">

        <div class="mz-rec-grid">
          {% for item in physical_items_enabled %}
            <label class="mz-rec-row{% if item.key in receipt_locked_keys %} is-locked{% endif %}">
              <input type="checkbox"
                     name="receipt_{{ item.key }}"
                     {% if item.key in receipt_keys %}checked{% endif %}
                     {% if item.key in receipt_locked_keys %}disabled{% endif %}>

              <div style="min-width:0">
                <div style="color:#e5e7eb;font-size:.86rem">{{ item.label }}</div>

                {% if item.key in receipt_locked_keys %}
                  <div class="mz-rec-hint">Confirmado ¬∑ bloqueado</div>
                {% else %}
                  <div class="mz-rec-hint">Pendiente</div>
                {% endif %}
              </div>

              {% if item.key in receipt_keys %}
                <span class="mz-chip-mini">Confirmado</span>
              {% endif %}
            </label>
          {% endfor %}
        </div>

        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <button class="mzc-btn" type="submit">Confirmar</button>
        </div>
      </form>
    </div>
  {% endif %}

</div>

<div id="mz-preview" class="mz-prev is-hidden" aria-hidden="true">
  <div class="mz-prev-backdrop" data-close></div>
  <div class="mz-prev-card" role="dialog" aria-modal="true">
    <div class="mz-prev-head">
      <div class="mz-prev-title" id="mz-prev-title">Vista previa</div>
      <div class="mz-prev-actions">
        <a class="mzc-btn ghost" id="mz-prev-open" target="_blank" rel="noopener">Abrir</a>
        <button class="mzc-btn ghost" type="button" data-close>Cerrar</button>
      </div>
    </div>
    <div class="mz-prev-body" id="mz-prev-body"></div>
  </div>
</div>

<script>
  window.__MZ_ZIP_URL__ = "{% url 'panel:materiales_download_zip' %}";
  window.__MZ_CURSO_CODIGO__ = "{{ curso.codigo|escapejs }}";
  window.__MZ_AUD__ = "{{ audience|escapejs }}";
</script>

<script src="{% static 'panel/js/materiales.js' %}?v={% now 'U' %}"></script>
<script src="{% static 'panel/js/materiales_fs.js' %}?v={% now 'U' %}"></script>
<script src="{% static 'panel/js/materiales_physical.js' %}?v={% now 'U' %}"></script>

