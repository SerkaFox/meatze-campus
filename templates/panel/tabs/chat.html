<div id="mz-chat-root" data-action="chat.root"></div>

<style>
  /* –¢–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–º–∫–∏ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–∞ */
  :root{
    --mz-border:#e1eaf5;
  }

  /* ===== Chat UI ===== */
  .mz-chat{
    display:flex;
    flex-direction:column;
    gap:12px;
    min-height:480px;
  }

  .mz-chat-head{
    display:flex;
    align-items:center;
    gap:10px;
  }

  .mz-chat-unread{
    margin-left:auto;
    font-size:12px;
    color:#fff;
    background:#b90e2e;
    border-radius:10px;
    padding:2px 8px;
    display:none;
  }

  .mz-chat-list{
    border:1px solid var(--mz-border);
    border-radius:14px;
    padding:10px;
    overflow:auto;
    max-height:60vh;
    background:linear-gradient(180deg,#f7fbff,#f3f7fd 40%,#eef3fb);
    box-shadow:0 8px 28px rgba(15,33,51,.06) inset;
  }

  .mz-msg{
    position:relative;
    display:flex;
    gap:10px;
    margin:10px 0;
  }
  .mz-msg.me{
    flex-direction:row-reverse;
  }

  .mz-avatar{
    width:36px;
    height:36px;
    border-radius:50%;
    color:#fff;
    font-weight:800;
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow:0 4px 12px rgba(0,0,0,.08);
  }

  .mz-bubble{
    max-width:76%;
    background:#fff;
    border:1px solid #e6eef6;
    border-radius:14px;
    padding:10px 12px;
    box-shadow:0 6px 20px rgba(15,33,51,.06);
  }
  .mz-msg.me .mz-bubble{
    background:#e8f5ff;
    border-color:#cfe0f4;
  }

  .mz-meta{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:6px;
    font-size:12px;
    color:#51607a;
    margin-bottom:6px;
  }

  .mz-text{
    font-size:15px;
    line-height:1.5;
    color:#0f1b2d;
  }

  .mz-file{
    margin-top:6px;
  }
  .mz-file a{
    text-decoration:none;
    word-break:break-all;
  }

  /* ===== Reacciones ===== */
  .mz-reactions{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-top:8px;
    align-items:center;
  }

  .mz-chip{
    border:1px solid #cfe0f4;
    border-radius:14px;
    padding:2px 8px;
    font-size:13px;
    cursor:pointer;
    background:#fff;
    display:inline-flex;
    align-items:center;
    gap:6px;
    transition:transform .08s ease, background .12s ease, border-color .12s ease;
  }
  .mz-chip .cnt{
    min-width:14px;
    text-align:center;
  }

  .mz-chip.is-mine{
    background:#dff0ff;
    border-color:#9ec9f3;
  }

  /* –ö–Ω–æ–ø–∫–∞ "üôÇ Reaccionar" */
  .mz-react-btn{
    margin-left:auto;
    border:1px dashed #cfe0f4;
    background:#fff;
    border-radius:12px;
    padding:2px 8px;
    font-size:13px;
    cursor:pointer;
  }
  .mz-react-btn:hover{
    border-style:solid;
  }

  /* Popup-picker –¥–ª—è —Ä–µ–∞–∫—Ü–∏–π –Ω–∞–¥ —Å–æ–æ–±—â–µ–Ω–∏–µ–º */
	.mz-picker{
	  position:fixed;          /* –∫–ª—é—á–µ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ */
	  z-index:9999;
	  background:#fff;
	  border:1px solid #e1eaf5;
	  border-radius:12px;
	  box-shadow:0 12px 30px rgba(9,23,41,.15);
	  padding:6px;
	  display:flex;
	  gap:6px;
	}


  .mz-picker .mz-emoji{
    font-size:20px;
    cursor:pointer;
    background:#fff;
    border:1px solid #e6eef6;
    border-radius:8px;
    padding:4px 6px;
    transition:transform .08s ease, background .12s ease, border-color .12s ease;
  }
  .mz-picker .mz-emoji:hover{
    transform:scale(1.08);
    border-color:#cfe0f4;
  }

  /* –û–±—â–∞—è –º–∏–∫—Ä–æ-–∞–Ω–∏–º–∞—Ü–∏—è */
  .mz-emoji,
  .mz-chip{
    transition:transform .08s ease, background .12s ease, border-color .12s ease;
  }
  .mz-chip.pop,
  .mz-emoji.pop{
    transform:scale(1.12);
  }

  /* ===== –ú–µ–Ω—é —ç–º–æ–¥–∑–∏ –¥–ª—è –ø–æ–ª—è –≤–≤–æ–¥–∞ ===== */
  .mz-emo-menu{
    position:fixed;
    z-index:50;
    background:#fff;
    border:1px solid #e1eaf5;
    border-radius:12px;
    box-shadow:0 14px 30px rgba(9,23,41,.18);
    padding:8px;
    display:grid;
    grid-template-columns:repeat(8,1fr);
    gap:6px;
    width:320px;
    max-width:92vw;
  }

  .mz-emo-menu .itm{
    font-size:20px;
    line-height:1;
    cursor:pointer;
    background:#fff;
    border:1px solid #e6eef6;
    border-radius:8px;
    padding:6px 0;
    text-align:center;
    transition:transform .08s ease, border-color .12s ease, background .12s ease;
  }
  .mz-emo-menu .itm:hover{
    transform:scale(1.08);
    border-color:#cfe0f4;
    background:#f7fbff;
  }

  /* –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è (–¥–ª—è docentes) */
  .mz-msg-del{
    margin-left:8px;
    border:1px solid #e6eef6;
    border-radius:10px;
    padding:2px 6px;
    font-size:12px;
    background:#fff;
    cursor:pointer;
  }
  .mz-msg-del:hover{
    border-color:#cfe0f4;
    background:#f7fbff;
  }
  /* –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ä–∞–∑–º–µ—Ä —Ä–µ–∞–∫—Ü–∏–π –∏ –∑–∞–ø—Ä–µ—â–∞–µ–º —É–∂–∏–º–∞—Ç—å—Å—è */
.mz-reactions .mz-chip{
  font-size:14px !important;
  line-height:1.2;
  padding:2px 8px;
  flex-shrink:0;
}

.mz-reactions .mz-chip .emo{
  font-size:18px;
  line-height:1;
}

/* –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π ‚Äî –∏ –¥–ª—è "–º–æ–∏—Ö" —Å–æ–æ–±—â–µ–Ω–∏–π */
.mz-msg.me .mz-reactions .mz-chip{
  font-size:14px !important;
}
/* –£–≤–µ–ª–∏—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä emoji-–∏–∫–æ–Ω–æ–∫ –≤ —Ä–µ–∞–∫—Ü–∏—è—Ö –∏ –ø–∏–∫–µ—Ä–µ */
.mz-picker .mz-emoji img.emoji,
.mz-reactions .mz-chip .emo img.emoji{
  width: 22px !important;
  height: 22px !important;
  max-width: none !important;
  max-height: none !important;
  display: inline-block;
}

/* –ó–∞–æ–¥–Ω–æ —É–±—å—ë–º –≤–æ–∑–º–æ–∂–Ω—ã–π —Å—Ç–∞—Ä—ã–π –º–µ–ª–∫–∏–π —à—Ä–∏—Ñ—Ç –Ω–∞ —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö */
.mz-msg.me .mz-reactions .mz-chip{
  font-size: 14px !important;
}

/* ===== CHAT ‚Äî –æ–±—ë—Ä—Ç–∫–∞ –∏ —à–∞–ø–∫–∞ ====================================== */
#mz-chat-root .mz-chat-shell{
  background:
    radial-gradient(circle at top left, rgba(56,189,248,.18), transparent 55%),
    radial-gradient(circle at bottom right, rgba(129,140,248,.18), transparent 55%),
    linear-gradient(135deg, #0f172a, #020617);
  border-radius:22px;
  border:1px solid rgba(148,163,184,0.6);
  box-shadow:
    0 20px 50px rgba(15,23,42,0.8),
    0 0 0 1px rgba(15,23,42,0.9);
  padding:14px;
  color:#e5e7eb;
}

#mz-chat-root .mz-chat{
  display:flex;
  flex-direction:column;
  gap:12px;
  min-height:480px;
}

#mz-chat-root .mz-chat-head{
  display:flex;
  align-items:center;
  gap:10px;
}

#mz-chat-root .mz-chat-title h4.mzc-title{
  margin:0;
  font-weight:800;
  letter-spacing:0.04em;
  text-transform:uppercase;
  font-size:0.9rem;
  color:#e5f0ff;
}

#mz-chat-root .mz-chat-title .mzc-note{
  font-size:0.75rem;
  color:#9ca3af;
}

#mz-chat-root .mz-chat-unread{
  margin-left:auto;
  font-size:0.78rem;
  color:#f9fafb;
  background:#b91c1c;
  border-radius:999px;
  padding:3px 10px;
  display:none;
  box-shadow:0 6px 18px rgba(185,28,28,.7);
}

/* ===== –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π ============================================ */
#mz-chat-root .mz-chat-list{
  border:1px solid rgba(148,163,184,0.5);
  border-radius:16px;
  padding:10px;
  overflow:auto;
  max-height:60vh;
  background:radial-gradient(circle at top, #0b1220, #020617 60%);
  box-shadow:0 8px 30px rgba(15,23,42,.85) inset;
}

/* ===== –ë–∞–±–ª—ã –∏ –∞–≤–∞—Ç–∞—Ä–∫–∏ ============================================ */
#mz-chat-root .mz-msg{
  position:relative;
  display:flex;
  gap:10px;
  margin:10px 0;
}

#mz-chat-root .mz-msg.me{
  flex-direction:row-reverse;
}

#mz-chat-root .mz-avatar{
  width:36px;
  height:36px;
  border-radius:50%;
  color:#0b1120;
  font-weight:800;
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow:0 6px 18px rgba(0,0,0,.45);
  border:2px solid rgba(15,23,42,.9);
}

#mz-chat-root .mz-bubble{
  max-width:76%;
  background:rgba(15,23,42,0.96);
  border:1px solid rgba(148,163,184,0.7);
  border-radius:16px;
  padding:9px 11px 8px;
  box-shadow:0 12px 32px rgba(15,23,42,.8);
}

#mz-chat-root .mz-msg.me .mz-bubble{
  background:linear-gradient(135deg,#1d4ed8,#22c55e);
  border-color:rgba(191,219,254,.9);
}

#mz-chat-root .mz-meta{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:6px;
  font-size:11px;
  color:#FFFF00;
  margin-bottom:4px;
}

#mz-chat-root .mz-text{
  font-size:14px;
  line-height:1.55;
  color:#e5e7eb;
}

#mz-chat-root .mz-msg.me .mz-text{
  color:#f9fafb;
}

/* ===== –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ ========================================= */
#mz-chat-root .mz-input{
  margin-top:8px;
  display:flex;
  align-items:flex-end;
  gap:8px;
  padding:8px 10px;
  border-radius:999px;
  background:rgba(15,23,42,0.96);
  border:1px solid rgba(148,163,184,0.7);
  box-shadow:0 12px 30px rgba(15,23,42,.8);
}

#mz-chat-root .mz-input-text{
  flex:1 1 auto;
  min-height:44px;
  max-height:120px;
  resize:vertical;
  background:transparent;
  border:none;
  color:#e5e7eb;
  font-size:0.9rem;
}

#mz-chat-root .mz-input-text::placeholder{
  color:#6b7280;
}

#mz-chat-root .mz-input-btn{
  border-radius:999px;
  padding:6px 10px;
  min-width:40px;
}

#mz-chat-root .mz-input-send{
  border-radius:999px;
  padding:7px 18px;
  font-weight:600;
  background:linear-gradient(135deg,#22c55e,#16a34a);
  color:#ecfdf5;
  border-color:rgba(34,197,94,0.9);
  box-shadow:0 10px 24px rgba(22,163,74,.8);
  transition:transform .08s ease, box-shadow .12s ease, background .12s ease;
}

#mz-chat-root .mz-input-send:hover{
  background:linear-gradient(135deg,#4ade80,#22c55e);
  transform:translateY(-1px);
}

#mz-chat-root .mz-input-send:active{
  transform:scale(0.97);
  box-shadow:0 0 0 2px rgba(34,197,94,.6);
}

#mz-chat-root .mz-chat-hint{
  font-size:0.75rem;
  color:#9ca3af;
}
/* –ü—Ä–∏–∂–∏–º–∞–µ–º —á—É–∂–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤–ª–µ–≤–æ, —Å–≤–æ–∏ ‚Äî –≤–ø—Ä–∞–≤–æ */
#mz-chat-root .mz-msg{
  max-width: 100%;
}

#mz-chat-root .mz-msg:not(.me){
  margin-right: auto;   /* –ø—Ä–∏–∂–∞—Ç—å –∫ –ª–µ–≤–æ–º—É –∫—Ä–∞—é */
}

#mz-chat-root .mz-msg.me{
  margin-left: auto;    /* –ø—Ä–∏–∂–∞—Ç—å –∫ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é */
}

/* –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–µ–≤–∞/—Å–ø—Ä–∞–≤–∞ ‚Äî –≤—ã–ª–µ—Ç + –ø—Ä—É–∂–∏–Ω–∫–∞ */
#mz-chat-root .mz-msg.mz-msg-new:not(.me){
  animation: mz-msg-in-left 0.28s cubic-bezier(.22,.76,.31,1.13);
}

#mz-chat-root .mz-msg.mz-msg-new.me{
  animation: mz-msg-in-right 0.28s cubic-bezier(.22,.76,.31,1.13);
}

@keyframes mz-msg-in-left{
  0%{
    transform: translateX(80px) scale(.97); /* –ø—Ä–∏–ª–µ—Ç–∞–µ—Ç —Å –ø—Ä–∞–≤–æ–π —Å—Ç–æ—Ä–æ–Ω—ã */
    opacity:0;
  }
  60%{
    transform: translateX(-6px) scale(1.02); /* –ª—ë–≥–∫–∏–π –ø–µ—Ä–µ—Ä–∞–∑–ª—ë—Ç */
    opacity:1;
  }
  100%{
    transform: translateX(0) scale(1);
    opacity:1;
  }
}

@keyframes mz-msg-in-right{
  0%{
    transform: translateX(-80px) scale(.97); /* –ø—Ä–∏–ª–µ—Ç–∞–µ—Ç —Å –ª–µ–≤–æ–π —Å—Ç–æ—Ä–æ–Ω—ã */
    opacity:0;
  }
  60%{
    transform: translateX(6px) scale(1.02);
    opacity:1;
  }
  100%{
    transform: translateX(0) scale(1);
    opacity:1;
  }
}
/* Header: –±–µ–∑ –±–µ–ª–æ–π –ø–ª–∞—à–∫–∏, –≤ —Å—Ç–∏–ª–µ shell */
#mz-chat-root .mz-chat-head{
  background: transparent !important;
  border: 0 !important;
  box-shadow: none !important;
  padding: 0 !important;          /* —É —Ç–µ–±—è head —É–∂–µ –≤–Ω—É—Ç—Ä–∏ shell */
}
/* Attach button: –≤–∏–¥–Ω–æ –Ω–∞ —Ç—ë–º–Ω–æ–º —Ñ–æ–Ω–µ */
#mz-chat-root #mz-attach{
  background: rgba(255,255,255,.10) !important;
  border: 1px solid rgba(148,163,184,.55) !important;
  color: #e5e7eb !important;
  box-shadow: 0 10px 24px rgba(15,23,42,.65);
}

#mz-chat-root #mz-attach:hover{
  background: rgba(56,189,248,.14) !important;
  border-color: rgba(56,189,248,.55) !important;
}
#mz-chat-root #mz-emoji{
  background: rgba(255,255,255,.10) !important;
  border: 1px solid rgba(148,163,184,.55) !important;
  color: #e5e7eb !important;
}
#mz-chat-root #mz-emoji:hover{
  background: rgba(255,255,255,.14) !important;
}
@media (max-width: 640px){
  /* –í—Å—è –Ω–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è card */
  #mz-chat-root .mz-input{
    border-radius: 16px;
    padding: 10px;
    flex-direction: column;     /* –ö–õ–Æ–ß */
    align-items: stretch;
    gap: 10px;
  }

  /* textarea –∑–∞–Ω–∏–º–∞–µ—Ç –≤—Å—é —à–∏—Ä–∏–Ω—É */
  #mz-chat-root .mz-input-text{
    width: 100%;
    min-height: 90px;           /* —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ ‚Äú—Å–∂–∞—Ç–æ‚Äù */
    border-radius: 14px;
    padding: 10px 12px;
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(148,163,184,.45);
  }

  /* –ö–Ω–æ–ø–∫–∏ –≤ —Ä—è–¥ —Å–Ω–∏–∑—É */
  #mz-chat-root .mz-input .mz-input-btn,
  #mz-chat-root .mz-input #mz-attach,
  #mz-chat-root .mz-input #mz-emoji{
    height: 44px;
    min-width: 44px;
    border-radius: 14px;
  }

  /* –†—è–¥ –¥–µ–π—Å—Ç–≤–∏–π: —Å–¥–µ–ª–∞–µ–º –≥—Ä–∏–¥–æ–º –∏–∑ 3 –∫–æ–ª–æ–Ω–æ–∫ */
  #mz-chat-root .mz-input{
    position: relative;
  }

  /* –ü–µ—Ä–µ—Å—Ç–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è HTML: –¥–µ–ª–∞–µ–º flex-wrap –≤–Ω—É—Ç—Ä–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–º –ø—Ä–∞–≤–∏–ª–æ–º */
  #mz-chat-root .mz-input{
    flex-wrap: nowrap;
  }

  /* –ù–∞ –º–æ–±–∏–ª–µ: –∫–Ω–æ–ø–∫–∏ –∏ send –≤ –Ω–∏–∂–Ω–∏–π —Ä—è–¥ */
  #mz-chat-root #mz-emoji,
  #mz-chat-root #mz-attach,
  #mz-chat-root #mz-send{
    width: auto;
  }

  /* ‚ÄúEnviar‚Äù ‚Äî –Ω–∞ –≤—Å—é –æ—Å—Ç–∞–≤—à—É—é—Å—è —à–∏—Ä–∏–Ω—É */
  #mz-chat-root #mz-send{
    flex: 1 1 auto;
    height: 44px;
  }

  /* –ß—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∏ —Ä–µ–∞–ª—å–Ω–æ –±—ã–ª–∏ ‚Äú–≤–º–µ—Å—Ç–µ‚Äù, –¥–µ–ª–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º —Å–∞–º .mz-input grid */
  #mz-chat-root .mz-input{
    display: grid;
    grid-template-columns: 44px 44px 1fr;
    grid-template-areas:
      "text text text"
      "emo  att  send";
  }

  #mz-chat-root .mz-input-text{ grid-area: text; }
  #mz-chat-root #mz-emoji{ grid-area: emo; }
  #mz-chat-root #mz-attach{ grid-area: att; }
  #mz-chat-root #mz-send{ grid-area: send; }
}
/* ===== Tabs (Curso / Docente) ===== */
#mz-chat-root .mz-chat-tabs{
  display:inline-flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
}

#mz-chat-root .mz-chat-tab{
  border:1px solid rgba(148,163,184,.55);
  background:rgba(255,255,255,.08);
  color:#e5e7eb;
  border-radius:999px;
  padding:6px 10px;
  font-weight:800;
  font-size:12px;
  cursor:pointer;
  box-shadow:0 10px 24px rgba(15,23,42,.45);
}

#mz-chat-root .mz-chat-tab.is-active{
  background:linear-gradient(135deg,#22c55e,#16a34a);
  border-color:rgba(34,197,94,.9);
  color:#ecfdf5;
}

#mz-chat-root .mz-chat-teacher{
  display:none;
  max-width:260px;
  background:rgba(255,255,255,.08);
  border:1px solid rgba(148,163,184,.55);
  color:#e5e7eb;
  border-radius:14px;
  padding:6px 10px;
}
/* Select (Privado) ‚Äî —á–∏—Ç–∞–µ–º—ã–π –Ω–∞ —Ç—ë–º–Ω–æ–º —Ñ–æ–Ω–µ */
#mz-chat-root .mz-chat-teacher{
  appearance: none;
  -webkit-appearance: none;
  background: rgba(2,6,23,.92) !important;
  color: #e5e7eb !important;
  border: 1px solid rgba(148,163,184,.65) !important;
  box-shadow: 0 10px 24px rgba(15,23,42,.45);
}

/* –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫: –≥–¥–µ –±—Ä–∞—É–∑–µ—Ä —Ä–∞–∑—Ä–µ—à–∏—Ç */
#mz-chat-root .mz-chat-teacher option{
  background: #0b1220;
  color: #e5e7eb;
}

/* –ü–æ–¥—Å–∫–∞–∑–∫–∞ –±—Ä–∞—É–∑–µ—Ä—É –ø—Ä–æ —Ç—ë–º–Ω—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª—ã */
#mz-chat-root .mz-chat-teacher{ color-scheme: dark; }
/* === FORCE: select/dropdown dark === */
#mz-chat-root #mz-chat-teacher.mz-chat-teacher{
  background-color:#0b1220 !important;
  color:#e5e7eb !important;
  border-color:rgba(148,163,184,.65) !important;
  color-scheme: dark;
  -webkit-text-fill-color:#e5e7eb; /* Safari/Chrome –∏–Ω–æ–≥–¥–∞ –Ω–∞–¥–æ */
}

#mz-chat-root #mz-chat-teacher.mz-chat-teacher:focus{
  outline: none;
  box-shadow: 0 0 0 2px rgba(56,189,248,.35), 0 10px 24px rgba(15,23,42,.45);
}

/* option ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç –ù–ï –≤—Å–µ–≥–¥–∞ (–Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –û–° –∏–≥–Ω–æ—Ä—è—Ç), –Ω–æ —Å—Ç–æ–∏—Ç –æ—Å—Ç–∞–≤–∏—Ç—å */
#mz-chat-root #mz-chat-teacher.mz-chat-teacher option{
  background-color:#0b1220 !important;
  color:#e5e7eb !important;
}

#mz-chat-root .mz-pill-badge{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  min-width:18px;
  height:18px;
  padding:0 6px;
  margin-left:6px;
  border-radius:999px;
  font-size:12px;
  font-weight:800;
  color:#fff;
  background:#b91c1c;
  box-shadow:0 6px 18px rgba(185,28,28,.55);
}
#mz-chat-root .mz-text a{
  color:#93c5fd;
  text-decoration: underline;
  word-break: break-word;
}
/* ===== Link pill inside message ===== */
#mz-chat-root .mz-text a.mz-link{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:7px 10px;
  margin:4px 0;
  border-radius:12px;

  background: linear-gradient(135deg, rgba(56,189,248,.18), rgba(34,197,94,.14));
  border: 1px solid rgba(148,163,184,.45);

  color:#e5e7eb;
  text-decoration:none;
  font-weight:700;

  box-shadow: 0 10px 24px rgba(15,23,42,.45);
  transition: transform .10s ease, border-color .12s ease, background .12s ease, box-shadow .12s ease;
  max-width:100%;
}

/* –∏–∫–æ–Ω–∫–∞ —Å–ª–µ–≤–∞ */
#mz-chat-root .mz-text a.mz-link::before{
  content:"üîó";
  font-size:16px;
  line-height:1;
  opacity:.95;
}

/* —Å—Ç—Ä–µ–ª–∫–∞ —Å–ø—Ä–∞–≤–∞ */
#mz-chat-root .mz-text a.mz-link::after{
  content:"‚Üó";
  font-size:16px;
  line-height:1;
  opacity:.9;
  transform: translateY(-1px);
}

#mz-chat-root .mz-text a.mz-link:hover{
  transform: translateY(-1px);
  border-color: rgba(56,189,248,.70);
  background: linear-gradient(135deg, rgba(56,189,248,.26), rgba(34,197,94,.22));
  box-shadow: 0 16px 34px rgba(15,23,42,.65);
}

#mz-chat-root .mz-text a.mz-link:active{
  transform: scale(.99);
}

/* —á—Ç–æ–±—ã –¥–ª–∏–Ω–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–µ –ª–æ–º–∞–ª–∏ –≤–µ—Ä—Å—Ç–∫—É */
#mz-chat-root .mz-text a.mz-link .mz-link-text{
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  max-width: 64ch; /* –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å */
}

/* –µ—Å–ª–∏ —Å—Å—ã–ª–∫–∞ –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –∏ —Ö–æ—á–µ—Ç—Å—è ‚Äú–±–ª–æ–∫–æ–º‚Äù */
#mz-chat-root .mz-text a.mz-link.mz-link-block{
  display:flex;
  width: fit-content;
}
</style>


<script>
(async function(){
  const root = document.getElementById('mz-chat-root');
  if (!root) return;

  // --- 1. helper –¥–ª—è CSRF ---
  function getCookie(name) {
    const value = document.cookie
      .split('; ')
      .find(row => row.startsWith(name + '='));
    return value ? decodeURIComponent(value.split('=')[1]) : null;
  }

  // –¥–∞–Ω–Ω—ã–µ —Å –±—ç–∫–∞
  const code   = "{{ curso.codigo|escapejs }}";
  const V5_API = "{{ V5_API_BASE|default:'/meatze/v5'|escapejs }}";

  const mzAuth = {
    me: {
      id: {{ user.id|default:'null' }},
      is_teacher: {{ is_teacher|yesno:"true,false" }},
    }
  };

  // --- 2. api() —Å CSRF ---
async function api(url, options = {}) {
  // quiet=true ‚Üí –Ω–µ –±—Ä–æ—Å–∞–µ–º –æ—à–∏–±–∫—É, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º null –ø—Ä–∏ –Ω–µ-OK
  const quiet = !!options.quiet;

  // –Ω–µ –¥–∞—ë–º quiet –ø–æ–ø–∞—Å—Ç—å –≤ fetch
  const opts = { credentials: 'include', ...options };
  delete opts.quiet;

  const method = (opts.method || 'GET').toUpperCase();

  // —Ç–µ–ª–æ ‚Üí JSON, –µ—Å–ª–∏ –Ω–µ FormData
  if (opts.body && !(opts.body instanceof FormData)) {
    opts.headers = {
      'Content-Type': 'application/json',
      ...(opts.headers || {}),
    };
    opts.body = JSON.stringify(opts.body);
  } else {
    opts.headers = { ...(opts.headers || {}) };
  }

  // CSRF –¥–ª—è –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤
  if (['POST', 'PUT', 'PATCH', 'DELETE'].includes(method)) {
    const csrftoken = getCookie('csrftoken');
    if (csrftoken) opts.headers['X-CSRFToken'] = csrftoken;
    opts.headers['X-Requested-With'] = 'XMLHttpRequest';
  }

  let res;
  try {
    res = await fetch(url, opts);
  } catch (e) {
    if (quiet) return null;
    throw e;
  }

  if (!res.ok) {
    if (quiet) return null;

    let msg;
    try {
      const j = await res.json();
      msg = j.error || j.message || j.detail;
    } catch (_) {}
    throw new Error(msg || `HTTP ${res.status}`);
  }

  try { return await res.json(); }
  catch { return {}; }
}


    if (!code){ root.innerHTML = '<div class="mzc-note">Selecciona un curso.</div>'; return; }

    let lastId = 0, loading = false, stopPoll = false, firstPaint = true;
			// ===== Chat scopes: course vs dm =====
	let chatKind = 'course';   // 'course' | 'dm'
	let peerId = null;         // —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ –≤ DM (teacher –¥–ª—è —É—á–µ–Ω–∏–∫–∞ / alumno –¥–ª—è —É—á–∏—Ç–µ–ª—è)
	let peers = null;          // cache —Å–ø–∏—Å–∫–∞ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–≤


    let burstUntil = 0;
	let lastDeletedTs = 0;
    const me = mzAuth?.me || {};
    const isMe = (uid)=> String(uid) === String(me?.id || '');

    const nameCache = new Map(); // email -> display_name

    const getLocalDisplay = (m) => {
      const rawName = (m.author_name || '').trim();
      const mail    = (m.author_email || '').trim();

      // –µ—Å–ª–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞ —É–∂–µ –ø—Ä–∏—à–ª–æ –Ω–µ-–ø–æ—á—Ç–æ–≤–æ–µ –∏–º—è ‚Äî –±–µ—Ä—ë–º –µ–≥–æ
      if (rawName && !rawName.includes('@')) return rawName;

      if (mail) {
        const local = mail.split('@')[0];
        return local || 'Usuario';
      }
      return 'Usuario';
    };

    async function ensureDisplayNameForMessage(m){
      const email = (m.author_email || '').trim();
      if (!email) return;
      if (nameCache.has(email)) return; // —É–∂–µ –∑–Ω–∞–µ–º

      try{
        const r  = await api(`${V5_API}/user_display?email=${encodeURIComponent(email)}`);
        const dn = (r?.display_name || '').trim();
        if (!dn) return;

        nameCache.set(email, dn);

        // –æ–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —ç—Ç–æ–π –ø–æ—á—Ç–æ–π
        const sel = `.mz-msg[data-email="${CSS.escape(email)}"] .mz-meta`;
        const metas = $list.querySelectorAll(sel);
		metas.forEach(meta => {
		  const ts = Number(meta.getAttribute('data-ts') || '0');
		  const prettyTime = ts ? fmtTime(ts) : meta.getAttribute('data-ts-text') || '';

		  // –µ—Å–ª–∏ –≤–Ω—É—Ç—Ä–∏ —É–∂–µ –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è ‚Äî –∑–∞–±–µ—Ä—ë–º –µ—ë HTML
		  const delBtn = meta.querySelector('.mz-msg-del');
		  const delHtml = delBtn ? delBtn.outerHTML : '';

		  meta.innerHTML = `${dn} ¬∑ ${prettyTime}${delHtml}`;
		});

      }catch(e){
        // –º–æ–ª—á–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
        console.warn('user_display lookup failed', e);
      }
    }

	  root.innerHTML = `
		<div class="mz-chat-shell">
		  <div class="mz-chat">
		<div class="mz-chat-head">
		  <div class="mz-chat-title">
			<h4 class="mzc-title" id="mz-chat-title">Chat del curso</h4>

<div class="mz-chat-tabs" style="margin-top:6px">
  <button type="button" class="mz-chat-tab is-active" data-chat-kind="course">
    Curso
  </button>

  <button type="button" class="mz-chat-tab" data-chat-kind="dm">
    Privado <span id="mz-dm-total" class="mz-pill-badge" style="display:none"></span>
  </button>

  <select id="mz-chat-teacher" class="mz-chat-teacher"></select>
</div>


			<div class="mzc-note">C√≥digo: <b>${code}</b></div>
		  </div>

		  <span id="mzcu-unread" class="mz-chat-unread"></span>
		</div>


			<div id="mzcl" class="mz-chat-list"></div>

			<div class="mz-input">
			  <button id="mz-emoji" class="mzc-btn ghost mz-input-btn" title="A√±adir emoji r√°pido">üôÇ</button>
			  <textarea id="mzi" class="mzc-inp mz-input-text" placeholder="Escribe un mensaje... (Ctrl/‚åò+Enter para enviar)"></textarea>
			  <input id="mzf" type="file" style="display:none"
       accept="image/*,application/pdf,
               application/msword,
               application/vnd.openxmlformats-officedocument.wordprocessingml.document,
               application/vnd.ms-excel,
               application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" />

			  <button id="mz-attach" data-action="chat.adjuntar"class="mzc-btn ghost mz-input-btn" title="Adjuntar archivo">üìé</button>
			  <button id="mz-send" data-action="chat.send" class="mzc-btn mz-input-send">Enviar</button>
			</div>

			<div class="mzc-note mz-chat-hint">
			  Una sola reacci√≥n por mensaje. Toca otra para cambiar; toca la misma para quitarla.
			</div>
		  </div>
		</div>
	  `;


    const $list = root.querySelector('#mzcl');
    const $in   = root.querySelector('#mzi');
    const $send = root.querySelector('#mz-send');
    const $att  = root.querySelector('#mz-attach');
    const $file = root.querySelector('#mzf');
    const $emo  = root.querySelector('#mz-emoji');
    const $unr  = root.querySelector('#mzcu-unread');
	const $title = root.querySelector('#mz-chat-title');
const $tabs = root.querySelectorAll('[data-chat-kind]');
const $tsel = root.querySelector('#mz-chat-teacher');
const $dmTotal = root.querySelector('#mz-dm-total');



    const fmtTime = (ts)=>{ const d=new Date(ts*1000); return d.toLocaleString([], {hour:'2-digit',minute:'2-digit',day:'2-digit',month:'2-digit'}); };
    const hashColor = (s='?')=>{ let h=0; for(let i=0;i<s.length;i++){ h=(h*31+s.charCodeAt(i))>>>0; } const hue=h%360; return `hsl(${hue} 70% 52%)`; };
    const initials = (name,email)=>{ const s=(name||email||'?').trim(); const p=s.split(/\s+/); const a=(p[0]||'').charAt(0).toUpperCase(); const b=(p[1]||'').charAt(0).toUpperCase(); return (a+b).trim()||'U'; };

function escapeHtml(s=''){
  return String(s).replace(/[&<>"']/g, ch => ({
    '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;'
  }[ch]));
}

// linkify —É–∂–µ –≠–ö–†–ê–ù–ò–†–û–í–ê–ù–ù–´–ô —Ç–µ–∫—Å—Ç (–≤–∞–∂–Ω–æ!)
function linkify(escapedText=''){
  return escapedText.replace(
    /(?:https?:\/\/|www\.)[^\s<]+/gi,
    (raw) => {
      const href = raw.toLowerCase().startsWith('www.') ? `https://${raw}` : raw;

      // —Ç–µ–∫—Å—Ç –≤–Ω—É—Ç—Ä–∏ ‚Äî –æ–±—Ä–µ–∂–µ–º –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω–æ–µ –≤–∏–∑—É–∞–ª—å–Ω–æ, –Ω–æ href –ø–æ–ª–Ω—ã–π
      return `<a class="mz-link mz-link-block" href="${href}" target="_blank" rel="noopener noreferrer">
                <span class="mz-link-text">${raw}</span>
              </a>`;
    }
  );
}

const renderMsg = (m)=>{
  const self    = isMe(m.user_id);
  const display = getLocalDisplay(m);
  const mail    = (m.author_email || '').trim();
  const metaTxt = `${display} ¬∑ ${fmtTime(m.ts)}`;

  const file = m.file_url
    ? `<div class="mz-file"><a href="${m.file_url}" target="_blank" rel="noopener">üìé ${m.file_url}</a></div>`
    : '';
const bodyHtml = m.body ? linkify(escapeHtml(m.body)) : '';

  const canDelete = !!(mzAuth?.me?.is_teacher);
  const delBtn = canDelete
    ? `<button class="mz-msg-del" data-type="del" data-msg="${m.id}" title="Eliminar mensaje">üóëÔ∏è</button>`
    : '';

  const reacts = (m.reactions||[])
    .filter(r => (r.count||0) > 0)
    .map(r => {
      const mine = r.me ? ' is-mine' : '';
      return `<button class="mz-chip${mine}" data-type="chip" data-msg="${m.id}" data-emoji="${r.emoji}" aria-pressed="${r.me? 'true':'false'}">
                <span class="emo">${r.emoji}</span>
                <span class="cnt">${r.count}</span>
              </button>`;
    }).join('');

  const avBg = hashColor(mail || display || '');
  const emailAttr = mail.replace(/"/g,'&quot;');

  const reactBtn = self
    ? ''
    : `<button class="mz-react-btn" data-action="chat.react.open" data-type="open-picker" data-msg="${m.id}" title="Reaccionar">üôÇ Reaccionar</button>`;

  return `
    <div class="mz-msg ${self ? 'me' : ''} mz-msg-new"
         data-id="${m.id}" data-email="${emailAttr}">
      <div class="mz-avatar" style="background:${avBg}">
        ${initials(display, mail)}
      </div>
      <div class="mz-bubble">
        <div class="mz-meta"
             data-ts="${m.ts}"
             data-ts-text="${fmtTime(m.ts)}">
          ${metaTxt}
          ${delBtn}
        </div>
        ${bodyHtml ? `<div class="mz-text">${bodyHtml}</div>` : ''}
        ${file}
        <div class="mz-reactions">
          <span class="mz-chips">${reacts}</span>
          ${reactBtn}
        </div>
      </div>
    </div>
  `;
};




	async function refreshDeleted(){
	  try{
		const r = await api(`${V5_API}/chat/${encodeURIComponent(code)}/deleted?after=${lastDeletedTs}`);
		const ids = Array.isArray(r?.deleted_ids) ? r.deleted_ids : [];
		if (ids.length){
		  for (const id of ids){
			const node = $list.querySelector(`.mz-msg[data-id="${id}"]`);
			if (node) node.remove();
		  }
		}
		lastDeletedTs = Math.max(lastDeletedTs, r?.last_ts || lastDeletedTs);
	  }catch(e){}
	}

    function collectMessageIdsForSync(limit=80){
      const nodes = Array.from($list.querySelectorAll('.mz-msg[data-id]'));
      // –í–æ–∑—å–º—ë–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ limit —Å–æ–æ–±—â–µ–Ω–∏–π (–æ–Ω–∏ —á–∞—â–µ —Ç—Ä–æ–≥–∞—é—Ç—Å—è)
      return nodes.slice(-limit).map(n => parseInt(n.getAttribute('data-id'),10)).filter(Boolean);
    }
    
    // –ü–∞—Ç—á–∏–Ω–≥ DOM –ø–æ —Å–≤–æ–¥–∫–µ
	function applyReactionSummary(summary, idsRequested){
	  const processed = new Set();

	  for (const [midStr, entries] of Object.entries(summary||{})){
		const mid = parseInt(midStr,10);
		processed.add(mid);

		const wrap = $list.querySelector(`.mz-msg[data-id="${mid}"] .mz-reactions`);
		if (!wrap) continue;
		const chipsWrap = wrap.querySelector('.mz-chips');
		if (!chipsWrap) continue;

		const domChips = Array.from(chipsWrap.querySelectorAll('.mz-chip'));
		const byEmoji = new Map((entries||[]).map(e => [e.emoji, e]));

		// –æ–±–Ω–æ–≤–∏—Ç—å/—Å–æ–∑–¥–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ
		for (const [emo, data] of byEmoji.entries()){
		  let chip = chipsWrap.querySelector(`.mz-chip[data-emoji="${CSS.escape(emo)}"]`);
		  if (!chip){
			if ((data.count||0) <= 0) continue;
			chipsWrap.insertAdjacentHTML('afterbegin', 
			  `<button class="mz-chip" data-type="chip" data-action="chat.react.toggle" data-msg="${mid}" data-emoji="${emo}" aria-pressed="false">
				 <span class="emo">${emo}</span> <span class="cnt">${data.count}</span>
			   </button>`);
			chip = chipsWrap.querySelector(`.mz-chip[data-emoji="${CSS.escape(emo)}"]`);
		  } else {
			const cntEl = chip.querySelector('.cnt');
			if (cntEl) cntEl.textContent = data.count;
		  }
		  chip.classList.toggle('is-mine', !!data.me);
		  chip.setAttribute('aria-pressed', data.me ? 'true' : 'false');
		}

		// —É–¥–∞–ª–∏—Ç—å —Ç–µ, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ summary –∏–ª–∏ cnt=0
		for (const chip of domChips){
		  const emo = chip.getAttribute('data-emoji');
		  const rec = byEmoji.get(emo);
		  if (!rec || (rec.count||0) <= 0){
			chip.remove();
		  }
		}
	  }

	  // –∑–∞—á–∏—Å—Ç–∫–∞: –µ—Å–ª–∏ –ø–æ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω–æ–º—É id —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –ü–£–°–¢–û–ô —Å–ø–∏—Å–æ–∫ ([]) –∏–ª–∏ –≤–æ–æ–±—â–µ –Ω–µ –≤–µ—Ä–Ω—É–ª –∫–ª—é—á (–Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ—Å–ª–µ —Ñ–∏–∫—Å–∞),
	  // —Ç–æ –ø—Ä–æ—Å—Ç–æ —É–±–∏—Ä–∞–µ–º –≤—Å–µ —á–∏–ø—ã
	  if (Array.isArray(idsRequested)){
		for (const mid of idsRequested){
		  if (processed.has(mid)) continue;
		  const wrap = $list.querySelector(`.mz-msg[data-id="${mid}"] .mz-reactions .mz-chips`);
		  if (!wrap) continue;
		  wrap.querySelectorAll('.mz-chip').forEach(node => node.remove());
		}
	  }
	}

    
    // –í—ã–∑–æ–≤ —Å–≤–æ–¥–∫–∏ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
	async function refreshReactions(){
	  const ids = collectMessageIdsForSync();
	  if (!ids.length) return;
	  try{
		const qs = ids.join(',');              // –±–µ–∑ encodeURIComponent, —á—Ç–æ–±—ã –∑–∞–ø—è—Ç–∞—è –Ω–µ –ø—Ä–µ–≤—Ä–∞—Ç–∏–ª–∞—Å—å –≤ %2C
		const r = await api(`${V5_API}/chat/${encodeURIComponent(code)}/react_summary?ids=${qs}`);
		applyReactionSummary(r?.summary || {}, ids);  // ‚Üê –ø–µ—Ä–µ–¥–∞—ë–º ids
	  }catch(e){}
	}


    const appendMessages = (items)=>{
      const atBottom = $list.scrollTop + $list.clientHeight >= ($list.scrollHeight - 28);
      const html = items.map(renderMsg).join('');
      $list.insertAdjacentHTML('beforeend', html);
		// —Å–Ω–∏–º–∞–µ–º –∫–ª–∞—Å—Å –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏—è
		$list.addEventListener('animationend', (e)=>{
		  const node = e.target.closest('.mz-msg.mz-msg-new');
		  if (node){
			node.classList.remove('mz-msg-new');
		  }
		});

      // –ü–æ–ø—Ä–æ—Å–∏—Ç—å –±—ç–∫ –≤—ã–¥–∞—Ç—å –∫—Ä–∞—Å–∏–≤—ã–µ –∏–º–µ–Ω–∞
      items.forEach(m => {
        if (m && (m.author_email || '').trim()) {
          ensureDisplayNameForMessage(m);
        }
      });

      if (firstPaint || atBottom) $list.scrollTop = $list.scrollHeight + 1000;
      firstPaint = false;
    };

function scopeQS(extra = '') {
  const base = (chatKind === 'dm')
    ? `kind=dm&peer_id=${encodeURIComponent(peerId || '')}`
    : `kind=course`;

  if (!extra) return `?${base}`;
  return `?${base}&${extra}`;
}


async function ensurePeers() {
  if (peers) return peers;
  const r = await api(`${V5_API}/chat/${encodeURIComponent(code)}/dm_peers`);
  peers = Array.isArray(r?.peers) ? r.peers : [];
  window.__dmMode = r?.mode || null; // "teacher" | "student"
  return peers;
}

function resetFeed() {
  lastId = 0;
  firstPaint = true;
  $list.innerHTML = '';
}

function fillTeacherSelect(list) {
  if (!$tsel) return;
  $tsel.innerHTML = '';
  for (const t of list) {
    const opt = document.createElement('option');
    opt.value = String(t.id);

    const base = t.name || t.email || (`Usuario #${t.id}`);
    opt.textContent = base;
    opt.setAttribute('data-base', base);

    $tsel.appendChild(opt);
  }
}

function updateTeacherSelectUnread(mp){
  if (!$tsel) return;

  const selected = $tsel.value;

  // 1) –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç—ã option
  for (const opt of Array.from($tsel.options)){
    const id = String(opt.value || '');
    const base = opt.getAttribute('data-base') || opt.textContent || '';
    const n = parseInt((mp && mp[id]) || 0, 10) || 0;

    if (n > 0) opt.textContent = `‚Ä¢ ${base} (${n})`;
    else       opt.textContent = base;

    opt.setAttribute('data-unread', String(n));
  }

  // 2) —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ –Ω–∞–≤–µ—Ä—Ö, –∑–∞—Ç–µ–º –ø–æ –∏–º–µ–Ω–∏
  const opts = Array.from($tsel.options);
  opts.sort((a,b)=>{
    const na = parseInt(a.getAttribute('data-unread') || '0', 10) || 0;
    const nb = parseInt(b.getAttribute('data-unread') || '0', 10) || 0;
    if (nb !== na) return nb - na;

    const an = (a.getAttribute('data-base') || a.textContent || '').replace(/^‚Ä¢\s*/,'');
    const bn = (b.getAttribute('data-base') || b.textContent || '').replace(/^‚Ä¢\s*/,'');
    return an.localeCompare(bn, 'es', { sensitivity:'base' });
  });

  $tsel.innerHTML = '';
  for (const o of opts) $tsel.appendChild(o);

  // –≤–µ—Ä–Ω—É—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ–±—Ä–∞—Ç–Ω–æ
  if (selected) $tsel.value = selected;
}


async function refreshPeersUnread(){
  // –µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–≤ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω ‚Äî –ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å
  if (!peers) {
    try { await ensurePeers(); } catch(e) {}
  }
  if (!peers || !peers.length) {
    // –Ω–µ—á–µ–≥–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å
    const $dmTotal = root.querySelector('#mz-dm-total');
    if ($dmTotal){ $dmTotal.textContent=''; $dmTotal.style.display='none'; }
    return 0;
  }

  const r = await api(`${V5_API}/chat/${encodeURIComponent(code)}/dm_unread_map`, { quiet:true });
  if (!r) return 0; // ‚Üê 503/404/—Å–µ—Ç—å

const mp = r.map || {};
let total = 0;

for (const p of peers){
  const n = parseInt(mp[String(p.id)] || 0, 10) || 0;
  total += n;
}
updateTeacherSelectUnread(mp);


  const $dmTotal = root.querySelector('#mz-dm-total');
  if ($dmTotal){
    if (total > 0){ $dmTotal.textContent = String(total); $dmTotal.style.display = ''; }
    else { $dmTotal.textContent=''; $dmTotal.style.display='none'; }
  }

  return total;
}

async function refreshTopBadges(){
  const dmTotal = await refreshPeersUnread();

  const rCourse = await api(`${V5_API}/chat/${encodeURIComponent(code)}/unread?kind=course`, { quiet:true });
  const courseTotal = rCourse ? (parseInt(rCourse.unread || 0,10) || 0) : 0;

  setMainChatBadge(dmTotal + courseTotal);
}




async function setChatKind(kind) {
  chatKind = (kind === 'dm') ? 'dm' : 'course';
  $tabs.forEach(b => b.classList.toggle('is-active', b.dataset.chatKind === chatKind));

  if (chatKind === 'dm') {
    const list = await ensurePeers();
    fillTeacherSelect(list);

    if (!list.length) {
      chatKind = 'course';
      $tabs.forEach(b => b.classList.toggle('is-active', b.dataset.chatKind === chatKind));
      peerId = null;
      if ($tsel) $tsel.style.display = 'none';
      if ($title) $title.textContent = 'Chat del curso';
      resetFeed();
      await fetchMore();
      await updateUnreadBadge();
      await refreshTopBadges();
      return;
    }

    peerId = peerId || list[0].id;

    if ($tsel) {
      $tsel.style.display = 'inline-block';
      $tsel.value = String(peerId);
    }

    const mode = window.__dmMode;
    if ($title) $title.textContent = (mode === 'teacher') ? 'Chat con alumno' : 'Chat con docente';

    await refreshPeersUnread();
  } else {
    peerId = null;
    if ($tsel) $tsel.style.display = 'none';
    if ($title) $title.textContent = 'Chat del curso';
  }

  resetFeed();
  await fetchMore();
  await refreshReactions();
  await refreshDeleted();
  await refreshPeersUnread();
  await updateUnreadBadge();
  await refreshTopBadges();
  markRead();
}



    const fetchMore = async ()=>{
      if (loading) return; loading = true;
      try{
        const r = await api(`${V5_API}/chat/${encodeURIComponent(code)}/messages${scopeQS(`after_id=${lastId}&limit=50`)}`);

        const items = Array.isArray(r?.items) ? r.items : [];
        if (items.length){
          appendMessages(items);
          lastId = r.last_id || lastId;
          maybeMarkRead();
        }
      }catch(e){ console.warn('chat fetch', e); }
      finally{ loading = false; }
    };

const updateUnreadBadge = async ()=>{
  try{
    if (chatKind === 'dm' && !peerId) return;
    const r = await api(`${V5_API}/chat/${encodeURIComponent(code)}/unread${scopeQS()}`);
    const n = parseInt(r?.unread || 0,10);

    $unr.textContent = n>0 ? `${n} nuevos` : '';
    $unr.style.display = n>0 ? '' : 'none';
  }catch(e){}
};


const markRead = async ()=>{
  if (!lastId) return;
  if (chatKind === 'dm' && !peerId) return;
  try{
    const body = { last_id: lastId, kind: chatKind };
    if (chatKind === 'dm') body.peer_id = peerId;
    await api(`${V5_API}/chat/${encodeURIComponent(code)}/read`, { method:'POST', body });
  }catch(e){}
  updateUnreadBadge();
  await refreshPeersUnread();

};

    const maybeMarkRead = ()=>{ const atBottom = $list.scrollTop + $list.clientHeight >= ($list.scrollHeight - 10); if (atBottom) markRead(); };

    // ==== Picker de reacciones (tipo WhatsApp) ====
    const pickerEmojis = ['üëç','‚ù§Ô∏è','üéâ','üòÇ','ü§î','üî•'];
    let openPicker = null; // {msg, el}

    function closePicker(){
      if (openPicker && openPicker.el && openPicker.el.parentNode){
        openPicker.el.parentNode.removeChild(openPicker.el);
      }
      openPicker = null;
    }

function showPicker(btn){
  closePicker();

  const msg = btn.getAttribute('data-msg');
  const box = document.createElement('div');
  box.className = 'mz-picker';
  box.setAttribute('data-msg', msg);
  box.innerHTML = pickerEmojis
    .map(e => `<button class="mz-emoji" data-type="pick" data-msg="${msg}" data-emoji="${e}" title="Reaccionar ${e}">${e}</button>`)
    .join('');

  // –í–°–¢–ê–í–õ–Ø–ï–ú –í–ù–£–¢–†–¨ root, —á—Ç–æ–±—ã root.addEventListener('click', ‚Ä¶) –≤–∏–¥–µ–ª –∫–ª–∏–∫–∏
  root.appendChild(box);

  const btnRect = btn.getBoundingClientRect();
  const boxRect = box.getBoundingClientRect();
  const vw = window.innerWidth;
  const vh = window.innerHeight;

  let left = btnRect.left + btnRect.width / 2 - boxRect.width / 2;
  let top  = btnRect.top - boxRect.height - 8;

  if (top < 8){
    top = btnRect.bottom + 8;
  }
  if (left < 8) left = 8;
  if (left + boxRect.width > vw - 8) left = vw - boxRect.width - 8;
  if (top + boxRect.height > vh - 8) top = vh - boxRect.height - 8;

  box.style.left = `${left}px`;
  box.style.top  = `${top}px`;

  openPicker = { msg, el: box };
}



    document.addEventListener('click', (ev)=>{
      if (!openPicker) return;
      const inside = ev.target.closest('.mz-picker, .mz-react-btn');
      if (!inside) closePicker();
    });

    // ===== Reacciones: UNA por usuario ‚Äî chips s√≥lo >0; quitar chip en 0 =====
    root.addEventListener('click', async (e)=>{

// abrir picker (–Ω–æ –Ω–µ –Ω–∞ —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö)
const openBtn = e.target.closest('.mz-react-btn');
if (openBtn){
  const msgNode = openBtn.closest('.mz-msg');
  if (msgNode && msgNode.classList.contains('me')) {
    return; // —Å–≤–æ–∏ ‚Äî –∏–≥–Ω–æ—Ä
  }
  showPicker(openBtn);
  return;
}

	// eliminar mensaje (solo docentes)
	const del = e.target.closest('.mz-msg-del');
	if (del){
	  const msgId = del.getAttribute('data-msg');
	  if (msgId && confirm('¬øEliminar este mensaje para todos?')){
		try{
		  await api(`${V5_API}/chat/${encodeURIComponent(code)}/messages/${encodeURIComponent(msgId)}`, { method:'DELETE' });
		  const node = root.querySelector(`.mz-msg[data-id="${msgId}"]`);
		  if (node) node.remove(); // –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ —É–±–∏—Ä–∞–µ–º –∏–∑ DOM
		  burst();
		  await refreshDeleted();  // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
		}catch(err){
		  alert('No se pudo eliminar.');
		}
	  }
	  return;
	}


const btn = e.target.closest('.mz-chip, .mz-emoji');
if (!btn) return;

// –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ–º —Å—Ç–∞–≤–∏—Ç—å/–º–µ–Ω—è—Ç—å —Ä–µ–∞–∫—Ü–∏—é –Ω–∞ —Å–≤–æ—ë–º —Å–æ–æ–±—â–µ–Ω–∏–∏
const msgNode = btn.closest('.mz-msg');
if (msgNode && msgNode.classList.contains('me')){
  return;
}

	
      const msg = btn.getAttribute('data-msg');
      const emoji = btn.getAttribute('data-emoji');
      if (!msg || !emoji) return;

      const isChip = btn.classList.contains('mz-chip');
      btn.classList.add('pop'); setTimeout(()=>btn.classList.remove('pop'), 120);

      const wrap = root.querySelector(`.mz-msg[data-id="${msg}"] .mz-reactions`);
      const chipsWrap = wrap?.querySelector('.mz-chips');
      const chips = chipsWrap ? Array.from(chipsWrap.querySelectorAll('.mz-chip')) : [];
      const currentMine = chips.find(c => c.getAttribute('aria-pressed') === 'true');

      try{
        if (isChip){
          const pressed = btn.getAttribute('aria-pressed') === 'true';
          const cntEl = btn.querySelector('.cnt');
          let cnt = parseInt(cntEl.textContent|| (pressed?'1':'0'), 10);

          if (pressed){
            // quitar mi reacci√≥n
            cnt = Math.max(0, cnt-1);
            if (cnt === 0) { btn.remove(); } else { cntEl.textContent = cnt; }
            btn.classList.remove('is-mine'); btn.setAttribute('aria-pressed','false');
            await api(`${V5_API}/chat/${encodeURIComponent(code)}/react?msg_id=${msg}&emoji=${encodeURIComponent(emoji)}`, { method:'DELETE' });
          } else {
            // si ten√≠a otra, b√°jala (y oculta si llega a 0)
            if (currentMine && currentMine !== btn){
              const cnt2 = currentMine.querySelector('.cnt');
              const v = Math.max(0, parseInt(cnt2.textContent||'1',10)-1);
              if (v===0) currentMine.remove(); else cnt2.textContent = v;
              currentMine.classList.remove('is-mine');
              currentMine.setAttribute('aria-pressed','false');
            }
            // subir la nueva
            cntEl.textContent = cnt+1;
            btn.classList.add('is-mine'); btn.setAttribute('aria-pressed','true');
            await api(`${V5_API}/chat/${encodeURIComponent(code)}/react?msg_id=${msg}&emoji=${encodeURIComponent(emoji)}`, { method:'POST' });
          }
        } else {
          // picker emoji: establece mi √∫nica reacci√≥n
          // 1) baja la anterior
          if (currentMine){
            const cnt2 = currentMine.querySelector('.cnt');
            const v = Math.max(0, parseInt(cnt2.textContent||'1',10)-1);
            if (v===0) currentMine.remove(); else cnt2.textContent = v;
            currentMine.classList.remove('is-mine');
            currentMine.setAttribute('aria-pressed','false');
          }
          // 2) sube o crea chip –Ω–æ–≤–æ–≥–æ —ç–º–æ–¥–∑–∏
          let chip = chips.find(c => c.getAttribute('data-emoji') === emoji);
          if (!chip && chipsWrap){
            chipsWrap.insertAdjacentHTML('afterbegin', `<button class="mz-chip" data-type="chip" data-msg="${msg}" data-emoji="${emoji}" aria-pressed="false"><span class="emo">${emoji}</span> <span class="cnt">0</span></button>`);
            chip = chipsWrap.querySelector(`.mz-chip[data-emoji="${CSS.escape(emoji)}"]`);
          }
          if (chip){
            const cnt = chip.querySelector('.cnt');
            cnt.textContent = parseInt(cnt.textContent||'0',10)+1;
            chip.classList.add('is-mine'); chip.setAttribute('aria-pressed','true');
          }
          await api(`${V5_API}/chat/${encodeURIComponent(code)}/react?msg_id=${msg}&emoji=${encodeURIComponent(emoji)}`, { method:'POST' });
          closePicker();
        }

        burst();
        refreshReactions();
      } catch(err){
        console.warn('react failed', err);
        fetchMore(); // resync si algo fall√≥
      }
    });


$tabs.forEach(btn => btn.addEventListener('click', () => setChatKind(btn.dataset.chatKind)));

if ($tsel) {
  $tsel.addEventListener('change', async () => {
    peerId = parseInt($tsel.value || '0', 10) || null;
    resetFeed();
    await fetchMore();
    await refreshReactions();
    await refreshDeleted();
    await updateUnreadBadge();
    markRead();
	await refreshTopBadges();

  });
}


    // ===== Env√≠o =====
  const MAX_FILE_MB = 50;  // –ø–æ–¥—Å—Ç—Ä–æ–π –ø–æ–¥ —Å–≤–æ–π –ª–∏–º–∏—Ç —Å–µ—Ä–≤–µ—Ä–∞

  $send.onclick = async ()=>{
    const text = $in.value.trim();
    const hasFile = $file.files && $file.files[0];

    if (!text && !hasFile) return;

    // --- –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–∞ ---
    if (hasFile){
      const file = $file.files[0];
      const sizeMb = file.size / (1024 * 1024);

      if (sizeMb > MAX_FILE_MB){
        alert(`Archivo demasiado grande (m√°x. ${MAX_FILE_MB} MB).`);
        return;
      }

      const allowedTypes = [
        'image/',                 // –ª—é–±—ã–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏
        'application/pdf',
        'application/msword',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'application/vnd.ms-excel',
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
      ];

      const ok = allowedTypes.some(t => {
        if (t.endsWith('/')) return file.type.startsWith(t);  // image/*
        return file.type === t;
      });

      if (!ok){
        alert('Tipo de archivo no permitido. Usa PDF, im√°genes o documentos Office.');
        return;
      }
    }

    try{
if (hasFile){
  const fd = new FormData();
  if (text) fd.append('body', text);
  fd.append('file', $file.files[0]);

  fd.append('kind', chatKind);
  if (chatKind === 'dm') fd.append('peer_id', String(peerId || ''));

  await api(`${V5_API}/chat/${encodeURIComponent(code)}/messages`, {
    method:'POST',
    body: fd
  });
} else {
  if (chatKind === 'dm' && !peerId){
    alert('Selecciona un usuario.');
    return;
  }
  await api(`${V5_API}/chat/${encodeURIComponent(code)}/messages`, {
    method:'POST',
    body: (chatKind === 'dm')
      ? { body: text, kind: 'dm', peer_id: peerId }
      : { body: text, kind: 'course' }
  });
}
 
      $in.value = '';
      $file.value = '';

      await fetchMore();
      await refreshReactions();
      await refreshDeleted();
      await updateUnreadBadge();
      $list.scrollTop = $list.scrollHeight + 1000;

    } catch(e){
      console.warn('send failed', e);
      const msg = (e && (e.message || e.code))
        ? `${e.message} (${e.code||''})`
        : 'Error al enviar';
      alert(msg);
    }

    burst();
  };


    // menores
    $att.onclick = ()=> $file.click();
    const composeEmojis = [
      'üòÄ','üòÅ','üòÇ','ü§£','üòä','üòâ','üòç','üòò',
      'üòé','ü§©','ü•≥','ü§ó','üôÇ','üôÉ','üòá','üòÖ',
      'ü§î','üòè','üò¥','ü§§','üò≠','üò§','üò±','ü§Ø',
      'üëç','üëé','üôè','üëè','üôå','üî•','‚ù§Ô∏è','üíØ'
    ];
    // –ú–µ–Ω—é (–ª–µ–Ω–∏–≤–æ —Å–æ–∑–¥–∞—ë–º –ø–æ –ø–µ—Ä–≤–æ–º—É –∫–ª–∏–∫—É)
    let composeMenu = null;
    function ensureComposeMenu(){
      if (composeMenu) return composeMenu;
      const el = document.createElement('div');
      el.className = 'mz-emo-menu';
      el.setAttribute('role','menu');
      el.innerHTML = composeEmojis.map(e=>`<button class="itm" type="button" data-emo="${e}" title="${e}">${e}</button>`).join('');
      document.body.appendChild(el);
      composeMenu = el;
      // –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∏–∫–æ–≤ –ø–æ —ç–º–æ–¥–∑–∏
      el.addEventListener('click', (ev)=>{
        const b = ev.target.closest('.itm'); if (!b) return;
        const emo = b.getAttribute('data-emo'); if (!emo) return;
        insertEmojiAtCaret(emo + ' ');
        closeComposeMenu();
      });
      return el;
    }
    function openComposeMenu(anchorBtn){
      const el = ensureComposeMenu();
      el.style.display = 'grid';
      // –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –ø–æ–¥ –∫–Ω–æ–ø–∫–æ–π
      const r = anchorBtn.getBoundingClientRect();
      const pad = 6;
      let top = r.bottom + pad;
      let left = r.left;
      const vw = window.innerWidth, vh = window.innerHeight;
      const rectW = el.offsetWidth || 320, rectH = el.offsetHeight || 220;
      if (left + rectW > vw - 8) left = vw - rectW - 8;
      if (top + rectH > vh - 8) top = r.top - rectH - pad; // –≤–≤–µ—Ä—Ö, –µ—Å–ª–∏ –Ω–µ –≤–ª–∞–∑–∏—Ç –≤–Ω–∏–∑
      el.style.top = `${Math.max(8, top)}px`;
      el.style.left = `${Math.max(8, left)}px`;
    
      // –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ / ESC / —Å–∫—Ä–æ–ª–ª/resize
      setTimeout(()=>{
        document.addEventListener('click', onComposeOuter, {capture:true, once:true});
        window.addEventListener('keydown', onComposeKey, {once:true});
        window.addEventListener('scroll', closeComposeMenu, {once:true});
        window.addEventListener('resize', closeComposeMenu, {once:true});
      }, 0);
    }
    function closeComposeMenu(){
      if (!composeMenu) return;
      composeMenu.style.display = 'none';
    }
    function onComposeOuter(ev){
      if (!composeMenu) return;
      const inside = ev.target.closest('.mz-emo-menu') || ev.target.closest('#mz-emoji');
      if (!inside) closeComposeMenu();
    }
    function onComposeKey(ev){
      if (ev.key === 'Escape') closeComposeMenu();
    }
    function insertEmojiAtCaret(emoji){
      const el = $in;
      el.focus();
      const start = el.selectionStart ?? el.value.length;
      const end   = el.selectionEnd ?? el.value.length;
      const before = el.value.slice(0, start);
      const after  = el.value.slice(end);
      el.value = before + emoji + after;
      const newPos = start + emoji.length;
      el.setSelectionRange(newPos, newPos);
    }
    
function setMainChatBadge(n){
  const tab = document.querySelector('a[data-tab="chat"]');
  if (!tab) return;

  const b = tab.querySelector('.mz-main-chat-badge');
  if (!b) return;

  const txt = b.querySelector('.txt');
  if (n > 0){
    txt.textContent = String(n);
    b.style.display = 'inline-flex';
  } else {
    b.style.display = 'none';
  }
}


	
    // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –ø–∏–∫–µ—Ä–∞ –Ω–∞ –∫–Ω–æ–ø–∫–µ üôÇ
    $emo.addEventListener('click', (ev)=>{
      ev.stopPropagation();
      if (composeMenu && composeMenu.style.display !== 'none' && composeMenu.style.display !== ''){
        closeComposeMenu();
      } else {
        openComposeMenu($emo);
      }
    });
    $in.addEventListener('keydown', (e)=>{ if ((e.ctrlKey || e.metaKey) && e.key==='Enter'){ e.preventDefault(); $send.click(); } });

    // Boot y polling
	await fetchMore();
	await refreshReactions();
	await refreshDeleted();

	// –±–µ–π–¥–∂–∏ ‚Äî –î–û markRead, –∏–Ω–∞—á–µ —Ç—ã –∏—Ö —Å–∞–º –æ–±–Ω—É–ª—è–µ—à—å
	await refreshTopBadges();

	// –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫—Ä–∞—Å–Ω—ã–π —Å–ø—Ä–∞–≤–∞ (–¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ scope)
	await updateUnreadBadge();

	// markRead –ø–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ UI —É—Å–ø–µ–ª –ø–æ–∫–∞–∑–∞—Ç—å –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
	setTimeout(() => { markRead(); }, 250);


    function burst(){ burstUntil = Date.now() + 10000; }
    const ticker = async ()=>{
      if (stopPoll) return;
      await fetchMore();
	  await refreshTopBadges();
	  await refreshReactions();
	  await refreshDeleted();
	  await refreshPeersUnread();

	  await updateUnreadBadge();
      const now = Date.now();
      setTimeout(ticker, (now < burstUntil) ? (1200 + Math.floor(Math.random()*400))
                                            : (6500 + Math.floor(Math.random()*1500)));
    };
    setTimeout(ticker, 3000);

    const onVis = ()=> { 
      if (!document.hidden) { 
        maybeMarkRead(); 
        refreshReactions(); 
        refreshDeleted();
        updateUnreadBadge(); 
      }
    };
    document.addEventListener('visibilitychange', onVis);
})();
</script>
