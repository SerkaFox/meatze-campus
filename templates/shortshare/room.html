{% extends "base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'meatze/site.css' %}?v={% now 'U' %}">

<div class="mz-page mz-auth-page">

  <div class="mz-auth-card">

    <!-- HEADER -->
    <div class="mz-auth-h">
      <h3 class="mz-auth-title">
        Room Â· CÃ³digo {{ room.code }}
      </h3>

      <a class="mz-btn ghost sm" href="/room/">
        Cambiar cÃ³digo
      </a>
    </div>

    <div class="mz-auth-b">

<div class="mz-help" style="margin-bottom:14px;">
  <div style="font-weight:900; margin-bottom:6px;">âœ… CÃ³mo usar esta Room</div>

  <div>ğŸ“ <b>Subir archivo:</b> arrastra el archivo o pulsa <b>Elegir archivo</b>.</div>

  <div>â¬‡ï¸ <b>Descargar archivo:</b> pulsa <b>Descargar</b> o haz clic en el nombre del archivo.</div>

  <div>ğŸ”— <b>Compartir enlace:</b> pega una URL en la secciÃ³n â€œEnlacesâ€ y pulsa <b>AÃ±adir</b>.</div>

  <div>ğŸ–± <b>Para abrir un enlace:</b> haz clic sobre el tÃ­tulo azul. Se abrirÃ¡ en una nueva pestaÃ±a.</div>

  <div>â³ Los archivos se borran en <b>7 dÃ­as</b>.  
  Los enlaces duran <b>30 minutos</b>.</div>
</div>
<div style="
  margin-top:6px;
  padding:12px 14px;
  border:1px solid rgba(255,255,255,.10);
  border-radius:16px;
  background:rgba(255,255,255,.03);
">
  <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
    <div style="font-weight:900;">ğŸ”— Enlaces (30 min)</div>
    <div class="mz-help">Se borran automÃ¡ticamente.</div>
  </div>

  <!-- add link -->
  <div style="display:grid; grid-template-columns:1fr 170px auto; gap:8px; margin-top:10px;">
    <input id="linkUrl" class="mz-inp" placeholder="Pega un enlace (https://...)" style="border-radius:999px;">
    <input id="linkTitle" class="mz-inp" placeholder="TÃ­tulo (opcional)" style="border-radius:999px;">
    <button id="linkAddBtn" class="mz-btn sm" type="button">AÃ±adir</button>
  </div>

  <div id="linkErr" class="mz-bad" style="display:none; margin-top:10px;"></div>

  <!-- list -->
  <div id="linkList" style="margin-top:12px;">
    {% if links %}
      {% for l in links %}
        <div class="mz-link-row" data-link-id="{{ l.id }}" style="
          display:flex; justify-content:space-between; align-items:flex-start;
          gap:10px; padding:10px 0; border-top:1px solid rgba(255,255,255,.08);
        ">
          <div style="min-width:0;">
            <div style="font-weight:900; word-break:break-word;">
              <a href="{{ l.url }}" target="_blank" rel="noopener noreferrer"
                 style="text-decoration:underline; color:#38bdf8;">
                {% if l.title %}{{ l.title }}{% else %}{{ l.url }}{% endif %}
              </a>
            </div>
            {% if l.title %}
              <div class="mz-help" style="word-break:break-word;">{{ l.url }}</div>
            {% endif %}
            <div class="mz-help" data-link-expires="{{ l.expires_at|date:'U' }}"></div>
          </div>

          <div style="text-align:right; flex:0 0 auto;">
		  <button class="mz-btn ghost sm" type="button" data-link-ext="{{ l.id }}" data-mins="30">+30 min</button>
		  <button class="mz-btn ghost sm" type="button" data-link-ext="{{ l.id }}" data-mins="1440">+1 dÃ­a</button>
            <button class="mz-btn ghost sm" type="button" data-link-del="{{ l.id }}">Eliminar</button>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="mz-help">No hay enlaces todavÃ­a.</div>
    {% endif %}
  </div>
</div>

<hr class="sep">
      <!-- UPLOAD ZONE -->
      <div id="drop"
           style="
             margin-top:14px;
             border:1px dashed rgba(255,255,255,.35);
             border-radius:18px;
             padding:20px;
             text-align:center;
             background:rgba(255,255,255,.04);
             transition:.15s ease;
           ">

        <div style="font-weight:800; margin-bottom:6px;">
          ğŸ“ Subir archivo
        </div>

        <button id="pickBtn" class="mz-btn sm" type="button">
          Elegir archivo
        </button>

        <input id="pick" type="file" hidden>
      </div>

      <div id="toast" class="mz-bad" style="display:none; margin-top:10px;"></div>

      <hr class="sep">

      <!-- FILE LIST -->
      {% if files %}
	  <div id="fileList">
        {% for f in files %}
		<div style="
		  display:flex;
		  justify-content:space-between;
		  align-items:flex-start;
		  gap:12px;
		  padding:12px 0;
		  border-bottom:1px solid rgba(255,255,255,.08);
		">
		  <div style="min-width:0;">
			<div style="display:flex; align-items:center; gap:8px; font-weight:900;">
			  <span title="Archivo">ğŸ“„</span>

			  <!-- Ğ¸Ğ¼Ñ: Ñ‚Ğ¾Ğ¶Ğµ ĞºĞ»Ğ¸ĞºĞ°Ğ±ĞµĞ»ÑŒĞ½Ğ¾ -->
			  <a href="{{ request.path }}f/{{ f.id }}/"
				 style="text-decoration:underline; color:#38bdf8; word-break:break-word;">
				{{ f.original_name }}
			  </a>

			  <span class="mz-help" style="font-size:12px; opacity:.85;">
				(clic para descargar)
			  </span>
			</div>

			<div class="mz-help">
			  â± {{ f.uploaded_at|date:"d/m/Y H:i" }}
			</div>
		  </div>

		  <div style="text-align:right; flex:0 0 auto; display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
			<div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
			  <!-- Ğ¯Ğ’ĞĞĞ¯ ĞºĞ½Ğ¾Ğ¿ĞºĞ° ÑĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ -->
				<a class="mz-btn ghost sm" href="{{ request.path }}v/{{ f.id }}/" title="Ver">
				  ğŸ‘ï¸ Ver
				</a>
				<a class="mz-btn sm" href="{{ request.path }}f/{{ f.id }}/" title="Descargar">
				  â¬‡ï¸ Descargar
				</a>

			  <!-- ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ĞºĞ°Ğº Ğ±Ñ‹Ğ»Ğ¾ -->
			  <button class="mz-btn ghost sm" type="button" data-del="{{ f.id }}" title="Eliminar">
				ğŸ—‘ Eliminar
			  </button>
			</div>

			<div data-bytes="{{ f.size }}" style="font-weight:800;"></div>
			<div class="mz-help" data-expires="{{ f.expires_at|date:'U' }}"></div>
		  </div>
		</div>
        {% endfor %}
		</div>
      {% else %}
        <div class="mz-help">
          AÃºn no hay archivos en esta room.
        </div>
      {% endif %}

    </div>
  </div>
</div>
<script>
(() => {
  const roomCode = "{{ room.code }}";
  const wsProto = (location.protocol === "https:") ? "wss" : "ws";
  const wsUrl = `${wsProto}://${location.host}/ws/shortshare/${roomCode}/`;
  let ws;

  function humanSize(bytes){
    const u=["B","KB","MB","GB"]; let i=0;
    while(bytes>=1024 && i<u.length-1){ bytes/=1024; i++; }
    return `${bytes.toFixed(i?1:0)} ${u[i]}`;
  }

  function escapeHtml(s){
    return (s || "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function renderFileRow(f){
    const fileList = document.getElementById("fileList");
    if(!fileList) return;

    const name = escapeHtml(f.name);
    const viewUrl = `${location.pathname}v/${f.id}/`;
    const dlUrl = `${location.pathname}f/${f.id}/`;

    const row = document.createElement("div");
    row.dataset.fileId = String(f.id);
    row.style.cssText = `
      display:flex; justify-content:space-between; align-items:flex-start;
      gap:12px; padding:12px 0; border-bottom:1px solid rgba(255,255,255,.08);
    `;

    row.innerHTML = `
      <div style="min-width:0;">
        <div style="display:flex; align-items:center; gap:8px; font-weight:900;">
          <span title="Archivo">ğŸ“„</span>
          <a href="${dlUrl}" style="text-decoration:underline; color:#38bdf8; word-break:break-word;">
            ${name}
          </a>
          <span class="mz-help" style="font-size:12px; opacity:.85;">(clic para descargar)</span>
        </div>
        <div class="mz-help">â± just now</div>
      </div>

      <div style="text-align:right; flex:0 0 auto; display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
        <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
          <a class="mz-btn ghost sm" href="${viewUrl}" title="Ver">ğŸ‘ï¸ Ver</a>
          <a class="mz-btn sm" href="${dlUrl}" title="Descargar">â¬‡ï¸ Descargar</a>
          <button class="mz-btn ghost sm" type="button" data-del="${f.id}" title="Eliminar">ğŸ—‘ Eliminar</button>
        </div>
        <div style="font-weight:800;">${humanSize(parseInt(f.size||0,10))}</div>
        <div class="mz-help" data-expires="${f.expires_at}"></div>
      </div>
    `;

    // ÑƒĞ±Ğ¸Ñ€Ğ°ĞµĞ¼ "AÃºn no hay..."
    const empty = fileList.querySelector(".mz-help");
    if(empty && empty.textContent.includes("AÃºn no hay archivos")) empty.remove();

    fileList.prepend(row);
  }

  function removeFileRow(id){
    const el = document.querySelector(`[data-file-id="${id}"]`);
    if(el){
      el.animate([{opacity:1},{opacity:0, transform:"translateY(-4px)"}], {duration:180, easing:"ease-out"})
        .onfinish = ()=> el.remove();
    }
  }

  function onWsMessage(msg){
    if(!msg || !msg.type) return;

    if(msg.type === "file.created" && msg.file){
      // Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ Ğ´ÑƒĞ±Ğ»ĞµĞ¹
      if(document.querySelector(`[data-file-id="${msg.file.id}"]`)) return;
      renderFileRow(msg.file);
      return;
    }

    if(msg.type === "file.deleted"){
      removeFileRow(msg.id);
      return;
    }

	if(msg.type === "link.created" && msg.link){
	  if(!window.mzShortshare?.renderLinkRow) return;
	  if(document.querySelector(`[data-link-id="${msg.link.id}"]`)) return; // Ğ±ĞµĞ· Ğ´ÑƒĞ±Ğ»ĞµĞ¹
	  window.mzShortshare.renderLinkRow(msg.link);
	  return;
	}

	if(msg.type === "link.deleted"){
	  window.mzShortshare?.removeLinkRow?.(msg.id);
	  return;
	}

	if(msg.type === "link.extended"){
	  window.mzShortshare?.updateLinkExpiry?.(msg.id, msg.expires_at);
	  return;
	}
  }

  function connect(){
    ws = new WebSocket(wsUrl);

    ws.onmessage = (ev) => {
      try { onWsMessage(JSON.parse(ev.data)); } catch(e) {}
    };

    ws.onclose = () => {
      // Ğ°Ğ²Ñ‚Ğ¾-Ñ€ĞµĞºĞ¾Ğ½Ğ½ĞµĞºÑ‚
      setTimeout(connect, 1500);
    };
  }

  connect();
})();
</script>
<script>
(() => {

  const uploadUrl = "{{ request.path }}upload/";
  const drop = document.getElementById("drop");
  const pick = document.getElementById("pick");
  const pickBtn = document.getElementById("pickBtn");
  const toast = document.getElementById("toast");

  function showError(msg){
    toast.style.display = "block";
    toast.textContent = msg;
    setTimeout(()=>toast.style.display="none", 6000);
  }

  function humanSize(bytes){
    const u=["B","KB","MB","GB"];
    let i=0;
    while(bytes>=1024 && i<u.length-1){
      bytes/=1024; i++;
    }
    return `${bytes.toFixed(i?1:0)} ${u[i]}`;
  }

  document.querySelectorAll("[data-bytes]").forEach(el=>{
    el.textContent = humanSize(parseInt(el.dataset.bytes||"0",10));
  });

  function tick(){
    const now = Math.floor(Date.now()/1000);
    document.querySelectorAll("[data-expires]").forEach(el=>{
      const exp = parseInt(el.dataset.expires,10);
      const sec = exp-now;
      if(sec<=0){
        el.textContent="expirado";
        return;
      }
      const d=Math.floor(sec/86400);
      const h=Math.floor((sec%86400)/3600);
      if(d>0) el.textContent=`${d}d ${h}h`;
      else{
        const m=Math.floor((sec%3600)/60);
        const s=sec%60;
        el.textContent=`${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
      }
    });
  }
  setInterval(tick,1000);
  tick();

  function upload(file){
    return new Promise((resolve,reject)=>{
      const xhr=new XMLHttpRequest();
      const fd=new FormData();
      fd.append("file",file);
      xhr.open("POST",uploadUrl,true);

      xhr.onload=()=>{
        try{
          const j=JSON.parse(xhr.responseText||"{}");
          if(xhr.status>=200&&xhr.status<300&&j.ok) resolve(j);
          else reject(new Error(j.error||"Upload error"));
        }catch(e){
          reject(new Error("Upload error"));
        }
      };
      xhr.onerror=()=>reject(new Error("Network error"));
      xhr.send(fd);
    });
  }

  async function handle(file){
    try{
      await upload(file);
      location.reload();
    }catch(e){
      showError(e.message);
    }
  }

  pickBtn.addEventListener("click",()=>pick.click());
  pick.addEventListener("change",()=>handle(pick.files[0]));

  drop.addEventListener("dragover",e=>{
    e.preventDefault();
    drop.style.transform="scale(1.01)";
  });
  drop.addEventListener("dragleave",()=>{
    drop.style.transform="scale(1)";
  });
  drop.addEventListener("drop",e=>{
    e.preventDefault();
    drop.style.transform="scale(1)";
    handle(e.dataTransfer.files[0]);
  });

})();
</script><script>
(() => {
  function getCookie(name){
    const v = document.cookie.split(";").map(s=>s.trim()).find(s=>s.startsWith(name+"="));
    return v ? decodeURIComponent(v.split("=",2)[1]) : "";
  }
  const CSRF = getCookie("csrftoken");

  // ---------- FILE DELETE ----------
  document.addEventListener("click", async (e) => {
    const btn = e.target.closest("[data-del]");
    if(!btn) return;

    const id = btn.dataset.del;
    const pin = prompt("Introduce la contraseÃ±a para eliminar (cÃ³digo de la room):");
    if(pin === null) return;

    const fd = new FormData();
    fd.append("pin", pin.trim());

    const url = `${location.pathname}del/${id}/`;

    const r = await fetch(url, {
      method: "POST",
      body: fd,
      headers: {"X-CSRFToken": CSRF},
    });

    const j = await r.json().catch(()=>({}));
    if(!r.ok || !j.ok){
      alert(j.error || `Error (${r.status})`);
      return;
    }

    location.reload();
  });

  // ---------- LINKS ----------
  const linkUrl = document.getElementById("linkUrl");
  const linkTitle = document.getElementById("linkTitle");
  const linkAddBtn = document.getElementById("linkAddBtn");
  const linkErr = document.getElementById("linkErr");
  const linkList = document.getElementById("linkList");

  function showLinkErr(msg){
    if(!linkErr) return;
    linkErr.style.display = "block";
    linkErr.textContent = msg;
    setTimeout(()=>{ linkErr.style.display="none"; }, 6000);
  }

  function escapeHtml(s){
    return (s || "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function formatRemaining(sec){
    if(sec <= 0) return "expirado";
    const d = Math.floor(sec / 86400);
    const h = Math.floor((sec % 86400) / 3600);
    const m = Math.floor((sec % 3600) / 60);
    const s = sec % 60;
    if(d > 0) return `${d}d ${h}h`;
    if(h > 0) return `${h}h ${m}m`;
    return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
  }

  function linkTick(){
    const now = Math.floor(Date.now()/1000);
    document.querySelectorAll("[data-link-expires]").forEach(el=>{
      const exp = parseInt(el.dataset.linkExpires || "0", 10);
      const sec = exp - now;
      el.textContent = formatRemaining(sec);
      if(sec > 0 && sec < 120) el.style.color = "#f87171";
      else el.style.color = "";
    });
  }
  setInterval(linkTick, 1000);
  linkTick();

  function renderLinkCountdown(el, expTs){
    const now = Math.floor(Date.now()/1000);
    const sec = expTs - now;
    el.textContent = formatRemaining(sec);
    if(sec > 0 && sec < 120) el.style.color = "#f87171";
    else el.style.color = "";
  }

  function renderLinkRow(obj){
    if(!linkList) return;

    const title = obj.title ? escapeHtml(obj.title) : escapeHtml(obj.url);
    const url = escapeHtml(obj.url);
    const exp = String(obj.expires_at);

    const row = document.createElement("div");
    row.className = "mz-link-row";
    row.setAttribute("data-link-id", String(obj.id));
    row.style.cssText = "display:flex; justify-content:space-between; align-items:flex-start; gap:10px; padding:10px 0; border-top:1px solid rgba(255,255,255,.08);";

    row.innerHTML = `
      <div style="min-width:0;">
        <div style="font-weight:900; word-break:break-word;">
          <a href="${url}" target="_blank" rel="noopener noreferrer" style="text-decoration:underline; color:#38bdf8;">
            ${title}
          </a>
        </div>
        ${obj.title ? `<div class="mz-help" style="word-break:break-word;">${url}</div>` : ``}
        <div class="mz-help" data-link-expires="${exp}"></div>
      </div>

      <div style="text-align:right; flex:0 0 auto;">
        <button class="mz-btn ghost sm" type="button" data-link-ext="${obj.id}" data-mins="30">+30 min</button>
        <button class="mz-btn ghost sm" type="button" data-link-ext="${obj.id}" data-mins="1440">+1 dÃ­a</button>
        <button class="mz-btn ghost sm" type="button" data-link-del="${obj.id}">Eliminar</button>
      </div>
    `;

    linkList.prepend(row);
    const expEl = row.querySelector("[data-link-expires]");
    if(expEl) renderLinkCountdown(expEl, obj.expires_at);
  }
window.mzShortshare = window.mzShortshare || {};
window.mzShortshare.renderLinkRow = renderLinkRow;

window.mzShortshare.removeLinkRow = (id) => {
  const row = document.querySelector(`[data-link-id="${id}"]`);
  if(row) row.remove();
};

window.mzShortshare.updateLinkExpiry = (id, expires_at) => {
  const row = document.querySelector(`[data-link-id="${id}"]`);
  const expEl = row?.querySelector("[data-link-expires]");
  if(expEl) expEl.dataset.linkExpires = String(expires_at);
};
  // ADD LINK
  if(linkAddBtn){
    linkAddBtn.addEventListener("click", async ()=>{
      const urlVal = (linkUrl?.value || "").trim();
      const titleVal = (linkTitle?.value || "").trim();

      if(!urlVal){
        showLinkErr("Pega un enlace primero.");
        return;
      }

      const fd = new FormData();
      fd.append("url", urlVal);
      fd.append("title", titleVal);

      const url = `${location.pathname}link/add/`;

      linkAddBtn.disabled = true;
      try{
        const r = await fetch(url, {
          method: "POST",
          body: fd,
          headers: {"X-CSRFToken": CSRF},
        });

        const j = await r.json().catch(()=>({}));
        if(!r.ok || !j.ok){
          showLinkErr(j.error || `Error (${r.status})`);
          return;
        }

        if(linkUrl) linkUrl.value = "";
        if(linkTitle) linkTitle.value = "";

        // ÑƒĞ±Ñ€Ğ°Ñ‚ÑŒ "No hay enlaces todavÃ­a."
        const empty = linkList.querySelector(".mz-help");
        if(empty && empty.textContent.includes("No hay enlaces")) empty.remove();

        renderLinkRow(j);
      }catch(e){
        console.error(e);
        showLinkErr("Network error");
      }finally{
        linkAddBtn.disabled = false;
      }
    });
  }

  // EXTEND LINK (delegation)
  document.addEventListener("click", async (e)=>{
    const btn = e.target.closest("[data-link-ext]");
    if(!btn) return;

    const id = btn.dataset.linkExt;
    const mins = parseInt(btn.dataset.mins || "30", 10);

    const pin = prompt("Introduce la contraseÃ±a para extender (cÃ³digo de la room):");
    if(pin === null) return;

    const fd = new FormData();
    fd.append("pin", pin.trim());
    fd.append("mins", String(mins));

    const url = `${location.pathname}link/ext/${id}/`;

    btn.disabled = true;
    try{
      const r = await fetch(url, {
        method: "POST",
        body: fd,
        headers: {"X-CSRFToken": CSRF},
      });

      const j = await r.json().catch(()=>({}));
      if(!r.ok || !j.ok){
        alert(j.error || `Error (${r.status})`);
        return;
      }

      const row = btn.closest("[data-link-id]") || btn.closest(".mz-link-row");
      const expEl = row?.querySelector("[data-link-expires]");
      if(expEl){
        expEl.dataset.linkExpires = String(j.expires_at);
        renderLinkCountdown(expEl, j.expires_at);
      }
    }finally{
      btn.disabled = false;
    }
  });

  // DELETE LINK (delegation)
  document.addEventListener("click", async (e)=>{
    const btn = e.target.closest("[data-link-del]");
    if(!btn) return;

    const id = btn.dataset.linkDel;
    const pin = prompt("Introduce la contraseÃ±a para eliminar (cÃ³digo de la room):");
    if(pin === null) return;

    const fd = new FormData();
    fd.append("pin", pin.trim());

    const url = `${location.pathname}link/del/${id}/`;

    const r = await fetch(url, {
      method: "POST",
      body: fd,
      headers: {"X-CSRFToken": CSRF},
    });

    const j = await r.json().catch(()=>({}));
    if(!r.ok || !j.ok){
      alert(j.error || `Error (${r.status})`);
      return;
    }

    const row = btn.closest("[data-link-id]") || btn.closest(".mz-link-row");
    if(row){
      row.animate([{opacity:1},{opacity:0, transform:"translateY(-4px)"}], {duration:180, easing:"ease-out"})
        .onfinish = ()=> row.remove();
    }
  });

})();
</script>
{% endblock %}