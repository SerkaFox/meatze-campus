{% load static %}
<link rel="icon" href="{% static 'files/logo.png' %}?v={% now 'U' %}" type="image/png">
<link rel="shortcut icon" href="{% static 'files/logo.png' %}?v={% now 'U' %}" type="image/png">
<link rel="apple-touch-icon" href="{% static 'files/logo.png' %}?v={% now 'U' %}">
<link rel="icon" href="{% static 'favicon.png' %}">
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>{% block title %}MEATZE{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  {% block extra_head %}{% endblock %}

  <!-- –¢–í–û–ô site.css –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ static/meatze/ -->
  <link rel="stylesheet" href="{% static 'meatze/site.css' %}?v={% now 'U' %}">

  <!-- –ß–ê–¢: –±—ã–ª–æ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ -->
  <link rel="stylesheet" href="{% static 'meatze/chat_widget/chat-widget.css' %}">
  
<script>
  window.MEATZE = window.MEATZE || {};
  window.MEATZE.HELP_ATTENTION_ENABLED = true;       // –≤–∫–ª—é—á–∏—à—å –ø–æ—Ç–æ–º
  window.MEATZE.HELP_ATTENTION_STRONG = true;        // —Å–∏–ª—å–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è
  window.MEATZE.HELP_ATTENTION_STRICT = false;        // –º–∏–≥–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ä–µ–∞–ª—å–Ω–æ –µ—Å—Ç—å help
  window.MEATZE.HELP_ATTENTION_MAX_MS = 0;        // –∞–≤—Ç–æ-—Å—Ç–æ–ø —á–µ—Ä–µ–∑ 12—Å (12000 –º–æ–∂–Ω–æ 0 = –±–µ–∑ –ª–∏–º–∏—Ç–∞)
</script>
</head>

<body>

<header id="mz-top">
  <div class="mz-top-inner">
    <a href="/" class="mz-brand">
      <span>MEATZE</span>
      <span class="mz-brand-badge">Campus</span>
    </a>

    <div class="mz-top-right">
      <div class="mz-top-cta">
        <span>Formaci√≥n subvencionada</span>
      </div>

      {% if request.user.is_authenticated %}
        <div id="mz-acc" class="mz-acc">
          <button id="mz-acc-user" type="button" aria-expanded="false">
            <div class="mz-acc-avatar">
              {% with name=request.user.first_name|default:request.user.username %}
                {{ name|first|upper }}
              {% endwith %}
            </div>
            <div class="mz-acc-name">
              {% if request.user.profile.display_name %}
                {{ request.user.profile.display_name }}
              {% elif request.user.get_full_name %}
                {{ request.user.get_full_name }}
              {% else %}
                {{ request.user.username }}
              {% endif %}
            </div>
            <div class="mz-acc-arrow">‚ñæ</div>
          </button>

		<div id="mz-acc-menu" class="mz-acc-menu" aria-hidden="true">
		  <button class="mz-acc-item" type="button" data-action="panel">
			<span class="icon">üè†</span><span>Ir al panel</span>
		  </button>

		  <a class="mz-acc-item" href="/acceder/?tab=profile" data-action="profile" style="text-align:left">
			<span class="icon">üë§</span><span>Datos personales</span>
		  </a>

		  <hr style="border:none;border-top:1px solid #e5e7eb;margin:4px 0">

		  <button class="mz-acc-item" type="button" data-action="logout">
			<span class="icon">‚èè</span><span>Cerrar sesi√≥n</span>
		  </button>
		</div>

        </div>
      {% else %}
        <!-- –í–ê–ñ–ù–û: —Ç–µ–ø–µ—Ä—å Acceder –≤–µ–¥—ë—Ç –Ω–∞ /acceder/ (–±–µ–∑ –º–æ–¥–∞–ª–∫–∏) -->
        <a id="mz-btn-login" class="mz-btn-top" href="/acceder/">
          <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
            <polyline points="10 17 15 12 10 7"/>
            <line x1="15" y1="12" x2="3" y2="12"/>
          </svg>
          <span>Acceder</span>
        </a>
      {% endif %}
    </div>
  </div>
</header>

<div class="mz-page">
  {% block content %}{% endblock %}
</div>

<!-- ====== JS CORE ====== -->
<script>
  window.MEATZE = window.MEATZE || {};
  window.MEATZE.V5 = (location.origin + '/').replace(/\/$/, '') + '/meatze/v5';
</script>

<script src="{% static 'meatze/core/api.js' %}"></script>

<!-- ====== Account menu + logout (–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ–≤–µ–¥–µ–Ω–∏–µ, –Ω–æ –±–µ–∑ auth/profile –º–æ–¥–∞–ª–æ–∫) ====== -->
<script>
(function(){
  const wrap = document.getElementById('mz-acc');
  const btn  = document.getElementById('mz-acc-user');
  const menu = document.getElementById('mz-acc-menu');
  if (!wrap || !btn || !menu) return;

  function setOpen(v){
    btn.setAttribute('aria-expanded', v ? 'true' : 'false');
    menu.classList.toggle('show', v);
    menu.setAttribute('aria-hidden', v ? 'false' : 'true');
  }

  // open/close menu
  btn.addEventListener('click', function(e){
    e.preventDefault();
    e.stopPropagation();
    const open = btn.getAttribute('aria-expanded') !== 'true';
    setOpen(open);
  });

  document.addEventListener('click', function(e){
    if (!wrap.contains(e.target)) setOpen(false);
  });

  // actions
menu.addEventListener('click', async function(e){
  const item = e.target.closest('.mz-acc-item');
  if (!item) return;

  const action = item.dataset.action || '';

  // –ï—Å–ª–∏ —ç—Ç–æ <a> –±–µ–∑ action ‚Äî –ù–ï –º–µ—à–∞–µ–º –±—Ä–∞—É–∑–µ—Ä—É –ø–µ—Ä–µ–π—Ç–∏
  if (!action) return;

  e.preventDefault();

  if (action === 'profile') {
    window.location.href = '/acceder/?tab=profile';
    return;
  }
  if (action === 'panel') {
    window.location.href = '/alumno/';
    return;
  }
  if (action === 'logout') {
    try {
      await fetch('/meatze/v5/auth/logout', { method:'POST', credentials:'include' });
    } catch(e) {}
    window.location.href = '/';
  }
});

})();
</script>

<!-- ====== –ß–ê–¢: –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ ====== -->
{% include "includes/chat_widget.html" %}
<script src="{% static 'meatze/chat_widget/chat-widget.js' %}"></script>


{% block extra_js %}{% endblock %}

<!-- ===== HELP (global) ===== -->
<button type="button" id="mz-help-fab" class="mz-help-fab" aria-label="Ayuda" title="Ayuda">
  <span class="mz-help-icon">?</span>
  <span id="mz-help-badge" class="mz-help-badge" aria-hidden="true">Ver video</span>
</button>


<div id="mz-help-backdrop" class="mz-help-backdrop" aria-hidden="true"></div>
<script>
(function(){
  const btn = document.getElementById('mz-help-fab');
  if (!btn) return;

  function curPathOnly(){
    return location.pathname || "/";
  }
  function curQueryOnly(){
    return location.search ? location.search.slice(1) : "";
  }

function buildContextUrl(){
  const base = (window.MEATZE?.V5 || '/meatze/v5').replace(/\/$/, '');
  const dbg = new URLSearchParams(location.search).get("help_debug") === "1";
  const path = curPathOnly();
  const query = curQueryOnly();

  const ui = (window.MEATZE && window.MEATZE.HELP_UI) ? String(window.MEATZE.HELP_UI) : "";

  return base + '/help/context'
    + '?path=' + encodeURIComponent(path)
    + '&query=' + encodeURIComponent(query)
    + '&ui=' + encodeURIComponent(ui)           // ‚úÖ –î–û–ë–ê–í–ò–õ–ò
    + (dbg ? '&help_debug=1' : '');
}

  function openHelpWindowStub(){
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –°–†–ê–ó–£ –Ω–∞ –∫–ª–∏–∫, –∏–Ω–∞—á–µ popup-blocker –º–æ–∂–µ—Ç –∑–∞–ø—Ä–µ—Ç–∏—Ç—å
    const w = 1000;
	const h = 650;
    const left = Math.max(0, Math.round(window.screenX + (window.outerWidth - w) / 2));
    const top  = Math.max(0, Math.round(window.screenY + (window.outerHeight - h) / 2));

    const win = window.open(
      'about:blank',
      'MEATZE_HELP',
      `popup=yes,width=${w},height=${h},left=${left},top=${top}`
    );

    if (!win) return null;

    // –ø—Ä–æ—Å—Ç–∞—è –∑–∞–≥–ª—É—à–∫–∞ (–ø–æ–∫–∞ –≥—Ä—É–∑–∏–º –∫–æ–Ω—Ç–µ–∫—Å—Ç)
    win.document.open();
    win.document.write(`
      <!doctype html><html lang="es">
      <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <title>Ayuda</title>
        <style>
          html,body{height:100%;margin:0;background:#0b0b0b;color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
          .wrap{height:100%;display:flex;align-items:center;justify-content:center;padding:16px;text-align:center}
          .card{max-width:340px;border:1px solid #1f2937;background:#0f172a;border-radius:14px;padding:14px}
          .ttl{font-weight:800;margin-bottom:6px}
          .sm{opacity:.75;font-size:13px;line-height:1.35}
        </style>
      </head>
      <body>
        <div class="wrap">
          <div class="card">
            <div class="ttl">Cargando ayuda‚Ä¶</div>
            <div class="sm">No cierres esta ventana.</div>
          </div>
        </div>
      </body></html>
    `);
    win.document.close();
    return win;
  }

  function showNoHelp(win){
    try{
      win.document.open();
      win.document.write(`
        <!doctype html><html lang="es">
        <head>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width,initial-scale=1">
          <title>Ayuda</title>
          <style>
            html,body{height:100%;margin:0;background:#0b0b0b;color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
            .wrap{height:100%;display:flex;align-items:center;justify-content:center;padding:16px;text-align:center}
            .card{max-width:360px;border:1px solid #1f2937;background:#0f172a;border-radius:14px;padding:14px}
            .ttl{font-weight:900;margin-bottom:6px}
            .sm{opacity:.8;font-size:13px;line-height:1.35}
            .btn{margin-top:10px;background:#111827;border:1px solid #334155;color:#e5e7eb;border-radius:10px;padding:8px 10px;cursor:pointer}
          </style>
        </head>
        <body>
          <div class="wrap">
            <div class="card">
       <div class="ttl">No hay ayuda para esta p√°gina</div>
<div class="sm">A√±ade una vinculaci√≥n en HelpBinding (rol/path/query_contains).</div><button class="btn" onclick="window.close()">Cerrar</button>
            </div>
          </div>
        </body></html>
      `);
      win.document.close();
    }catch(e){}
  }

  btn.addEventListener('click', async (e)=>{
    e.preventDefault();

    const win = openHelpWindowStub();

    // –ï—Å–ª–∏ popup –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω ‚Äî –ø—Ä–æ—Å—Ç–æ —Å–∫–∞–∂–µ–º –≤ –∫–æ–Ω—Å–æ–ª—å (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ alert/—Ç–æ—Å—Ç)
    if (!win){
      console.warn("[HELP] Popup blocked. Allow popups for this site.");
      return;
    }

    const url = buildContextUrl();

    let data = null;
    try{
      const r = await fetch(url, { credentials:'include', cache:'no-store' });
      if (r.ok) data = await r.json();
    }catch(err){}

    if (!data || !data.ok || !data.embed_url){
      showNoHelp(win);
      return;
    }
	

    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ popup –Ω–∞ –≥–æ—Ç–æ–≤—ã–π embed URL
    // (—Ç—É—Ç —É–∂–µ –±—É–¥–µ—Ç —Ç–≤–æ–π embed_player.html —Å looping/only_one –∏ —Ç.–¥.)
    try{
      win.document.title = data.title || "Ayuda";
      win.location.href = data.embed_url;
      win.focus();
    }catch(err){
      // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
      showNoHelp(win);
    }
  });
    // ===== HELP ATTENTION (SAME SCOPE) =====
  (function(){
    if (!window.MEATZE || window.MEATZE.HELP_ATTENTION_ENABLED !== true) return;

	function pageKey(){
	  const path = location.pathname || "/";

	  const sp = new URLSearchParams(location.search || "");
	  const tab = (sp.get("tab") || "").trim();        // –≥–ª–∞–≤–Ω–æ–µ: tab
	  // –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –±–æ–ª–µ–µ granular ‚Äî —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π focus:
	  // const focus = (sp.get("focus") || "").trim();
	  // return `mz_help_seen::${path}::tab=${tab}::focus=${focus}`;

	  const role = (window.MEATZE && window.MEATZE.ROLE) ? String(window.MEATZE.ROLE) : "";
	  return `mz_help_seen::${role}::${path}::tab=${tab}`;
	}
	function markSeen(){
	  try { localStorage.setItem(pageKey(), "1"); } catch(e) {}
	}
    const key = pageKey();
    const seen = localStorage.getItem(key) === "1";

    function enable(){
      const strong = window.MEATZE.HELP_ATTENTION_STRONG === true;
      btn.classList.add(strong ? 'is-attn-strong' : 'is-attn');

      const badge = document.getElementById('mz-help-badge');
      if (badge) badge.setAttribute('aria-hidden', 'false');
    }

    function disable(){
      btn.classList.remove('is-attn');
      btn.classList.remove('is-attn-strong');

      const badge = document.getElementById('mz-help-badge');
      if (badge) badge.setAttribute('aria-hidden', 'true');
    }

    async function shouldBlink(){
      if (seen) return false;

      if (window.MEATZE.HELP_ATTENTION_STRICT !== true) return true;

      // strict: –º–∏–≥–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ä–µ–∞–ª—å–Ω–æ –µ—Å—Ç—å embed_url
      try{
        const r = await fetch(buildContextUrl(), { credentials:'include', cache:'no-store' });
        if (!r.ok) return false;
        const data = await r.json();
        return !!(data && data.ok && data.embed_url);
      }catch(e){
        return false;
      }
    }

    // –ø—Ä–∏ –∫–ª–∏–∫–µ ‚Äî –æ—Ç–º–µ—á–∞–µ–º –∏ –æ—Ç–∫–ª—é—á–∞–µ–º (–Ω–µ –ª–æ–º–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫)
    btn.addEventListener('click', function(){
      try { localStorage.setItem(key, "1"); } catch(e) {}
	  markSeen();
      disable();
    });

    (async function init(){
      const blink = await shouldBlink();
      if (!blink) return;

      enable();

      const maxMs = Number(window.MEATZE.HELP_ATTENTION_MAX_MS || 0);
      if (maxMs > 0){
        setTimeout(() => disable(), maxMs);
      }
    })();
  })();
})();
</script>

</body>
</html>


<script>
  // ===== CHECKLIST PANEL: OFF =====
  window.MEATZE = window.MEATZE || {};
  window.MEATZE.CHECKLIST_ENABLED = false; // <-- –≤–∫–ª—é—á–∏—à—å –ø–æ—Ç–æ–º true
</script>

<script>
(function(){
  if (window.MEATZE && window.MEATZE.CHECKLIST_ENABLED === false) return;
  if (window.__MZ_CHECKLIST__) return;
  window.__MZ_CHECKLIST__ = true;

  const POLL_MS = 12000;

  const box = document.getElementById('mz-checklist');
  if (!box) return;

  const btn = box.querySelector('[data-cl-toggle]');
  const ul  = box.querySelector('[data-cl-list]');

  btn?.addEventListener('click', () => box.classList.toggle('is-hidden'));

  function getCourseCode(){
    if (window.MEATZE?.COURSE_CODE) return String(window.MEATZE.COURSE_CODE || '').trim();
    const m = location.pathname.match(/\/curso\/([^\/]+)\//);
    return m ? m[1] : '';
  }

  function setItems(items){
    const todo = (items || []).filter(x => !x.done);

    if (!todo.length){
      box.style.display = 'none';
      ul.innerHTML = '';
      return;
    }

    box.style.display = 'block';
    ul.innerHTML = todo.map(x => {
      const cls = x.level === 'danger' ? 'danger' : (x.level === 'warn' ? 'warn' : '');
      const href = x.href || '#';
      return `
        <li class="${cls}">
          <span>${x.text}</span>
          <a class="go" href="${href}">Ir</a>
        </li>
      `;
    }).join('');
  }

  function computeStudentItems(st, courseCode){
    const totalFiles = Number(st.total_files || 0);
    const totalPhys  = Number(st.total_phys  || 0);

    const myD = Number(st.my_d || 0);
    const myR = Number(st.my_r || 0);

    const base = `/alumno/curso/${courseCode}/`;
    const items = [];

    if (totalPhys > 0 && myR < totalPhys){
      items.push({
        done:false,
        level: (totalPhys - myR) >= 2 ? 'danger' : 'warn',
        text: `Te falta confirmar <b>material f√≠sico</b>: ${myR}/${totalPhys}.`,
        href: `${base}?tab=materiales&focus=receipts`
      });
    }

    if (totalFiles > 0 && myD < totalFiles){
      items.push({
        done:false,
        level: (totalFiles - myD) >= 2 ? 'danger' : 'warn',
        text: `Te falta <b>descargar documentos</b>: ${myD}/${totalFiles}.`,
        href: `${base}?tab=materiales&focus=download`
      });
    }

    return items;
  }

  function computeTeacherItems(st, courseCode){
    const totalFiles = Number(st.total_files || 0);
    const totalPhys  = Number(st.total_phys  || 0);
    const studentsTotal = Number(st.students_total || 0);

    const rows = st.items || {};
    const ids = Object.keys(rows);
    const missing = Math.max(0, studentsTotal - ids.length);

    const presence = st.presence || {};
    let pendingAttendance = 0;
    for (const sid in presence){
      if ((presence[sid]?.status || '') === 'PENDING') pendingAttendance++;
    }

    let physPendingActive = 0;
    let filesPendingActive = 0;

    for (const sid of ids){
      const r = Number(rows[sid]?.r || 0);
      const d = Number(rows[sid]?.d || 0);

      if (totalPhys  > 0 && r < totalPhys)  physPendingActive++;
      if (totalFiles > 0 && d < totalFiles) filesPendingActive++;
    }

    const physPendingStudents  = (totalPhys  > 0) ? (physPendingActive  + missing) : 0;
    const filesPendingStudents = (totalFiles > 0) ? (filesPendingActive + missing) : 0;

    const base = `/alumno/curso/${courseCode}/`;
    const items = [];

    if (pendingAttendance > 0){
      items.push({
        done:false,
        level: pendingAttendance >= 3 ? 'danger' : 'warn',
        text: `Asistencia: <b>${pendingAttendance}</b> alumno(s) en <b>PENDIENTE</b> (‚úÖ/‚ùå).`,
        href: `${base}?tab=alumnos&focus=attendance`
      });
    }

	if (physPendingStudents > 0){
	  items.push({
		done:false,
		level: physPendingStudents >= 3 ? 'danger' : 'warn',
		text: `Material f√≠sico pendiente: <b>${physPendingStudents}</b> alumno(s) sin confirmar todo.`,
		href: `${base}?tab=alumnos&focus=attendance`  // —É—á–∏—Ç–µ–ª—å: —Ñ–∏–∑–∏–∫–∞ -> materiales
	  });
	}

	if (filesPendingStudents > 0){
	  items.push({
		done:false,
		level: filesPendingStudents >= 3 ? 'danger' : 'warn',
		text: `Descargas pendientes: <b>${filesPendingStudents}</b> alumno(s) no han descargado todo.`,
		href: `${base}?tab=alumnos&focus=attendance`  // ‚úÖ —É—á–∏—Ç–µ–ª—å: —Ñ–∞–π–ª—ã -> alumnos
	  });
	}


    return items;
  }

  async function tick(){
    const courseCode = getCourseCode();
    if (!courseCode) return;

    const url = `/alumno/curso/${encodeURIComponent(courseCode)}/alumnos/status`;
    const r = await fetch(url, { credentials:'include', cache:'no-store' });
    if (!r.ok) return;

    const st = await r.json();

    // student mode ‚Äî –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –±—ç–∫ —Ä–µ–∞–ª—å–Ω–æ –æ—Ç–¥–∞—ë—Ç role/my_d/my_r
    const isStudent = (st.role === 'student') || ('my_d' in st) || ('my_r' in st);

    const items = isStudent
      ? computeStudentItems(st, courseCode)
      : computeTeacherItems(st, courseCode);

    setItems(items);
  }

  tick().catch(()=>{});
  setInterval(() => tick().catch(()=>{}), POLL_MS);
})();
</script>
