{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>{% block title %}MEATZE{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  {% block extra_head %}{% endblock %}

  <!-- –¢–í–û–ô site.css –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ static/meatze/ -->
  <link rel="stylesheet" href="{% static 'meatze/site.css' %}">

  <!-- –ß–ê–¢: –±—ã–ª–æ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ -->
  <link rel="stylesheet" href="{% static 'meatze/chat_widget/chat-widget.css' %}">
</head>

<body>

<header id="mz-top">
  <div class="mz-top-inner">
    <a href="/" class="mz-brand">
      <span>MEATZE</span>
      <span class="mz-brand-badge">Campus</span>
    </a>

    <div class="mz-top-right">
      <div class="mz-top-cta">
        <span>Formaci√≥n subvencionada</span>
      </div>

      {% if request.user.is_authenticated %}
        <div id="mz-acc" class="mz-acc">
          <button id="mz-acc-user" type="button" aria-expanded="false">
            <div class="mz-acc-avatar">
              {% with name=request.user.first_name|default:request.user.username %}
                {{ name|first|upper }}
              {% endwith %}
            </div>
            <div class="mz-acc-name">
              {% if request.user.profile.display_name %}
                {{ request.user.profile.display_name }}
              {% elif request.user.get_full_name %}
                {{ request.user.get_full_name }}
              {% else %}
                {{ request.user.username }}
              {% endif %}
            </div>
            <div class="mz-acc-arrow">‚ñæ</div>
          </button>

		<div id="mz-acc-menu" class="mz-acc-menu" aria-hidden="true">
		  <button class="mz-acc-item" type="button" data-action="panel">
			<span class="icon">üè†</span><span>Ir al panel</span>
		  </button>

		  <a class="mz-acc-item" href="/acceder/?tab=profile" data-action="profile" style="text-align:left">
			<span class="icon">üë§</span><span>Datos personales</span>
		  </a>

		  <hr style="border:none;border-top:1px solid #e5e7eb;margin:4px 0">

		  <button class="mz-acc-item" type="button" data-action="logout">
			<span class="icon">‚èè</span><span>Cerrar sesi√≥n</span>
		  </button>
		</div>

        </div>
      {% else %}
        <!-- –í–ê–ñ–ù–û: —Ç–µ–ø–µ—Ä—å Acceder –≤–µ–¥—ë—Ç –Ω–∞ /acceder/ (–±–µ–∑ –º–æ–¥–∞–ª–∫–∏) -->
        <a id="mz-btn-login" class="mz-btn-top" href="/acceder/">
          <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
            <polyline points="10 17 15 12 10 7"/>
            <line x1="15" y1="12" x2="3" y2="12"/>
          </svg>
          <span>Acceder</span>
        </a>
      {% endif %}
    </div>
  </div>
</header>

<div class="mz-page">
  {% block content %}{% endblock %}
</div>

<!-- ====== JS CORE ====== -->
<script>
  window.MEATZE = window.MEATZE || {};
  window.MEATZE.V5 = (location.origin + '/').replace(/\/$/, '') + '/meatze/v5';
</script>

<script src="{% static 'meatze/core/api.js' %}"></script>

<!-- ====== Account menu + logout (–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ–≤–µ–¥–µ–Ω–∏–µ, –Ω–æ –±–µ–∑ auth/profile –º–æ–¥–∞–ª–æ–∫) ====== -->
<script>
(function(){
  const wrap = document.getElementById('mz-acc');
  const btn  = document.getElementById('mz-acc-user');
  const menu = document.getElementById('mz-acc-menu');
  if (!wrap || !btn || !menu) return;

  function setOpen(v){
    btn.setAttribute('aria-expanded', v ? 'true' : 'false');
    menu.classList.toggle('show', v);
    menu.setAttribute('aria-hidden', v ? 'false' : 'true');
  }

  // open/close menu
  btn.addEventListener('click', function(e){
    e.preventDefault();
    e.stopPropagation();
    const open = btn.getAttribute('aria-expanded') !== 'true';
    setOpen(open);
  });

  document.addEventListener('click', function(e){
    if (!wrap.contains(e.target)) setOpen(false);
  });

  // actions
menu.addEventListener('click', async function(e){
  const item = e.target.closest('.mz-acc-item');
  if (!item) return;

  const action = item.dataset.action || '';

  // –ï—Å–ª–∏ —ç—Ç–æ <a> –±–µ–∑ action ‚Äî –ù–ï –º–µ—à–∞–µ–º –±—Ä–∞—É–∑–µ—Ä—É –ø–µ—Ä–µ–π—Ç–∏
  if (!action) return;

  e.preventDefault();

  if (action === 'profile') {
    window.location.href = '/acceder/?tab=profile';
    return;
  }
  if (action === 'panel') {
    window.location.href = '/alumno/';
    return;
  }
  if (action === 'logout') {
    try {
      await fetch('/meatze/v5/auth/logout', { method:'POST', credentials:'include' });
    } catch(e) {}
    window.location.href = '/';
  }
});

})();
</script>

<!-- ====== –ß–ê–¢: –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ ====== -->
{% include "includes/chat_widget.html" %}
<script src="{% static 'meatze/chat_widget/chat-widget.js' %}"></script>


{% block extra_js %}{% endblock %}
</body>
</html>
