{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>{% block title %}MEATZE{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  {% block extra_head %}{% endblock %}

  <!-- –¢–í–û–ô site.css –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ static/meatze/ -->
  <link rel="stylesheet" href="{% static 'meatze/site.css' %}">

  <!-- –ß–ê–¢: –±—ã–ª–æ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ -->
  <link rel="stylesheet" href="{% static 'meatze/chat_widget/chat-widget.css' %}">
</head>

<body>

<header id="mz-top">
  <div class="mz-top-inner">
    <a href="/" class="mz-brand">
      <span>MEATZE</span>
      <span class="mz-brand-badge">Campus</span>
    </a>

    <div class="mz-top-right">
      <div class="mz-top-cta">
        <span>Formaci√≥n subvencionada</span>
      </div>

      {% if request.user.is_authenticated %}
        <div id="mz-acc" class="mz-acc">
          <button id="mz-acc-user" type="button" aria-expanded="false">
            <div class="mz-acc-avatar">
              {% with name=request.user.first_name|default:request.user.username %}
                {{ name|first|upper }}
              {% endwith %}
            </div>
            <div class="mz-acc-name">
              {% if request.user.profile.display_name %}
                {{ request.user.profile.display_name }}
              {% elif request.user.get_full_name %}
                {{ request.user.get_full_name }}
              {% else %}
                {{ request.user.username }}
              {% endif %}
            </div>
            <div class="mz-acc-arrow">‚ñæ</div>
          </button>

		<div id="mz-acc-menu" class="mz-acc-menu" aria-hidden="true">
		  <button class="mz-acc-item" type="button" data-action="panel">
			<span class="icon">üè†</span><span>Ir al panel</span>
		  </button>

		  <a class="mz-acc-item" href="/acceder/?tab=profile" data-action="profile" style="text-align:left">
			<span class="icon">üë§</span><span>Datos personales</span>
		  </a>

		  <hr style="border:none;border-top:1px solid #e5e7eb;margin:4px 0">

		  <button class="mz-acc-item" type="button" data-action="logout">
			<span class="icon">‚èè</span><span>Cerrar sesi√≥n</span>
		  </button>
		</div>

        </div>
      {% else %}
        <!-- –í–ê–ñ–ù–û: —Ç–µ–ø–µ—Ä—å Acceder –≤–µ–¥—ë—Ç –Ω–∞ /acceder/ (–±–µ–∑ –º–æ–¥–∞–ª–∫–∏) -->
        <a id="mz-btn-login" class="mz-btn-top" href="/acceder/">
          <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
            <polyline points="10 17 15 12 10 7"/>
            <line x1="15" y1="12" x2="3" y2="12"/>
          </svg>
          <span>Acceder</span>
        </a>
      {% endif %}
    </div>
  </div>
</header>

<div class="mz-page">
  {% block content %}{% endblock %}
</div>

<!-- ====== JS CORE ====== -->
<script>
  window.MEATZE = window.MEATZE || {};
  window.MEATZE.V5 = (location.origin + '/').replace(/\/$/, '') + '/meatze/v5';
</script>

<script src="{% static 'meatze/core/api.js' %}"></script>

<!-- ====== Account menu + logout (–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ–≤–µ–¥–µ–Ω–∏–µ, –Ω–æ –±–µ–∑ auth/profile –º–æ–¥–∞–ª–æ–∫) ====== -->
<script>
(function(){
  const wrap = document.getElementById('mz-acc');
  const btn  = document.getElementById('mz-acc-user');
  const menu = document.getElementById('mz-acc-menu');
  if (!wrap || !btn || !menu) return;

  function setOpen(v){
    btn.setAttribute('aria-expanded', v ? 'true' : 'false');
    menu.classList.toggle('show', v);
    menu.setAttribute('aria-hidden', v ? 'false' : 'true');
  }

  // open/close menu
  btn.addEventListener('click', function(e){
    e.preventDefault();
    e.stopPropagation();
    const open = btn.getAttribute('aria-expanded') !== 'true';
    setOpen(open);
  });

  document.addEventListener('click', function(e){
    if (!wrap.contains(e.target)) setOpen(false);
  });

  // actions
menu.addEventListener('click', async function(e){
  const item = e.target.closest('.mz-acc-item');
  if (!item) return;

  const action = item.dataset.action || '';

  // –ï—Å–ª–∏ —ç—Ç–æ <a> –±–µ–∑ action ‚Äî –ù–ï –º–µ—à–∞–µ–º –±—Ä–∞—É–∑–µ—Ä—É –ø–µ—Ä–µ–π—Ç–∏
  if (!action) return;

  e.preventDefault();

  if (action === 'profile') {
    window.location.href = '/acceder/?tab=profile';
    return;
  }
  if (action === 'panel') {
    window.location.href = '/alumno/';
    return;
  }
  if (action === 'logout') {
    try {
      await fetch('/meatze/v5/auth/logout', { method:'POST', credentials:'include' });
    } catch(e) {}
    window.location.href = '/';
  }
});

})();
</script>

<!-- ====== –ß–ê–¢: –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ ====== -->
{% include "includes/chat_widget.html" %}
<script src="{% static 'meatze/chat_widget/chat-widget.js' %}"></script>
<style>
  #mz-checklist{
    position: fixed;
    top: 84px;          /* –æ—Ç—Å—Ç—É–ø –æ—Ç –≤–µ—Ä—Ö–Ω–µ–≥–æ –±–∞—Ä–∞ */
    right: 16px;        /* ‚úÖ —Å–ø—Ä–∞–≤–∞ */
    left: auto;
    z-index: 99999;

    width: 320px;
    max-width: 92vw;

    border-radius: 16px;
    border: 1px solid rgba(148,163,184,0.45);
    background: #0b1220;
    color: #e5e7eb;
    box-shadow: 0 18px 45px rgba(0,0,0,.55);
    overflow: hidden;
  }

  #mz-checklist .hd{
    padding: 10px 12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    border-bottom: 1px solid rgba(148,163,184,0.25);
  }
  #mz-checklist .ttl{
    font-weight: 900;
    letter-spacing:.04em;
    font-size: .86rem;
    text-transform: uppercase;
    opacity: .95;
  }
  #mz-checklist .btn{
    border: 1px solid rgba(148,163,184,0.35);
    background: rgba(15,23,42,0.9);
    color:#e5e7eb;
    border-radius: 999px;
    padding: 4px 10px;
    font-weight: 800;
    cursor:pointer;
  }

  /* ‚úÖ –≤—ã—Å–æ—Ç–∞ ‚Äú–ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É‚Äù, –Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª –≤—Å—ë */
  #mz-checklist .body{
    padding: 10px 12px 12px;
    max-height: 180px;
    overflow: auto;
  }
  #mz-checklist.is-hidden .body{ display:none; }

  #mz-checklist ul{ margin:0; padding-left: 18px; }
  #mz-checklist li{ margin: 6px 0; font-size: .86rem; line-height: 1.25; }

  #mz-checklist .warn{ color:#fde68a; }
  #mz-checklist .danger{ color:#fecaca; }
    #mz-checklist li{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:10px;
  }
  #mz-checklist .go{
    flex: 0 0 auto;
    border: 1px solid rgba(148,163,184,0.35);
    background: rgba(15,23,42,0.9);
    color:#e5e7eb;
    border-radius: 999px;
    padding: 3px 10px;
    font-weight: 800;
    font-size: 12px;
    text-decoration:none;
    white-space:nowrap;
  }
</style>

<div id="mz-checklist" style="display:none">
  <div class="hd">
    <div class="ttl">Checklist</div>
    <button class="btn" type="button" data-cl-toggle>‚Äî</button>
  </div>
  <div class="body">
    <ul data-cl-list></ul>
  </div>
</div>

{% block extra_js %}{% endblock %}
</body>
</html>
<script>
(function(){
  if (window.__MZ_CHECKLIST__) return;
  window.__MZ_CHECKLIST__ = true;

  const POLL_MS = 12000;

  const box = document.getElementById('mz-checklist');
  if (!box) return;

  const btn = box.querySelector('[data-cl-toggle]');
  const ul  = box.querySelector('[data-cl-list]');

  btn?.addEventListener('click', () => box.classList.toggle('is-hidden'));

  function getCourseCode(){
    if (window.MEATZE?.COURSE_CODE) return String(window.MEATZE.COURSE_CODE || '').trim();
    const m = location.pathname.match(/\/curso\/([^\/]+)\//);
    return m ? m[1] : '';
  }

  function setItems(items){
    const todo = (items || []).filter(x => !x.done);

    if (!todo.length){
      box.style.display = 'none';
      ul.innerHTML = '';
      return;
    }

    box.style.display = 'block';
    ul.innerHTML = todo.map(x => {
      const cls = x.level === 'danger' ? 'danger' : (x.level === 'warn' ? 'warn' : '');
      const href = x.href || '#';
      return `
        <li class="${cls}">
          <span>${x.text}</span>
          <a class="go" href="${href}">Ir</a>
        </li>
      `;
    }).join('');
  }

  function computeStudentItems(st, courseCode){
    const totalFiles = Number(st.total_files || 0);
    const totalPhys  = Number(st.total_phys  || 0);

    const myD = Number(st.my_d || 0);
    const myR = Number(st.my_r || 0);

    const base = `/alumno/curso/${courseCode}/`;
    const items = [];

    if (totalPhys > 0 && myR < totalPhys){
      items.push({
        done:false,
        level: (totalPhys - myR) >= 2 ? 'danger' : 'warn',
        text: `Te falta confirmar <b>material f√≠sico</b>: ${myR}/${totalPhys}.`,
        href: `${base}?tab=materiales&focus=receipts`
      });
    }

    if (totalFiles > 0 && myD < totalFiles){
      items.push({
        done:false,
        level: (totalFiles - myD) >= 2 ? 'danger' : 'warn',
        text: `Te falta <b>descargar documentos</b>: ${myD}/${totalFiles}.`,
        href: `${base}?tab=materiales&focus=download`
      });
    }

    return items;
  }

  function computeTeacherItems(st, courseCode){
    const totalFiles = Number(st.total_files || 0);
    const totalPhys  = Number(st.total_phys  || 0);
    const studentsTotal = Number(st.students_total || 0);

    const rows = st.items || {};
    const ids = Object.keys(rows);
    const missing = Math.max(0, studentsTotal - ids.length);

    const presence = st.presence || {};
    let pendingAttendance = 0;
    for (const sid in presence){
      if ((presence[sid]?.status || '') === 'PENDING') pendingAttendance++;
    }

    let physPendingActive = 0;
    let filesPendingActive = 0;

    for (const sid of ids){
      const r = Number(rows[sid]?.r || 0);
      const d = Number(rows[sid]?.d || 0);

      if (totalPhys  > 0 && r < totalPhys)  physPendingActive++;
      if (totalFiles > 0 && d < totalFiles) filesPendingActive++;
    }

    const physPendingStudents  = (totalPhys  > 0) ? (physPendingActive  + missing) : 0;
    const filesPendingStudents = (totalFiles > 0) ? (filesPendingActive + missing) : 0;

    const base = `/alumno/curso/${courseCode}/`;
    const items = [];

    if (pendingAttendance > 0){
      items.push({
        done:false,
        level: pendingAttendance >= 3 ? 'danger' : 'warn',
        text: `Asistencia: <b>${pendingAttendance}</b> alumno(s) en <b>PENDIENTE</b> (‚úÖ/‚ùå).`,
        href: `${base}?tab=alumnos&focus=attendance`
      });
    }

	if (physPendingStudents > 0){
	  items.push({
		done:false,
		level: physPendingStudents >= 3 ? 'danger' : 'warn',
		text: `Material f√≠sico pendiente: <b>${physPendingStudents}</b> alumno(s) sin confirmar todo.`,
		href: `${base}?tab=alumnos&focus=attendance`  // —É—á–∏—Ç–µ–ª—å: —Ñ–∏–∑–∏–∫–∞ -> materiales
	  });
	}

	if (filesPendingStudents > 0){
	  items.push({
		done:false,
		level: filesPendingStudents >= 3 ? 'danger' : 'warn',
		text: `Descargas pendientes: <b>${filesPendingStudents}</b> alumno(s) no han descargado todo.`,
		href: `${base}?tab=alumnos&focus=attendance`  // ‚úÖ —É—á–∏—Ç–µ–ª—å: —Ñ–∞–π–ª—ã -> alumnos
	  });
	}


    return items;
  }

  async function tick(){
    const courseCode = getCourseCode();
    if (!courseCode) return;

    const url = `/alumno/curso/${encodeURIComponent(courseCode)}/alumnos/status`;
    const r = await fetch(url, { credentials:'include', cache:'no-store' });
    if (!r.ok) return;

    const st = await r.json();

    // student mode ‚Äî –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –±—ç–∫ —Ä–µ–∞–ª—å–Ω–æ –æ—Ç–¥–∞—ë—Ç role/my_d/my_r
    const isStudent = (st.role === 'student') || ('my_d' in st) || ('my_r' in st);

    const items = isStudent
      ? computeStudentItems(st, courseCode)
      : computeTeacherItems(st, courseCode);

    setItems(items);
  }

  tick().catch(()=>{});
  setInterval(() => tick().catch(()=>{}), POLL_MS);
})();
</script>
